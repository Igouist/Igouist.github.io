<!doctype html>
<html lang="zh-Hant-TW">
<head>

    <meta charset="utf-8">
    <meta name="generator" content="Hugo 0.74.3" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <title>Asp.net MVC: 連線資料庫、簡單實作 CRUD | 伊果的沒人看筆記本</title>
    <meta property="og:title" content="Asp.net MVC: 連線資料庫、簡單實作 CRUD - 伊果的沒人看筆記本">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content="2019-12-09T00:09:09&#43;08:00">
        
        
    <meta property="article:modified_time" content="2019-12-09T00:09:09&#43;08:00">
        
    <meta name="Keywords" content="[Dotnet .net Database Entity Framework Asp.net MVC]">
    <meta name="description" content="在 Asp.net MVC 框架，以不使用 EF 連線產生 Edmx 的方式實作一個 MVC 架構，具資料庫基本操作功能（CRUD=新增修改刪除查詢）的網站，其中包含連線至資料庫的 model、對其進行調用的 controller 以及顯示的 view">
        <meta name="author" content="Igouist">
        
    <meta property="og:url" content="https://igouist.github.io/post/2019/12/aspnet-connect-db/">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

    <link rel="stylesheet" href="/css/normalize.css">
    
        <link rel="stylesheet" href="/css/prism.css">
    
    <link rel="stylesheet" href="/css/style.css">
    <script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>

    


    
    
</head>

<body>
<header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://igouist.github.io/">
                        伊果的沒人看筆記本
                    </a>
                
                <p class="description">菜雞寫筆記，踩坑全紀錄</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://igouist.github.io/">Home</a>
                    
                    <a  href="https://igouist.github.io/categories/reading/" title="Reading">Reading</a>
                    
                    <a  href="https://igouist.github.io/categories/python/" title="Python">Python</a>
                    
                    <a  href="https://igouist.github.io/categories/csharp/" title="CSharp">CSharp</a>
                    
                    <a  href="https://igouist.github.io/archives/" title="Archives">Archives</a>
                    
                    <a  href="https://igouist.github.io/about/" title="About">About</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>


<div id="body">
    <div class="container">
        <div class="col-group">

            <div class="col-8" id="main">
                <div class="res-cons">
                    <article class="post">
                        <header>
                            <h1 class="post-title">Asp.net MVC: 連線資料庫、簡單實作 CRUD</h1>
                        </header>
                        <date class="post-meta meta-date">
                            2019-12-9,
                        </date>
                        
                        <div class="post-meta">
                            
                                <span class="meta-category"><a href="https://igouist.github.io/categories/csharp">CSharp</a></span>
                            
                        </div>
                        
                        
                        <div class="post-meta">(
                            <span id="busuanzi_container_page_pv">
                                <span id="busuanzi_value_page_pv">?</span>
                                <span>&nbsp;read</span>
                            </span>)
                        </div>
                        
                        <div class="post-content">
                            <p>在教學時直接使用 EF 對資料庫跑繫結的方式產生各頁面，但得到了「點一點東西就跑出來了搞不懂呀」的回饋，心想有道理。因此從頭開始實作一遍，並記錄下來。<s>（雖然做完還是覺得，直接用 EF 跑的話果然比較安全方便啊）</s></p>
<blockquote>
<p>目標：<strong>實作一個 MVC 架構，具資料庫基本操作功能的網站</strong>，其中包含連線至資料庫的 model、對其進行調用的 controller 以及顯示的 view。</p>
</blockquote>
<p>註：本文預設已在本地電腦上安裝了 <a href="https://www.microsoft.com/zh-tw/sql-server/sql-server-editions-express">SQL Server</a>，並且建立了測試用的資料庫 Test 及表 card，詳情會在文章內述。另外，由於在寫這邊的時候是為了練習手動從編碼開始嘗試連線，故將不使用 <a href="https://docs.microsoft.com/zh-tw/aspnet/mvc/overview/getting-started/getting-started-with-ef-using-mvc/creating-an-entity-framework-data-model-for-an-asp-net-mvc-application">EF 連線產生 Edmx</a> 的方式，而是直接手工編寫程式碼進行操作。</p>
<p>另外，關於直接從資料表自動產生可操作的頁面，亦即使用 Entity Framework 做資料繫結的方式，請見 <a href="/post/2019/12/aspnet-connect-db-ef/">Asp.net MVC 筆記：Entity Framework 連線資料庫</a></p>
<p>首先我們從建立專案開始操作。</p>
<p><img src="https://i.imgur.com/eRyGBTb.png" alt=""></p>
<p>選擇 .NET 的框架，並且在下面替專案取個名字。</p>
<p><img src="https://i.imgur.com/fdIYiCe.png" alt=""></p>
<p>確認選擇的框架是 MVC。</p>
<p><img src="https://i.imgur.com/otUKDR0.png" alt=""></p>
<h3 id="建立連線資料庫用的-model">建立連線資料庫用的 Model</h3>
<p>首先先在方案總管的 Models 資料夾裡新增一個類別。</p>
<p><img src="https://i.imgur.com/3L0gFuu.png" alt=""></p>
<p>由於我們是從平地起家，手工連線，因此我們這邊選擇空白類別就可以了，取個淺顯易懂的名字並按下新增。</p>
<p><img src="https://i.imgur.com/JCnwaMU.png" alt=""></p>
<p>新增之後應該能看見我們的類別。</p>
<p><img src="https://i.imgur.com/hQn75wu.png" alt=""></p>
<p>在連線到資料庫的部分，最首先的就是<strong>連線字串</strong>。連線字串就像是地址加上鑰匙，可以想成你請人幫你到倉庫拿東西，必須先告訴他倉庫在哪再給他鑰匙進去拿一樣，程式必須藉由連線字串才能得知<strong>資料庫的位置和連線資料</strong>，而不同的資料庫軟體的連線字串格式也有可能不同，例如說 MySQL 的連線字串格式就可以參考<a href="https://www.itread01.com/p/1192499.html">這篇</a>。在本筆記之中，不同資料庫類型在實作上最大的差異大概就是連線字串了吧。</p>
<p>而在連線至 MSSQL 的部分，我個人習慣用 Visual studio 內建的功能做產生再按照需求作修改。首先讓我們打開畫面左上方的伺服器總管，並在資料連接上加入一個新的連接。</p>
<p><img src="https://i.imgur.com/VC0CfPE.png" alt=""></p>
<p><img src="https://i.imgur.com/G33iM6J.png" alt=""></p>
<p>接著就可以看到加入連接的頁面，我們從上往下進行解說：</p>
<p><strong>資料來源</strong>：用來更改資料庫來源的類型，例如 Access 或是其他類型資料庫的時候就可以更改這一項。我們這邊使用 SQL Server 進行示範。</p>
<p><strong>伺服器名稱</strong>：SQL Server 的名稱，通常會在 SQL Server 安裝的時候做設定，預設是和電腦一樣。當遠端連線的時候，這邊可以改成輸入 IP。</p>
<p><strong>驗證</strong>：比較常用的是 Windows 驗證和 SQL Server 驗證。<strong>Windows 驗證</strong>即是當資料庫位於本機時，直接使用 Windows 登入者的資料驗證進資料庫。<strong>SQL Server 驗證</strong>則是使用 SQL Server 中設定的帳號密碼來登入，遠端連線至資料庫取資料的時候就會用帳密連線。</p>
<p>至於這兩項的選擇需要看使用時的需求以及資料庫本身的設定進行選擇。本篇是直接在 SQL Server 所在的本機上進行架站，同時也沒有特別設定權限，因此直接使用 Windoes 驗證登入就可以了。</p>
<p><strong>資料庫名稱</strong>：從 Server 裡面選擇要使用的 Database。在此處選擇了示範用的 Test 資料庫。</p>
<p>以上部分設定完之後，點選左下角的測試連接。若是測試連接沒有問題後，在進階的部分就可以看見已經產生好連線字串了。同時在這個頁面按下確定的話，將會在伺服器總管中連線至資料庫，也能從資料連接的部分對資料庫進行操作。</p>
<p><img src="https://i.imgur.com/eNiiXtj.png" alt=""></p>
<p>↑ 可以從進階的部分看見連線字串。可以稍微看得出來連線字串的格式，其中 Data Source 放伺服器主機、Initial Catalog 放資料庫名稱、Integrated Security 放集成驗證（即 Windows 驗證），此外還有可能會有 UserID 放帳號、Password 放密碼等等。</p>
<p><img src="https://i.imgur.com/ZssVFCq.png" alt=""></p>
<p>↑ 如果選擇確定的話，就會建立連接。可以直接在這邊右鍵選擇各種功能以操作資料庫。</p>
<p>現在我們已經有了連線字串，先在我們的類別中將其宣告為一個私有且唯獨的字串常數。</p>
<p><img src="https://i.imgur.com/bVnef6n.png" alt=""></p>
<blockquote>
<p>註：在實務上的部份，連線字串通常會放置在網頁設定檔 Web.config 裡，因為網頁設定檔在使用者端是看不見的，所以這樣的做法比較安全，再利用 ConfigurationManager 的函式取得連線字串以使用。關於詳細的操作方式請參考<a href="https://dotblogs.com.tw/sky5012357/2013/03/19/98161">這篇</a>或搜尋「連線字串 Web.config」。本篇為了教學及操作上的方便，才直接放置於程式碼內。</p>
</blockquote>
<p>解決連線字串的問題，接著我們來做一個 model 放我們的資料。可以從上面伺服器總管的圖看見我的資料表 card 有 id、 char_name、 card_name、card_level 四個欄位。</p>
<p>因此我們新建一個 card 類別如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-CSharp" data-lang="CSharp"><span style="color:#66d9ef">namespace</span> DBconnTest.Models
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Card</span>
    {
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> ID { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> Char_name  { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> Card_name  { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> Card_level { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    }
}
</code></pre></div><p>新建完成之後就回到我們的 資料庫連線類別 開始工作。</p>
<h2 id="取得所有資料">取得所有資料</h2>
<p>第一個目標是能夠取得 Card 資料表的所有資料，因此我們先將方法的部分建立出來，也就是一個會回傳 Card 的 List 的方法。</p>
<p><img src="https://i.imgur.com/utEyL3C.png" alt=""></p>
<p>我們將會使用 SqlConnection 這個資料庫連線用的工具來操作資料庫，因此需要先在上面 <code>using System.Data.SqlClient</code>。</p>
<p>接著我們想要 GetCards 方法做的事有：</p>
<ol>
<li>利用連線字串連線至資料庫</li>
<li>下 SQL 指令拿到資料</li>
<li>將拿到的資料做成 Card 物件</li>
<li>將 Card 們組成一個 List</li>
<li>回傳 List 給前端使用。</li>
</ol>
<p>程式碼如下，其後逐步說明。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-CSharp" data-lang="CSharp"><span style="color:#66d9ef">public</span> List&lt;Card&gt; GetCards() {
    List&lt;Card&gt; cards = <span style="color:#66d9ef">new</span> List&lt;Card&gt;();
    SqlConnection sqlConnection = <span style="color:#66d9ef">new</span> SqlConnection(ConnStr);
    SqlCommand sqlCommand = <span style="color:#66d9ef">new</span> SqlCommand(<span style="color:#e6db74">&#34;SELECT * FROM card&#34;</span>);
    sqlCommand.Connection = sqlConnection;
    sqlConnection.Open();

    SqlDataReader reader = sqlCommand.ExecuteReader();
    <span style="color:#66d9ef">if</span> (reader.HasRows) {
        <span style="color:#66d9ef">while</span> (reader.Read()) {
            Card card = <span style="color:#66d9ef">new</span> Card {
                ID = reader.GetInt32(reader.GetOrdinal(<span style="color:#e6db74">&#34;id&#34;</span>)),
                Char_name  = reader.GetString(reader.GetOrdinal(<span style="color:#e6db74">&#34;char_name&#34;</span>)),
                Card_name  = reader.GetString(reader.GetOrdinal(<span style="color:#e6db74">&#34;card_name&#34;</span>)),
                Card_level = reader.GetString(reader.GetOrdinal(<span style="color:#e6db74">&#34;card_level&#34;</span>)),
            };
            cards.Add(card);
        }
    }
    <span style="color:#66d9ef">else</span> {
        Console.WriteLine(<span style="color:#e6db74">&#34;資料庫為空！&#34;</span>);
    }
    sqlConnection.Close();
    <span style="color:#66d9ef">return</span> cards;
}
</code></pre></div><p><img src="https://i.imgur.com/KoB6QZU.png" alt=""></p>
<p>首先，我們宣告了一個 Card 的 List 叫做 Cards 用來保存我們等等取得的資料。</p>
<p>接著我們利用連線字串 ConnStr 來建立了一個 <strong>SQL 連線物件 SqlConnection</strong>。並宣告了一個 <strong>SQL 命令物件 SqlCommand</strong> 來放置我們要執行的 SQL 指令。</p>
<p>這邊使用的是「由 card 資料表選取全部資料(*)」的指令。不論使用的是何種語言，後端連線到資料庫最重要的就是傳送指令至資料庫執行。關於 SQL 指令的使用方式，可以參照 <a href="https://www.1keydata.com/tw/sql/sql.html">1keyData 的 SQL 語法</a> 或是 <a href="http://www.w3school.com.cn/sql/index.asp">w3school</a>。</p>
<p>此外要注意，實務上如果真的需要自己寫連線，下 SQL 的命令和參數時應該用 SqlParameter 的方式讓系統檢查後放入，不應該偷懶直接將字串和參數用 + 接起來就傳送，否則很容易遭遇 SQL injection 的攻擊。</p>
<p>我們將指令的目標連線指向我們的連線 sqlConnection，完成後<strong>開啟（open）連線</strong>連至資料庫。</p>
<p>現在已經和資料庫連線了，但還沒執行我們的指令，宣告一個 <strong>sql 資料讀取物件 SqlDataReader</strong> 來抓取執行指令（sqlCommand.ExecuteReader）時回傳的資料。</p>
<p>要注意，當 <strong>SqlDataReader 在讀取資料庫時，是一行一行地讀取</strong>。因此，我們先判斷是否有讀到資料（HasRows = 有資料行嗎？），若有則逐行進行處理。在 Read() 的時候，運作的方式和我們人類 Read（讀） 書本是一樣的，會讀取一行的資料，因此我們利用 <strong>while</strong> 迴圈一直閱讀直到不能讀為止。</p>
<p>當 reader 在讀取資料行時，我們先宣告一個 Card 來放置我們要的資料，這邊為了方便直接用 new 物件 { 資料 } 的方式宣告，跟單純宣告的和定義好的建構式看起來有些不同，但結果會建出一個 card 是一樣的，端看需求選用。</p>
<p>首先是取得資料的部份，利用 reader.GetOrdinal 去取得該欄位的索引值＼位置。例如說 card_name 是位於資料列的第三欄，那我們就會取得它的索引值為 2 （從 0 開始）。再利用 Get(類型，這邊的類型要配合資料庫內欄位的設定，例如 int32 配 int，string 配 nvarchar 之類) 的指令去取出對應索引值的資料。</p>
<p>雖然本篇示範的資料庫較小，能夠一目了然欄位所在的位置，下 reader.GetString(2) 也是能夠取得資料的。但其缺點也很明顯，若是資料庫欄位有所變更，抑或是資料庫欄位數量很多的時候，錯誤的風險就會相當大，因此用<strong>欄位名稱尋找索引值，再利用索引值取得資料內容的方式相對比較保險</strong>。</p>
<p>另外，在處理回傳的資料時，會根據習慣和需求而有不同的做法，大多數的作法並不會一樣。例如說也有將回傳資料封裝成 Json 就丟給前端讓前端自己拆包自己頭痛的狀況存在，這部份在看其他人的連線教學或相關文章後就會比較了解。若是需要查詢相關的命令，例如說只執行命令時不回傳值，或單純只傳一個值，可以查詢微軟文件的 <a href="https://docs.microsoft.com/zh-tw/dotnet/api/system.data.sqlclient.sqlcommand?view=netframework-4.7.2#%E5%82%99%E8%A8%BB">SqlCommand 頁面</a> 和 <a href="https://docs.microsoft.com/zh-tw/dotnet/api/system.data.sqlclient.sqlconnection?view=netframework-4.7.2">SqlConnection 頁面</a>。</p>
<p>將資料做成一個 card 後，我們將其放入我們的 List 也就是 cards。當全部的資料都讀完之後，絕對不能忘記關閉連線。最後回傳我們的 cards，到這邊 GetCards 就告一段落了。</p>
<p>為了測試，我們先到 HomeControlls 的 Index 做一點小修改。using 我們的 model 並且試試看用 GetCards 來取得資料。</p>
<p><img src="https://i.imgur.com/BzylqF3.png" alt=""></p>
<p>接著把 Home/Index.cshtml 也進行修改。將原本的全部砍掉，為了示範方便，直接 using models 並且用 Viewbag 拿出來看。（註：這邊熟練之後若想了解實務上較建議使用的傳值方式，可以搜尋 &ldquo;ViewModel&rdquo;）</p>
<p><img src="https://i.imgur.com/k7ZIPF6.png" alt=""></p>
<p>可以看見資料有正常地取得了</p>
<p><img src="https://i.imgur.com/gGzrAxl.png" alt=""></p>
<p>接著就可以開始處理前端顯示的部份，例如使用 <a href="https://bootstrap.hexschool.com/docs/4.0/content/tables/">Bootstrap 的表格</a> 進行排版，或是其他 css 啦模板啦，都是沒問題的囉！</p>
<h2 id="新增資料">新增資料</h2>
<p>既然能夠取得資料了，接下來就來做一些基本的操作吧。首先從新增資料開始。</p>
<p>為了後續操作方便和美觀，先從我們顯示資料的 Index 開始做處理。先將它改成bootstarp 的表格樣式，並且留一格之後放操作項。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#f92672">table</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;table&#34;</span>&gt;
    &lt;<span style="color:#f92672">thead</span>&gt;
        &lt;<span style="color:#f92672">tr</span>&gt;
            &lt;<span style="color:#f92672">th</span>&gt;資料庫編號&lt;/<span style="color:#f92672">th</span>&gt;
            &lt;<span style="color:#f92672">th</span>&gt;角色名稱&lt;/<span style="color:#f92672">th</span>&gt;
            &lt;<span style="color:#f92672">th</span>&gt;卡片名稱&lt;/<span style="color:#f92672">th</span>&gt;
            &lt;<span style="color:#f92672">th</span>&gt;卡片等級&lt;/<span style="color:#f92672">th</span>&gt;
            &lt;<span style="color:#f92672">th</span>&gt;&lt;/<span style="color:#f92672">th</span>&gt;
        &lt;/<span style="color:#f92672">tr</span>&gt;
    &lt;/<span style="color:#f92672">thead</span>&gt;
    &lt;<span style="color:#f92672">tbody</span>&gt;

        @foreach (Card card in cards) {
            &lt;<span style="color:#f92672">tr</span>&gt;
                &lt;<span style="color:#f92672">th</span>&gt;@card.ID&lt;/<span style="color:#f92672">th</span>&gt;
                &lt;<span style="color:#f92672">th</span>&gt;@card.Char_name&lt;/<span style="color:#f92672">th</span>&gt;
                &lt;<span style="color:#f92672">th</span>&gt;@card.Card_name&lt;/<span style="color:#f92672">th</span>&gt;
                &lt;<span style="color:#f92672">th</span>&gt;@card.Card_level&lt;/<span style="color:#f92672">th</span>&gt;
                &lt;<span style="color:#f92672">th</span>&gt;&lt;<span style="color:#f92672">th</span>&gt;
            &lt;/<span style="color:#f92672">tr</span>&gt;
         }

    &lt;/<span style="color:#f92672">tbody</span>&gt;
&lt;/<span style="color:#f92672">table</span>&gt;
</code></pre></div><p><img src="https://i.imgur.com/6z2UNud.png" alt=""></p>
<p>比剛剛好多了：</p>
<p><img src="https://i.imgur.com/EO3xE9b.png" alt=""></p>
<p>既然要新增資料，那一定要有個頁面能夠輸入新增的資料內容。因此我們回到 HomeController 來準備新增一個頁面。首先先把預設的 About 和 Contact 刪掉，也將 Views 裡的這兩頁給刪掉，我們不會用到它們了。</p>
<p>接著就來建立 CreateCard ：</p>
<p><img src="https://i.imgur.com/T7lxFzj.png" alt=""></p>
<p>之後也必須建立 View 才可以。在 CreatrCard 上點右鍵，選擇新增檢視。</p>
<p><img src="https://i.imgur.com/fS17EpU.png" alt=""></p>
<p><img src="https://i.imgur.com/Nl7yqjA.png" alt=""></p>
<p>在這一步直接按下 Add 就會新增一個空白的 View 可以使用了。如果想讓系統自己幫你產生，Template 指得就是樣板，裡面已經包含新增刪除等操作會使用到的介面，選擇後再於 Model class 選取要操作的 Model 物件的話，就會自動產生好一個功能頁面讓你修改。不過開頭已經說過這次要純手工，因此我們就直接按下 Add 吧。</p>
<p>要把資料從 View 丟到 Controller 的方法很多，例如 form 表單或是 ajax 傳值都是可行的。我們這邊用 form 表單做回傳，另外使用 bootstarp 簡單排個版，程式碼如下</p>
<p><img src="https://i.imgur.com/IGumNlE.png" alt=""></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#f92672">h2</span>&gt;新增 Card&lt;/<span style="color:#f92672">h2</span>&gt;
&lt;<span style="color:#f92672">br</span> /&gt;

&lt;<span style="color:#f92672">form</span> <span style="color:#a6e22e">method</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;post&#34;</span> <span style="color:#a6e22e">action</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/Home/CreateCard&#34;</span>&gt;
    &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;form-group row&#34;</span>&gt;
        &lt;<span style="color:#f92672">label</span> <span style="color:#a6e22e">for</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;inputCharName&#34;</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;col-sm-2&#34;</span>&gt;角色名稱&lt;/<span style="color:#f92672">label</span>&gt;
        &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;col-sm-10&#34;</span>&gt;
            &lt;<span style="color:#f92672">input</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;text&#34;</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;inputCharName&#34;</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Char_name&#34;</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;form-control&#34;</span> /&gt;
        &lt;/<span style="color:#f92672">div</span>&gt;
    &lt;/<span style="color:#f92672">div</span>&gt;
    &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;form-group row&#34;</span>&gt;
        &lt;<span style="color:#f92672">label</span> <span style="color:#a6e22e">for</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;inputCardName&#34;</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;col-sm-2&#34;</span>&gt;卡片名稱&lt;/<span style="color:#f92672">label</span>&gt;
        &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;col-sm-10&#34;</span>&gt;
            &lt;<span style="color:#f92672">input</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;text&#34;</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;inputCardName&#34;</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Card_name&#34;</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;form-control&#34;</span> /&gt;
        &lt;/<span style="color:#f92672">div</span>&gt;
    &lt;/<span style="color:#f92672">div</span>&gt;
    &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;form-group row&#34;</span>&gt;
        &lt;<span style="color:#f92672">label</span> <span style="color:#a6e22e">for</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;inputCardLevel&#34;</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;col-sm-2&#34;</span>&gt;卡片等級&lt;/<span style="color:#f92672">label</span>&gt;
        &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;col-sm-10&#34;</span>&gt;
            &lt;<span style="color:#f92672">input</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;number&#34;</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;inputCardLevel&#34;</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Card_level&#34;</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;form-control&#34;</span> /&gt;
        &lt;/<span style="color:#f92672">div</span>&gt;
    &lt;/<span style="color:#f92672">div</span>&gt;
    &lt;<span style="color:#f92672">input</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;btn btn-default&#34;</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;submit&#34;</span> <span style="color:#a6e22e">value</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;新增&#34;</span>/&gt;
&lt;/<span style="color:#f92672">form</span>&gt;
</code></pre></div><p>可以看見我們首先做了一個 form 表單，並<strong>指定這張表單將用 post 的方式將資料傳送到 /Home/CreateCard 這個路徑</strong>。屆時我們送出的時候，就會送到 HomeController 中有規定收取 post 的 CreateCard() 方法做處理。</p>
<p>在<strong>表單中最重要的就是各個 input 的 name 屬性</strong>，當資料傳送的時候，會使用 name 做為資料的欄位名稱。因此這邊的 name 一定要能和我們的 card 物件的資料對應上，才能讓它自動轉換。</p>
<p>接著用 <a href="https://v3.bootcss.com/css/#forms">bootstrap 的格式</a>做了三組輸入框，以及一個提交按鈕。運行後頁面正常就可以進行下一步了。</p>
<p>首先我們再度回到 HomeController，做一個 POST 才能進來的 CreateCard 方法來接取表單，並且讓它將傳入的表單資料做成我們建立的 Card 物件。</p>
<p><img src="https://i.imgur.com/yi7ZMvq.png" alt=""></p>
<p>這個方法中應該要能將 card 的資料傳入資料庫，但我們還沒有實做傳入資料庫的方法，因此我們要回到當初建立的<strong>資料庫連線用的 model</strong>（本範例中為 DBconn）去實作一個新增用的函式。</p>
<p><img src="https://i.imgur.com/mrVWpCe.png" alt=""></p>
<p>新增的函式跟前面做過的查詢相差無幾，最大的差別在於新增的 SQL 語法是 <a href="https://www.1keydata.com/tw/sql/sqlinsert.html">INSERT INTO</a> 。必須再提醒一次，最注意的一點是，<u><strong>在@字串中放置的參數，需要用 SqlParameter 的方式讓系統檢查後放入，不應該偷懶直接將字串和參數用 + 接起來就傳送，否則很容易遭遇 <a href="https://ithelp.ithome.com.tw/articles/10189201">SQL injection</a> 的攻擊</strong></u>，被亂下 SQL 指令。</p>
<p>處理好 model 中控制資料庫的部分之後，我們再回到 Controller 把這段添加上去。</p>
<p><img src="https://i.imgur.com/adCSxgq.png" alt=""></p>
<p>可以看到當我們收到表單後，就會嘗試呼叫資料庫物件調用新增的函式做新增，如果新增時出了錯就會把錯誤訊息列印在輸出欄，最後回到首頁。</p>
<p>最後只要在首頁把新增的按鈕放上去就大功告成囉！</p>
<p><img src="https://i.imgur.com/mJBPdDA.png" alt=""></p>
<p>試跑幾次流程，可以看到有成功新增資料囉：</p>
<p><img src="https://i.imgur.com/3ylj9P6.png" alt=""></p>
<h2 id="修改資料">修改資料</h2>
<p>接著要嘗試修改資料，修改資料和新增最大的不同是會多一步先將原本的該筆資料取出。首先先將首頁修改一下，在每一行的結尾放上修改資料的連結。由於做成連結的 ActionLink 並不能放進像 model 這麼複雜的資料，所以在實務上都是以傳遞 id 為主。（ ActionLink 會把我們的資料做成連結、用 get 變成網址。所以 editCard.html?ID=2 這個它還看得懂，editCard.html?card=&amp;$%* 這種它就不知道怎麼表達了）</p>
<p><img src="https://i.imgur.com/MVj0OKY.png" alt=""></p>
<p>我們一樣回到 Controller 新增一個方法，只是這次我們要求先把要修改的資料也傳到頁面做處理。</p>
<p><img src="https://i.imgur.com/PLW4abi.png" alt=""></p>
<p>現在我們遇到的問題是：我們需要把 id 變成實際的卡片資料，必須利用這個 id 去取得資料。所以我們到 model 新增一個用 id 搜尋卡片資料的方法。</p>
<p><img src="https://i.imgur.com/r80dGT6.png" alt=""></p>
<p>可以看見單筆查詢的做法基本上和前面做過的拿全部資料所差無幾，只是一個搜全部一個搜條件而已。最大的差異在於我們傳遞了一個 ID 進去，並且在 SQL 指令的地方利用 <a href="https://www.1keydata.com/tw/sql/sqlwhere.html">WHERE 下了搜尋條件</a>，並且只回傳一項資料。</p>
<p>現在我們回到 Controller 將我們的 ID 搜尋方法放進去，並將回傳的 card 用傳遞 model 的方式傳到 View，期待它能聽話。</p>
<p><img src="https://i.imgur.com/gtNloFh.png" alt=""></p>
<p>接著我們要新增編輯的頁面（View）了，一樣右鍵新增檢視，並複製新增頁面的程式碼修改如下。</p>
<p><img src="https://i.imgur.com/k9ZyG7o.png" alt=""></p>
<p>特別標示紅色的部分要多加注意。</p>
<ul>
<li>首先我們傳入了 model，因此要先用 @model 告訴它我們傳遞的是哪個 model</li>
<li>修改我們表單的回傳目標</li>
<li>新增一格用來放置 ID，但是 ID 是不能修改的，因此把它設成唯讀</li>
<li>接著我們將 model 的值先放入各個欄位，才能在修改的時候顯示原本的資料。</li>
</ul>
<p>做完這一步的時候可以先從首頁執行是不是可以順利取得單筆資料。</p>
<p>修改完的資料必須回傳然後告訴資料庫修改的結果，因此我們和新增一樣要做一個 Post 的編輯方法來接收上面的表單。</p>
<p><img src="https://i.imgur.com/8flx7rK.png" alt=""></p>
<p>現在我們該再度前往 資料庫控制的 model 加上修改資料庫內容的方法了。</p>
<p><img src="https://i.imgur.com/dkBbur8.png" alt=""></p>
<p>一樣是和前面的新增資料很像，但這邊使用的 SQL 語法是更新資料用的 <a href="https://www.1keydata.com/tw/sql/sqlupdate.html">UPDATE 語法</a>並且結合了前面的 WHERE 來指定要更改的項目。完成之後我們就可以把它加到 Controller 的方法上囉：</p>
<p><img src="https://i.imgur.com/ZdyuZub.png" alt=""></p>
<p>這樣就宣告完工了！實際上來編輯一次吧</p>
<p><img src="https://i.imgur.com/Qtvhalt.png" alt=""></p>
<p>將寫程式修改成打呼看看</p>
<p><img src="https://i.imgur.com/E9dGERa.png" alt=""></p>
<p>可以看到成功變更囉！</p>
<p><img src="https://i.imgur.com/KAq6XkV.png" alt=""></p>
<h2 id="刪除資料">刪除資料</h2>
<p>如果前面都大致上了解的話，刪除就是小菜一碟。</p>
<p>首先我們先回到首頁列表，在編輯後面加上刪除的連結（我是用｜隔開而已，也可以另外新增一格甚至做成按鈕沒關係）</p>
<p><img src="https://i.imgur.com/WTn9MXw.png" alt=""></p>
<p>接著我們到 Controller 增加一個刪除的方法，因為我們並沒有要做一個「確認刪除嗎？」的頁面，所以最後直接回到首頁列表就可以了。</p>
<p><img src="https://i.imgur.com/ZScM56X.png" alt=""></p>
<p>接著就到資料庫互動的物件來實作刪除的部分。</p>
<p><img src="https://i.imgur.com/cJe4pic.png" alt=""></p>
<p>非常簡單，只有 SQL 語法的部分有更動，使用的是<a href="https://www.1keydata.com/tw/sql/sqldelete.html"> DELETE 指令</a>，由於只是刪除，因此我們果斷地打開連線，砍下去，關閉連線走人。</p>
<p>回到 Controller 把這個函式添加上去</p>
<p><img src="https://i.imgur.com/xFyaY8s.png" alt=""></p>
<p>然後就可以試試看能不能刪除資料囉！</p>
<p><img src="https://i.imgur.com/GzrN6Ca.png" alt=""></p>
<p>點下刪除了之後－－</p>
<p><img src="https://i.imgur.com/6O9vyNA.png" alt=""></p>
<p>資料就不見了！（其實蠻危險的？）</p>
<h2 id="結語">結語</h2>
<p>已經實作了顯示列表、新增、修改、查詢和刪除。所謂萬變不離其宗，基本的資料庫操作都離不開這些方法，熟悉了這些做法的概念之後就沒有問題了，剩下大多是顯示的時候做美化、排序等等的剩餘工作。Good Job！</p>
                        </div>

                        

<div class="post-archive">
    <h2>其他文章</h2>
    <ul class="listing">
        
        <li><a href="/post/2019/12/aspnet-connect-db-ef/">Asp.net MVC: Entity Framework 連線資料庫</a></li>
        
    </ul>
</div>


                        <div class="post-meta meta-tags">
                            
                            <ul class="clearfix">
                                
                                <li><a href="https://igouist.github.io/tags/csharp">CSharp</a></li>
                                
                                <li><a href="https://igouist.github.io/tags/dotnet">Dotnet</a></li>
                                
                                <li><a href="https://igouist.github.io/tags/database">Database</a></li>
                                
                                <li><a href="https://igouist.github.io/tags/entity-framework">Entity Framework</a></li>
                                
                            </ul>
                            
                        </div>
                        <hr />
<p>哈囉，如果你也有 LikeCoin，也覺得我的文章有幫上忙的話，還請不吝給我拍拍手呦，謝謝～ ;) </p>
<iframe class="LikeCoin" height="190" src="https://button.like.co/in/embed/igouist/button?referrer=https%3a%2f%2figouist.github.io%2fpost%2f2019%2f12%2faspnet-connect-db%2f" width="100%" frameborder=0></iframe>
                    </article>
                    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "Igouist/Igouist.github.io"
            issue-term="pathname"
            theme="github-dark"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
                </div>
            </div>
            <div id="secondary">
    <section class="widget">
        <form id="search" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://igouist.github.io/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://igouist.github.io/post/2020/10/oo-11-open-closed-principle/" title="菜雞與物件導向 (11): 開放封閉原則">菜雞與物件導向 (11): 開放封閉原則</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/post/2020/10/markdown/" title="易讀易寫！擁抱寫作神器 —— Markdown">易讀易寫！擁抱寫作神器 —— Markdown</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/post/2020/10/external-screen/" title="聊一下外接螢幕">聊一下外接螢幕</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/post/2020/10/oo-10-single-responsibility-principle/" title="菜雞與物件導向 (10): 單一職責原則">菜雞與物件導向 (10): 單一職責原則</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/post/2020/09/csharp-trulp/" title="C#: 元組 (Tuple)">C#: 元組 (Tuple)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/post/2020/09/oo-9-solid/" title="菜雞與物件導向 (9): SOLID">菜雞與物件導向 (9): SOLID</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/post/2020/09/oo-8-cohesion-and-coupling/" title="菜雞與物件導向 (8): 內聚、耦合">菜雞與物件導向 (8): 內聚、耦合</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/post/2020/09/start-with-why/" title="讀《先問為什麼》">讀《先問為什麼》</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/post/2020/08/csharp-timezone/" title="C#: 時區轉換、民國西元、國曆農曆、中文月份週期">C#: 時區轉換、民國西元、國曆農曆、中文月份週期</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/post/2020/08/powershell-beauty/" title="Powershell 美化作戰 —— 字型、執行原則和 oh-my-posh">Powershell 美化作戰 —— 字型、執行原則和 oh-my-posh</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">分類</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://igouist.github.io/categories/android/">android (1)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/categories/automation/">automation (3)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/categories/csharp/">csharp (23)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/categories/css/">css (1)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/categories/ide/">ide (2)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/categories/object-oriented/">object-oriented (12)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/categories/python/">python (7)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/categories/reading/">reading (2)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/categories/tools/">tools (10)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/categories/w3hexschool/">w3hexschool (39)</a>
    </li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title">標籤</h3>
<div class="tagcloud">
    
    <a href="https://igouist.github.io/tags/android/">android</a>
    
    <a href="https://igouist.github.io/tags/automapper/">automapper</a>
    
    <a href="https://igouist.github.io/tags/automation/">automation</a>
    
    <a href="https://igouist.github.io/tags/bandon/">bandon</a>
    
    <a href="https://igouist.github.io/tags/crawler/">crawler</a>
    
    <a href="https://igouist.github.io/tags/csharp/">csharp</a>
    
    <a href="https://igouist.github.io/tags/css/">css</a>
    
    <a href="https://igouist.github.io/tags/database/">database</a>
    
    <a href="https://igouist.github.io/tags/dotnet/">dotnet</a>
    
    <a href="https://igouist.github.io/tags/electron/">electron</a>
    
    <a href="https://igouist.github.io/tags/entity-framework/">entity-framework</a>
    
    <a href="https://igouist.github.io/tags/enum/">enum</a>
    
    <a href="https://igouist.github.io/tags/excel/">excel</a>
    
    <a href="https://igouist.github.io/tags/heroku/">heroku</a>
    
    <a href="https://igouist.github.io/tags/ide/">ide</a>
    
    <a href="https://igouist.github.io/tags/mysql/">mysql</a>
    
    <a href="https://igouist.github.io/tags/newbieguide/">newbieguide</a>
    
    <a href="https://igouist.github.io/tags/object-oriented/">object-oriented</a>
    
    <a href="https://igouist.github.io/tags/php/">php</a>
    
    <a href="https://igouist.github.io/tags/powershell/">powershell</a>
    
    <a href="https://igouist.github.io/tags/ptt/">ptt</a>
    
    <a href="https://igouist.github.io/tags/python/">python</a>
    
    <a href="https://igouist.github.io/tags/reading/">reading</a>
    
    <a href="https://igouist.github.io/tags/selenium/">selenium</a>
    
    <a href="https://igouist.github.io/tags/sqlite/">sqlite</a>
    
    <a href="https://igouist.github.io/tags/tools/">tools</a>
    
    <a href="https://igouist.github.io/tags/visualstudio/">visualstudio</a>
    
    <a href="https://igouist.github.io/tags/w3hexschool/">w3hexschool</a>
    
    <a href="https://igouist.github.io/tags/xampp/">xampp</a>
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">推薦友站</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="https://sunnyday0932.github.io/" title="Sian">🌙 Sian</a>
        </li>
        
        <li>
            <a target="_blank" href="https://ithelp.ithome.com.tw/users/20112224/articles" title="KingLong">KingLong - iT邦幫忙</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="https://igouist.github.io/index.xml">RSS</a></li>
        </ul>
    </section>
</div>
        </div>
    </div>
</div>
<footer id="footer">
    <div class="container">
        &copy; 2019 <a href="https://igouist.github.io/">伊果的沒人看筆記本 By Igouist</a>.
        Powered by <a rel="nofollow noreferer noopener" href="https://gohugo.io" target="_blank">Hugo</a>.
        <a href="https://www.flysnow.org/" target="_blank">Theme</a> based on <a href="https://github.com/rujews/maupassant-hugo" target="_blank">maupassant</a>.
        
        
        
        <span id="busuanzi_container_site_pv"> PV： <span id="busuanzi_value_site_pv"></span></span>
        
    </div>
</footer>


    <script type="text/javascript">
    
    (function(){
        
    }())

    window.MathJax = {
        tex2jax: {
            inlineMath: [ ['$','$'] ],
            processEscapes: true
        }
    };
    </script>
    <script type="text/javascript" src="/js/prism.js" async="true"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src="/js/totop.js?v=0.0.0" async=""></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-92586970-4', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



<script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




</body>
</html>
