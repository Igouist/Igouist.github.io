<!doctype html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="utf-8">
    
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-BWMYD757BP"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-BWMYD757BP');
    </script>

    <meta name="generator" content="Hugo 0.150.1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <title>使用 Azure Functions &#43; Line Notify 來定時提醒公車到站時間 | 伊果的沒人看筆記本</title>
    <meta property="og:title" content="使用 Azure Functions &#43; Line Notify 來定時提醒公車到站時間 - 伊果的沒人看筆記本">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content="2022-09-12T23:51:00&#43;08:00">
        
        
    <meta property="article:modified_time" content="2022-09-12T23:51:00&#43;08:00">
        
        <meta name="keywords" content="azure-functions, line-notify, motc api">
    <meta name="description" content="本文紀錄 Azure Functions 的簡單介紹，以及使用 Azure Functions 的 TimerTrigger 和 Line Notify 來製作一個公車提醒服務，讓你不會錯過每天要搭的公車。">
        <meta name="author" content="Igouist">
        
    <meta property="og:url" content="https://igouist.github.io/post/2022/09/bus-reminder-2-azure-functions-timetrigger-with-line-notify/">
    <meta property="og:image" content="https://igouist.github.io/me.jpg">

    <link rel="preconnect" href="https://image.igouist.net" crossorigin>
    
    

    
    

    <link rel="preload"
      href="/fonts/lxgw-wenkai-mono-tc.woff2"
      as="font"
      type="font/woff2"
      crossorigin="anonymous">

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

    <link rel="stylesheet" href="/css/normalize.css">
    
        <link rel="stylesheet" href="/css/prism.css">
    
    <link rel="stylesheet" href="/css/style.css">
    <script defer src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    
    
</head>

<body>
<header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://igouist.github.io/">
                        伊果的沒人看筆記本
                    </a>
                
                <p class="description">菜雞寫筆記，踩坑全紀錄</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://igouist.github.io/">Home</a>
                    
                    <a  href="https://igouist.github.io/categories/csharp-and-dotnet/" title="CSharp">CSharp</a>
                    
                    <a  href="https://igouist.github.io/categories/life/" title="Life">Life</a>
                    
                    <a  href="https://igouist.github.io/categories/reading/" title="Reading">Reading</a>
                    
                    <a  href="https://igouist.github.io/timeline/" title="Timeline">Timeline</a>
                    
                    <a  href="https://igouist.github.io/archives/" title="Archives">Archives</a>
                    
                    <a  href="https://igouist.github.io/about/" title="About">About</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>


<div id="body">
    <div class="container">
        <div class="col-group">

            <div class="col-8" id="main">
                <div class="res-cons">
                    <article class="post">
                        <header>
                            <h1 class="post-title">使用 Azure Functions &#43; Line Notify 來定時提醒公車到站時間</h1>
                        </header>
                        <date class="post-meta meta-date">
                            2022-9-12,
                        </date>
                        
                        <div class="post-meta">
                            
                                <span class="meta-category"><a href="https://igouist.github.io/categories/azure">azure</a></span>
                            
                        </div>
                        
                        
                        <div class="post-meta">(
                            <span id="vercount_container_page_pv">
                                <span id="vercount_value_page_pv">?</span>
                                <span>&nbsp;read</span>
                            </span>)
                        </div>
                        

                        <div class="post-content">
                            <p>


<img
  src="https://image.igouist.net/WX17auT.webp"
  alt="Image"width="600" height="1014"loading="auto" decoding="async">
</p>
<p>在上週的 <a href="/post/2022/09/bus-reminder-1-powershell-and-windows-task-scheduler">使用 Powershell + 工作排程器 + Line Notify 來定時提醒公車到站時間</a>，我們利用工作排程器來定時觸發腳本，藉此用 Line 提醒我下班的公車還有多久才來。</p>
<p>做完之後靈機一動，對呀！最近上班挺常接觸到 <a href="https://azure.microsoft.com/zh-tw/services/functions/">Azure Functions</a> 這個方便東東，不如就把這個小提醒給架設到 Azure Functions 上吧！</p>
<p>這樣就省卻了特定主機要開著掛工作排程器的困擾，又可以用香香的 Azure 工具來控制監聽的開關，豈不美哉。</p>
<p>如此如此這般這般，讓我們開始建立 Azure Functions 服務吧！</p>
<div class="toc toc-box">
    <div class="toc-title">章節目錄</div>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#建立-azure-functions-資源">建立 Azure Functions 資源</a></li>
    <li><a href="#使用-azure-functions-開發公車到站提醒服務">使用 Azure Functions 開發公車到站提醒服務</a>
      <ul>
        <li><a href="#建立-azure-funtcions-專案">建立 Azure Funtcions 專案</a></li>
        <li><a href="#呼叫-motc-api-查詢公車到站預估時間">呼叫 MOTC Api 查詢公車到站預估時間</a></li>
        <li><a href="#發送-line-notify">發送 Line Notify</a></li>
        <li><a href="#組合查詢公車資訊與發送到站通知">組合查詢公車資訊與發送到站通知</a></li>
        <li><a href="#本機測試-functions">本機測試 Functions</a></li>
      </ul>
    </li>
    <li><a href="#使用-visual-studio-發佈到-azure-functions">使用 Visual Studio 發佈到 Azure Functions</a></li>
    <li><a href="#小結">小結</a></li>
    <li><a href="#參考資料">參考資料</a></li>
  </ul>
</nav>
</div>
<h2 id="建立-azure-functions-資源">建立 Azure Functions 資源</h2>
<p><strong>Azure Functions 是 Azure 推出的一款無伺服器（Serverless）服務，簡單來說就是伺服器之類的麻煩事就交給 Azure 去處理，我們只要專心寫功能就好</strong>。對我這種愛寫小腳本的偷懶工程師來說，可以說是香到爆的服務。</p>
<blockquote>
<p>小提醒：Azure Functions 是一款收費服務，使用前請務必確認<a href="https://azure.microsoft.com/zh-tw/pricing/details/functions/">定價</a>。</p>
<p>在這篇文章撰寫當下，Azure Functions 有提供每月免費執行一百萬次的授權，對我們每天一次的公車通知來說綽綽有餘了（我們應該不會搭這麼多趟吧…？）</p></blockquote>
<p>首先讓我們到 <a href="https://portal.azure.com/#home">Azure</a> 建立一個函數應用程式（如果用英文，請找 Azure Functions）：</p>
<p>


<img
  src="https://image.igouist.net/9SJklpx.webp"
  alt="Image"width="444" height="165"loading="auto" decoding="async">
</p>
<p>


<img
  src="https://image.igouist.net/emG0G65.webp"
  alt="Image"width="891" height="357"loading="auto" decoding="async">
</p>
<p>接著進到建立 Functions 的頁面，讓我們先選好資源群組，並取個好名字</p>
<p>因為「MyFunctions」之類的都被取走了，這邊就直接取「林北ㄟ Functions」：</p>
<p>


<img
  src="https://image.igouist.net/pyi77OX.webp"
  alt="Image"width="743" height="911"loading="auto" decoding="async">
</p>
<p>執行階段堆疊請選擇自己開發用的語言，我這邊使用 .Net 6 進行開發，作業系統則按照建議的選擇。</p>
<blockquote>
<p>這邊要稍微注意方案的選擇！如同前面提到的<a href="https://azure.microsoft.com/zh-tw/pricing/details/functions/">定價</a>，也可以參照 Microsoft Docs 的<a href="https://docs.microsoft.com/zh-tw/azure/azure-functions/functions-consumption-costs?tabs=portal">預估 Azure Functions 中的取用方案成本</a>說明，裡面會有使用量、進階等方案的說明。</p>
<p>這次我們要做的只是簡單的提醒通知，所以就選費用最低的使用量計價就好囉～</p></blockquote>
<p>按下確認後就會開始部屬：</p>
<p>


<img
  src="https://image.igouist.net/HAk5hdD.webp"
  alt="Image"width="1132" height="505"loading="auto" decoding="async">
</p>
<p>部屬完成就可以前往我們建立的資源囉，可以在這裡確認記憶體、執行次數等資訊：</p>
<p>


<img
  src="https://image.igouist.net/xBbnNbB.webp"
  alt="Image"width="887" height="314"loading="auto" decoding="async">
</p>
<p>


<img
  src="https://image.igouist.net/pHteaUf.webp"
  alt="Image"width="1488" height="840"loading="auto" decoding="async">
</p>
<p>從左側的「函式」可以確認我們現在有哪些 Functions，當然目前還是空的：</p>
<p>


<img
  src="https://image.igouist.net/WWLtsFG.webp"
  alt="Image"width="949" height="410"loading="auto" decoding="async">
</p>
<p>接著就讓我們來撰寫第一個 Function 吧！</p>
<h2 id="使用-azure-functions-開發公車到站提醒服務">使用 Azure Functions 開發公車到站提醒服務</h2>
<p>因為這篇的功能完全是<a href="/post/2022/09/bus-reminder-1-powershell-and-windows-task-scheduler">使用 Powershell + 工作排程器 + Line Notify 來定時提醒公車到站時間</a>的完美復刻版，因此我們要做的事情還是一樣：</p>
<ul>
<li>每天下班前十分鐘（定時執行）</li>
<li>告訴我（通知功能）</li>
<li>下一班到達的公車時間（查詢資訊）</li>
</ul>
<p>只是這次的功能使用 .Net 6 撰寫，並且使用 Visual Studio 為範例來記錄，定時功能則從臭臭又綁電腦的工作排程器改用香香 Azure Functions 的定時觸發功能。</p>
<h3 id="建立-azure-funtcions-專案">建立 Azure Funtcions 專案</h3>
<p>首先讓我們新增專案，內建已經有 Azure Functions 的範例可以使用：</p>
<p>


<img
  src="https://image.igouist.net/gqnprvJ.webp"
  alt="Image"width="1008" height="672"loading="auto" decoding="async">
</p>
<p>取個好名字，這邊沿用剛剛開資源的命名：</p>
<p>


<img
  src="https://image.igouist.net/bJtncZx.webp"
  alt="Image"width="1008" height="672"loading="auto" decoding="async">
</p>
<p>接著就要選擇版本，這邊<strong>要注意 Azure Function 目前還有分出隔離版（Isolated）</strong>：</p>
<p>


<img
  src="https://image.igouist.net/6LpLjZX.webp"
  alt="Image"width="1008" height="672"loading="auto" decoding="async">
</p>
<p>簡單來說，原本的 Azure Functions 和主機環境太耦合了，如果用到同一個套件不同版本就有可能翻車。因此推出了隔離式的 Azure Functions 讓我們可以乾乾淨淨地用。</p>
<p>想更了解隔離式版本的差異，可以參見：</p>
<ul>
<li><a href="https://docs.microsoft.com/zh-tw/azure/azure-functions/dotnet-isolated-process-guide#why-net-isolated-process">在隔離式程序中執行 C# Azure Functions 的指南 | Microsoft Docs</a></li>
<li><a href="https://markheath.net/post/azure-functions-isolated">Is it time to start creating C# Azure Functions in isolated mode? (markheath.net)</a></li>
</ul>
<p>由於 <a href="https://techcommunity.microsoft.com/t5/apps-on-azure-blog/net-on-azure-functions-roadmap/ba-p/2197916">.NET on Azure Functions Roadmap</a> 的示意圖：</p>
<p>


<img
  src="https://techcommunity.microsoft.com/t5/s/gxcuf89792/images/bS0yMTk3OTE2LTI2MjMxOGk0MjM0QjEzMkM3NDI1MDlD?image-dimensions=999x340&amp;revision=8"
  alt=""width="998" height="340"loading="auto" decoding="async">
</p>
<p>明確指出將來的主軸會是隔離式（Isolated），因此我們這邊專案也選擇 .Net 6 已隔離的版本。<del>這樣我往後抄起來比較方便</del></p>
<blockquote>
<p>小提示：查詢 Azure Functions 相關資料時也要注意版本的差異！<strong>在 .Net 開發隔離式的 SDK 並不一樣</strong>，連最基本標示 Function 的語法，原本是 <code>[FunctionName()]</code>，隔離式也改成了更簡潔的 <code>[Function()]</code>，<strong>因此查資料或開發時要特別注意版本差異</strong>，避免被 IDE 畫了紅線卻搞不懂為什麼。</p></blockquote>
<p>接著我們就可以選擇 Function 的觸發條件，因為我們要定時提醒，因此這邊選擇 Timer Trigger 就可以了：</p>
<p>


<img
  src="https://image.igouist.net/eIzaYSc.webp"
  alt="Image"width="1008" height="672"loading="auto" decoding="async">
</p>
<p>同樣常用的還有當成 API 打的 Http Trigger，以及和我們上一次介紹過的 <a href="/post/2022/08/azure-service-bus/">ServiceBus</a> 一起使用的 Service Bus Queue/Topic Trigger 等等。</p>
<p>關於提供的觸發方式和程式碼範例，可以參照 Microsoft Docs 的 <a href="https://docs.microsoft.com/zh-tw/azure/azure-functions/functions-triggers-bindings?tabs=csharp#supported-bindings">Azure Functions 中的觸發程序和繫結</a></p>
<p>最後因為我們選擇了 Timer Trigger，這邊提供我們直接設定時間。使用的是 NCrontab 格式，可以參考 <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-timer?tabs=in-process&amp;pivots=programming-language-csharp#cron-expressions">NCRONTAB expressions</a> 的說明，Visuat Studio 上也有簡短地介紹：</p>
<p>


<img
  src="https://image.igouist.net/6OB1Qrs.webp"
  alt="Image"width="932" height="126"loading="auto" decoding="async">
</p>
<p>按照需求，我們希望下班前，也就是每天的 17:45 左右能提醒公車預估到站的時間。</p>
<p>NCrontab 和常見的 Crontab 差在多了第一個欄位來控制秒，因此這邊果斷直接使用 <a href="https://crontab.guru/#*_*_*_*_*">Cronitor</a> 查一下，再往前加上一欄當作秒數即可。</p>
<blockquote>
<p>補充：另一個香香工具 <a href="/post/2022/08/devtoys/">DevToys</a> 也能迅速組裝和確認 Cron 語法呦！</p></blockquote>
<p>每天的 17:45 在 Crontab 表示為「45 17 * * *」：</p>
<p>


<img
  src="https://image.igouist.net/o5k9Jvl.webp"
  alt="Image"width="1041" height="259"loading="auto" decoding="async">
</p>
<p>我們希望在 0 秒的時候觸發，因此轉 NCrontab 時需要在秒的位置指定 0，也就是「0 45 17 * * *」</p>
<p>但在填到 Azure Functions 要注意，<strong>在伺服器的時間會是 UTC+0</strong>。為了在台灣，也就是 UTC+8 的 17:45 觸發，因此將時間更改為「0 45 9 * * *」，否則 Line 就會在半夜通知你起來搭公車</p>
<p>


<img
  src="https://image.igouist.net/bDNvzhE.webp"
  alt="Image"width="1059" height="237"loading="auto" decoding="async">
</p>
<p>這樣其他資訊的頁面就填寫完了，可以按下建立囉！</p>
<p>


<img
  src="https://image.igouist.net/STp7otF.webp"
  alt="Image"width="1008" height="672"loading="auto" decoding="async">
</p>
<p>建立後會看到 Visual Studio 已經使用我們剛剛的設置建立了一個 Function 及 Timer Trigger，時間也填好了（如果後續還要調整時間，就修改 <code>TimerTrigger</code> 的值就好）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Function1</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> ILogger _logger;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Function1(
</span></span><span style="display:flex;"><span>        ILoggerFactory loggerFactory)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        _logger = loggerFactory.CreateLogger&lt;Function1&gt;();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">    [Function(&#34;Function1&#34;)]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Run([TimerTrigger(<span style="color:#e6db74">&#34;0 45 9 * * *&#34;</span>)] MyInfo myTimer)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        _logger.LogInformation(<span style="color:#e6db74">$&#34;C# Timer trigger function executed at: {DateTime.Now}&#34;</span>);
</span></span><span style="display:flex;"><span>        _logger.LogInformation(<span style="color:#e6db74">$&#34;Next timer schedule at: {myTimer.ScheduleStatus.Next}&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>為了後續管理方便，我們先改個名。這邊就叫做 <code>BusReminderFunctions</code> 吧：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BusReminderFunctions</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> ILogger _logger;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> BusReminderFunctions(
</span></span><span style="display:flex;"><span>        ILoggerFactory loggerFactory)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        _logger = loggerFactory.CreateLogger&lt;BusReminderFunctions&gt;();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">    [Function(&#34;BusReminder-TimerTrigger&#34;)]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> RunTimerTrigger([TimerTrigger(<span style="color:#e6db74">&#34;0 45 9 * * *&#34;</span>)] MyInfo myTimer)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        _logger.LogInformation(<span style="color:#e6db74">$&#34;C# Timer trigger function executed at: {DateTime.Now}&#34;</span>);
</span></span><span style="display:flex;"><span>        _logger.LogInformation(<span style="color:#e6db74">$&#34;Next timer schedule at: {myTimer.ScheduleStatus.Next}&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>並且為了測試方便，我們再增加一個 <a href="https://docs.microsoft.com/zh-tw/azure/azure-functions/functions-bindings-http-webhook-trigger?tabs=isolated-process%2Cfunctionsv2&amp;pivots=programming-language-csharp">HttpTrigger</a>，這時候會需要先去 Nuget 安裝相關的套件</p>
<p>搜尋 <code>Microsoft.Azure.Functions.Worker.Extensions</code> 就會看到各種 Trigger，這邊就安裝一下 Http 需要的套件吧：</p>
<p>


<img
  src="https://image.igouist.net/d4WDrue.webp"
  alt="Image"width="1002" height="455"loading="auto" decoding="async">
</p>
<p>現在讓我們回到 Functions，增加一個 <code>HttpTrigger</code>，調整一下非同步，並建立一個私有方法 <code>TrackBusAsync</code>，讓 <code>HttpTrigger</code> 和 <code>TimerTrigger</code> 都去呼叫這個方法，這樣我們就可以定時觸發也可以手動觸發它，後續測試起來也比較方便：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#a6e22e">[Function(&#34;BusReminder-TimerTrigger&#34;)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task RunTimerTrigger([TimerTrigger(<span style="color:#e6db74">&#34;0 45 9 * * *&#34;</span>)] MyInfo myTimer)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> TrackBusAsync();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">[Function(&#34;BusReminder&#34;)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;HttpResponseData&gt; HttpTrigger(
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">    [HttpTrigger(AuthorizationLevel.Anonymous, &#34;get&#34;, &#34;post&#34;)]</span> HttpRequestData req,
</span></span><span style="display:flex;"><span>    FunctionContext executionContext)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> TrackBusAsync();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> response = req.CreateResponse(HttpStatusCode.OK);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> response.WriteAsJsonAsync&lt;<span style="color:#66d9ef">object</span>&gt;(<span style="color:#66d9ef">new</span> { result = <span style="color:#66d9ef">true</span> });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> response;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">async</span> Task TrackBusAsync()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NotImplementedException();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p>補充：HttpTrigger 的參數有三個部份，可以拆分成：</p>
<ul>
<li>授權層級：Anonymous, Admin 之類的，可參照<a href="https://docs.microsoft.com/zh-tw/azure/azure-functions/functions-bindings-http-webhook-trigger?tabs=isolated-process%2Cfunctionsv2&amp;pivots=programming-language-csharp#http-auth">授權層級</a></li>
<li>方法：Get, Post 之類的，沒指定就會是不限方法</li>
<li>路由：用來定義 API 路由，預設會拿 FunctionName，在這例子就是 <code>BusReminder</code></li>
</ul>
<p>都有指定的樣子會像這樣：<br/><code>[HttpTrigger(AuthorizationLevel.Anonymous, &quot;get&quot;, &quot;post&quot;, Route = null)]</code></p></blockquote>
<p>這樣事前準備就差不多了，讓我們開始撰寫邏輯部分吧！</p>
<h3 id="呼叫-motc-api-查詢公車到站預估時間">呼叫 MOTC Api 查詢公車到站預估時間</h3>
<p>首先我們需要取得公車到站預估時間，這部分跟上一期一樣就直接從公共運輸動態服務 MOTC Transport API 的「市區公車之預估到站資料」（<code>EstimatedTimeOfArrival/City/{City}/{RouteName}</code>） 這支 API 取得就行了。</p>
<blockquote>
<p>2024.11.25 更新：發現 MOTC 的 API 已經下架了，現在公車資訊已經被整合到運輸資料服務 <a href="https://tdx.transportdata.tw/api-service/swagger/basic/2998e851-81d0-40f5-b26d-77e2f5ac4118#/">TDX (Transport Data eXchange)</a>，有要動手串公車資訊的朋友可能得觀察新版 API 再進行調整了 QQ</p></blockquote>
<blockquote>
<p>註：為了避免被查水表，以下就用台北的 307 號公車為例，並假設目標站點是「台北車站（忠孝）」</p></blockquote>
<p>嘗試把縣市和公車路線名稱代入後，可以取得公車行經的站牌資訊，其中就有我們最想要的估計到站時間（秒）：</p>
<p>


<img
  src="https://image.igouist.net/GQ9wdqG.webp"
  alt="Image"width="1000" height="586"loading="auto" decoding="async">
</p>
<p>在這個步驟我們還會需要調整 <code>$top</code> 參數的筆數，順便取得我們要監聽公車到站的站牌 ID（StopId）以及行進方向（Direction） 在這個例子中「台北車站（忠孝）」的站牌 ID 會是 15250</p>
<p>


<img
  src="https://image.igouist.net/mixE42V.webp"
  alt="Image"width="994" height="576"loading="auto" decoding="async">
</p>
<p>確保了資料來源之後，讓我們回到專案裡。</p>
<p>這次為了之後方便擴展，決定將公車名稱、站牌 ID 等查詢資訊放到組態裡。</p>
<blockquote>
<p>註：接下來會使用到 <a href="/post/2021/11/newbie-6-dependency-injection/">依賴注入</a> 以及讀取 Config 的 <a href="https://docs.microsoft.com/zh-tw/aspnet/core/fundamentals/configuration/options?view=aspnetcore-6.0">IOptions</a>；對這兩項不太熟悉的朋友可以先看過去，並且在後續 BusReminderFunctions 的建構式裡把公車資訊寫死就好，並不會影響功能。</p></blockquote>
<p>一般的 .Net 6 API 專案我們會把組態設定放到 <code>appsettings.json</code> 中，而在開發 Azure Functions 的時候，則會需要用到 <code>host.json</code> 和 <code>local.settings.json</code>：</p>
<p>


<img
  src="https://image.igouist.net/oeWBtKj.webp"
  alt="Image"width="621" height="288"loading="auto" decoding="async">
</p>
<p>其中 <code>host.json</code> 用來設定站台相關的組態，例如在先前<a href="/post/2022/08/azure-function-servicebus-trigger-max-auto-renew-duration/">調整 ServiceBus Trigger 的時候</a>，我們就是在 <code>host.json</code> 修改重新傳遞訊息到 Azure Functions 的時間。</p>
<p>而 <code>local.settings.json</code> 則是讓我們在本機開發時使用，對應到線上的組態設定：</p>
<p>


<img
  src="https://image.igouist.net/LOjCKc3.webp"
  alt="Image"width="1829" height="888"loading="auto" decoding="async">
</p>
<p><strong>可以看到 Azure 上的組態有「應用程式設定」和「連接字串」兩個區塊，而在本機開發時會對應到「Values」以及「ConnectionStrings」</strong>：</p>
<p>


<img
  src="https://image.igouist.net/c4y1dQy.webp"
  alt="Image"width="964" height="279"loading="auto" decoding="async">
</p>
<p>有個大概的認識之後，現在讓我們填入一些值吧。</p>
<p>現在我希望能從組態中，使用 <a href="https://docs.microsoft.com/zh-tw/aspnet/core/fundamentals/configuration/options?view=aspnetcore-6.0">IOptions</a> 取得查詢公車估計時間相關的設定，因此我先建立了一個 Class <code>BusTrackerOption</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// 公車到站監聽設定</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BusTrackerOption</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// 公車路線名稱</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> RouteName { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// 要預估到站的站牌 ID</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> StopId { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// 公車路線行進方向</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Direction { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; } = <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>並且到 <code>local.settings.json</code> 加上組態。這邊要特別提到的是：原本我們在 <code>appsettings.json</code> 加上組態，會用這種階層式的寫法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;BusTracker&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;RouteName&#34;</span>: <span style="color:#e6db74">&#34;307&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;StopId&#34;</span> : <span style="color:#ae81ff">15250</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;Direction&#34;</span>: <span style="color:#ae81ff">0</span> 
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>但我們前面已經看到了，<strong>在 Azure 上的組態實際上是一個單層的列表。因此我們會使用 <code>__</code> 當作分隔符號來將設定攤平，並放到 <code>local.settings.json</code> 的 <code>Values</code> 裡</strong>（如果是連線字串就放到 <code>ConnectionStrings</code> 裡），也就是像這樣：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;Values&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...這裡會有其他組態設定
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 加上 BusTracker 的 參數，用 __ 來表示階層
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">&#34;BusTracker__RouteName&#34;</span>: <span style="color:#ae81ff">307</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;BusTracker__StopId&#34;</span>: <span style="color:#ae81ff">15250</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;BusTracker__Direction&#34;</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>接著讓我們到 <code>Program.cs</code> 來將 json 的設定值繫結到 <code>BusTrackerOption</code>，Section 名稱要記得和 json 中的階層名稱對上</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">// 注意 Azure Functions 的 settings.json 的階層要用 __ 來區隔</span>
</span></span><span style="display:flex;"><span>services.AddOptions();
</span></span><span style="display:flex;"><span>services.Configure&lt;BusTrackerOption&gt;(hostContext.Configuration.GetSection(<span style="color:#e6db74">&#34;BusTracker&#34;</span>));
</span></span></code></pre></div><blockquote>
<p>註：如果像我一樣開 .Net 6，只看到 <code>HostBuilder</code> 的朋友，可以自行加入 <code>ConfigureServices((hostContext, services) =&gt; {})</code> 的部份來註冊，如下：</p>
<p>


<img
  src="https://image.igouist.net/I6DFiRl.webp"
  alt="Image"width="962" height="339"loading="auto" decoding="async">
</p></blockquote>
<p>接著就可以回到我們的 <code>BusReminderFunctions</code> 來把 <code>IOptions&lt;BusTrackerOption&gt;</code> 注入進來：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BusReminderFunctions</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> ILogger _logger;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> BusTrackerOption _busTrackerOption;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> BusReminderFunctions(
</span></span><span style="display:flex;"><span>        ILoggerFactory loggerFactory,
</span></span><span style="display:flex;"><span>        IOptions&lt;BusTrackerOption&gt; busTrackerOption)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        _logger = loggerFactory.CreateLogger&lt;BusReminderFunctions&gt;();
</span></span><span style="display:flex;"><span>        _busTrackerOption = busTrackerOption.Value;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...略</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p>對依賴注入還不太熟悉的朋友，可以在這邊的建構式裡宣告出 <code>BusTrackerOption</code> 並賦值即可。但還是推薦閱讀<a href="/post/2021/11/newbie-6-dependency-injection/">依賴注入</a>的筆記來了解一下呦</p></blockquote>
<p>現在公車路線等組態都準備得差不多了，只剩下回傳時候要用來接收資料的 Model 還沒開。這時候就直接偷懶，拿 <a href="https://ptx.transportdata.tw/MOTC?t=Bus&amp;v=2#">MOTC Transport API</a> 的 Swagger 打回來的 Json，直接到 <a href="https://json2csharp.com/">Json2Cshrp</a> 之類的轉換網站直接產生 C# Class 就好了：</p>
<p>


<img
  src="https://image.igouist.net/NJ6HTbA.webp"
  alt="Image"width="1002" height="711"loading="auto" decoding="async">
</p>
<p>


<img
  src="https://image.igouist.net/RXzItDb.webp"
  alt="Image"width="705" height="530"loading="auto" decoding="async">
</p>
<p>記得轉換結果的 <code>Class Root</code> 要改個名稱，這邊就直接取名叫做 <code>BusEstimateInfo</code> 吧：</p>
<p>


<img
  src="https://image.igouist.net/9SoUyu9.webp"
  alt="Image"width="540" height="422"loading="auto" decoding="async">
</p>
<p>現在我們有傳過去的參數，也有接回來的 Model 了，讓我們來開一個私有方法，從 MOTC API 取回資料吧：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// 查詢公車估計到站時間</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;param name=&#34;routeName&#34;&gt;路線名稱&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;param name=&#34;stopId&#34;&gt;站牌 ID&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;param name=&#34;direction&#34;&gt;去返程&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">async</span> Task&lt;BusEstimateInfo&gt; FetchBusEstimateTime(
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">string</span> routeName,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> stopId,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> direction = <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> api = <span style="color:#e6db74">$&#34;https://ptx.transportdata.tw/MOTC/v2/Bus/EstimatedTimeOfArrival/City/Taipei/{routeName}&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 將站牌 ID 及路線方向 加入到查詢參數中</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> filter = <span style="color:#e6db74">$&#34;stopId eq &#39;{stopId}&#39;&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (direction != <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        filter += <span style="color:#e6db74">$&#34; and direction eq {direction}&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> query = <span style="color:#66d9ef">new</span> Dictionary&lt;<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">string</span>&gt;()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">        [&#34;$filter&#34;]</span> = filter,
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">        [&#34;$top&#34;]</span> = <span style="color:#ae81ff">1.</span>ToString(),
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">        [&#34;$format&#34;]</span> = <span style="color:#e6db74">&#34;JSON&#34;</span>
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 使用套件 Microsoft.AspNetCore.WebUtilities 提供的 QueryHelpers </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 直接組出帶 QueryString 的 Url</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> url = QueryHelpers.AddQueryString(api, query);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 建立 request；注意直接呼叫 API 會要求驗證</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 必須將 Header 掛成瀏覽器才能吃到每日 50 次的呼叫額度</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> request = <span style="color:#66d9ef">new</span> HttpRequestMessage
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        Method = HttpMethod.Get,
</span></span><span style="display:flex;"><span>        RequestUri = <span style="color:#66d9ef">new</span> Uri(url)
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    request.Headers.Add(<span style="color:#e6db74">&#34;User-Agent&#34;</span>, <span style="color:#e6db74">&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64)&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">using</span> var client = <span style="color:#66d9ef">new</span> HttpClient();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> response = <span style="color:#66d9ef">await</span> client.SendAsync(request);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (response.IsSuccessStatusCode <span style="color:#66d9ef">is</span> <span style="color:#66d9ef">false</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Exception(response.StatusCode.ToString());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> body = <span style="color:#66d9ef">await</span> response.Content.ReadAsStringAsync();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> result = JsonSerializer.Deserialize&lt;IEnumerable&lt;BusEstimateInfo&gt;&gt;(body)?.FirstOrDefault();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> result ?? <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Exception(<span style="color:#e6db74">&#34;呼叫 API 失敗，無法取得估計到站資訊&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>這支呼叫 API 的 Method 步驟相當簡單：組出參數，呼叫 API，取回資料。</p>
<p>這邊有偷懶不想組字串，直接使用 <code>Microsoft.AspNetCore.WebUtilities</code> 的 <code>QueryHelpers.AddQueryString</code> 來把 GET 的 QueryString 參數組到 Url 裡，不想多安裝一個套件的朋友也可以自己手動組。</p>
<blockquote>
<p>註：<a href="https://motc-ptx-api-documentation.gitbook.io/motc-ptx-api-documentation/hui-yuan-shen-qing/membertype">MOTC 的 文件</a> 有提到非會員一天有 50 次的免費 Swagger 呼叫次數，實測如果是從程式呼叫時會需要吃驗證，要掛 Header 假裝成瀏覽器才能取得資料，不確定是不是還有其他限制。如果是要給自己開發的工具或產品使用的話，還是可以考慮了解一下 MOTC 的會員制度。</p></blockquote>
<blockquote>
<p>註：這邊的 HttpClient 也可以直接改用注入 <a href="https://docs.microsoft.com/zh-tw/dotnet/architecture/microservices/implement-resilient-applications/use-httpclientfactory-to-implement-resilient-http-requests">HttpClientFactory</a> 的方式來製作。可以參照 Yowko&rsquo;s Notes 的這篇：<a href="https://blog.yowko.com/httpclient/">在 .NET Core 與 .NET Framework 上使用 HttpClientFactory</a></p></blockquote>
<p>現在取得公車資料的 <code>FetchBusEstimateTime</code> 已經建好了，讓我們調整一下外面的 Trigger 和共通的私有方法，來把 <code>BusTrackerOption</code> 的資訊帶到參數裡吧：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> BusReminderFunctions(
</span></span><span style="display:flex;"><span>    IOptions&lt;BusTrackerOption&gt; busTrackerOption,
</span></span><span style="display:flex;"><span>    ILoggerFactory loggerFactory)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    _busTrackerOption = busTrackerOption.Value;
</span></span><span style="display:flex;"><span>    _logger = loggerFactory.CreateLogger&lt;BusReminderFunctions&gt;();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">[Function(&#34;BusReminder-TimerTrigger&#34;)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task RunTimerTrigger([TimerTrigger(<span style="color:#e6db74">&#34;0 45 9 * * *&#34;</span>)] MyInfo myTimer)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> routeName = <span style="color:#66d9ef">this</span>._busTrackerOption.RouteName;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> stopId = <span style="color:#66d9ef">this</span>._busTrackerOption.StopId;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> direction = <span style="color:#66d9ef">this</span>._busTrackerOption.Direction;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> TrackBusAsync(routeName, stopId, direction);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">[Function(&#34;BusReminder&#34;)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;HttpResponseData&gt; HttpTrigger(
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">    [HttpTrigger(AuthorizationLevel.Anonymous, &#34;get&#34;, &#34;post&#34;)]</span> HttpRequestData req,
</span></span><span style="display:flex;"><span>    FunctionContext executionContext)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> routeName = <span style="color:#66d9ef">this</span>._busTrackerOption.RouteName;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> stopId = <span style="color:#66d9ef">this</span>._busTrackerOption.StopId;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> direction = <span style="color:#66d9ef">this</span>._busTrackerOption.Direction;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> TrackBusAsync(routeName, stopId, direction);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> response = req.CreateResponse(HttpStatusCode.OK);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> response.WriteAsJsonAsync&lt;<span style="color:#66d9ef">object</span>&gt;(<span style="color:#66d9ef">new</span> { result = <span style="color:#66d9ef">true</span> });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> response;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">async</span> Task TrackBusAsync(
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">string</span> routeName,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> stopId,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> direction = <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> busEstimateInfo = <span style="color:#66d9ef">await</span> FetchBusEstimateTime(routeName, stopId, direction);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NotImplementedException();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>就像前面提到的，我們在這邊讓 <code>TimerTrigger</code> 和 <code>HttpTrigger</code> 取出 <code>BusTrackerOption</code> 的公車相關參數，例如公車路線名稱後，再傳遞到共用的 <code>TrackBusAsync</code>，現在第一部份的查詢公車資訊已經完工，就讓我們先添加上去。</p>
<blockquote>
<p>註：這邊之所以要讓查詢參數交由外面決定，就是以後如果我想把 <code>HttpTrigger</code> 改成可以從外部呼叫 API 時可以指定公車路線之類的參數，又或者是將來要註冊多組公車路線到資料庫之類的改動時，可以不用再動「查詢公車到站資訊」之類的邏輯。<del>畢竟懶惰的訣竅在於提早準備</del></p></blockquote>
<h3 id="發送-line-notify">發送 Line Notify</h3>
<blockquote>
<p>2024.10 更新: Line Notify 將於 2025 年 3 月停止服務（<a href="https://notify-bot.line.me/closing-announce">LINE Notify 結束服務公告</a>），有看到這篇的朋朋請選擇一組新的通知服務來串吧 QQ</p></blockquote>
<p>現在搞定取得公車資訊的段落了，接著就讓我們來撰寫發送 Line Notify 的部份吧。</p>
<p>這邊為了過程完整一點，就重播一下上次衝刺去申請 Line Notify Token 的過程吧：</p>
<blockquote>
<p>當下一個直衝 <a href="https://notify-bot.line.me/zh_TW/">Line Notify</a> 高速申請權杖：</p>
<p>


<img
  src="https://image.igouist.net/StPJo9W.webp"
  alt="Image"width="264" height="210"loading="auto" decoding="async">
</p>
<p>


<img
  src="https://image.igouist.net/W43nwLq.webp"
  alt="Image"width="506" height="304"loading="auto" decoding="async">
</p>
<p>


<img
  src="https://image.igouist.net/Ahl9FoN.webp"
  alt="Image"width="511" height="357"loading="auto" decoding="async">
</p></blockquote>
<p>好的回想完畢，現在讓我們把拿到的 Line Notify Token 也丟到 <code>local.settings.json</code> 的 <code>Values</code> 裡方便管理：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;Values&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...這裡會有其他組態設定
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 加上 LineNotify 的 Token，用 __ 來表示階層
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">&#34;LineNotify__Token&#34;</span>: <span style="color:#e6db74">&#34;YOUR LINE NOTIFY TOKEN&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>一樣建立一個 Class，方便後續用 <code>IOption</code> 從組態中取得值：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LineNotifyOptions</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> Token { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>接著到 <code>Program.cs</code> 來將 json 的設定值繫結到 <code>LineNotifyOptions</code>，Section 名稱要記得和 json 中的名稱對上：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>services.Configure&lt;LineNotifyOption&gt;(hostContext.Configuration.GetSection(<span style="color:#e6db74">&#34;LineNotify&#34;</span>));
</span></span></code></pre></div><p>


<img
  src="https://image.igouist.net/61Fs36d.webp"
  alt="Image"width="971" height="365"loading="auto" decoding="async">
</p>
<p>接著就可以回到我們的 <code>BusReminderFunctions</code> 來把 <code>IOptions&lt;LineNotifyOptions&gt;</code> 注入進來：</p>
<p>


<img
  src="https://image.igouist.net/aYwNOod.webp"
  alt="Image"width="679" height="425"loading="auto" decoding="async">
</p>
<p>這樣從 Config 取得 Token 的準備就完成了，現在讓我們來撰寫傳送訊息的方法本體吧</p>
<p><strong>發送 Line Notify 實際上就是傳送一個 Post 請求到 <code>/api/notify</code>，並將 Token 放到 Header 的 <code>Authorization</code>、訊息丟到 Body 就行了</strong>，因此我們可以直接把這方法包裝成接收到訊息就傳遞給 API：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// 發送 Line Notify 通知</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;param name=&#34;message&#34;&gt;The message.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;exception cref=&#34;System.Exception&#34;&gt;發送失敗&lt;/exception&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">async</span> Task SendLineNotify(<span style="color:#66d9ef">string</span> message)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">string</span>.IsNullOrEmpty(_lineNotifyOptions.Token))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Exception(<span style="color:#e6db74">&#34;取得 Line Notify Token 失敗&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">string</span> lineNotifyApi = <span style="color:#e6db74">&#34;https://notify-api.line.me/api/notify&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> requestBody = <span style="color:#66d9ef">new</span> Dictionary&lt;<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">string</span>&gt;
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">        [&#34;message&#34;]</span> = message
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> request = <span style="color:#66d9ef">new</span> HttpRequestMessage
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        Method = HttpMethod.Post,
</span></span><span style="display:flex;"><span>        RequestUri = <span style="color:#66d9ef">new</span> Uri(lineNotifyApi),
</span></span><span style="display:flex;"><span>        Content = <span style="color:#66d9ef">new</span> FormUrlEncodedContent(requestBody)
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    request.Headers.Add(<span style="color:#e6db74">&#34;Authorization&#34;</span>, <span style="color:#e6db74">$&#34;Bearer {_lineNotifyOptions.Token}&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">using</span> var client = <span style="color:#66d9ef">new</span> HttpClient();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> response = <span style="color:#66d9ef">await</span> client.SendAsync(request);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (response.IsSuccessStatusCode <span style="color:#66d9ef">is</span> <span style="color:#66d9ef">false</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Exception(<span style="color:#e6db74">&#34;Line Notify 發送失敗&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>現在我們也已經有了傳送訊息的方法，是時候把它們倆串起來了！</p>
<h3 id="組合查詢公車資訊與發送到站通知">組合查詢公車資訊與發送到站通知</h3>
<p>先把鏡頭回到我們讓 Trigger 們共用的 <code>TrackBusAsync</code> 方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">async</span> Task TrackBusAsync(
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">string</span> routeName,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> stopId,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> direction = <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> busEstimateInfo = <span style="color:#66d9ef">await</span> FetchBusEstimateTime(routeName, stopId, direction);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NotImplementedException();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>可以看到我們已經嘗試取得公車資訊，現在我們要組裝訊息，然後傳遞到剛剛撰寫的 Line Notify 通知方法裡。</p>
<p>而我想要的訊息是這樣的：「您追蹤的公車 307 將在 10 分鐘後（18:00）抵達 台北車站（忠孝）」</p>
<p>因此我會需要計算出剩餘的分數，以及抵達時間，再從前面拿到的公車資訊來組成訊息並傳遞到方法中：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">async</span> Task TrackBusAsync(
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">string</span> routeName,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> stopId,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> direction = <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> busEstimateInfo = <span style="color:#66d9ef">await</span> FetchBusEstimateTime(routeName, stopId, direction);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 將預估幾秒後抵達 轉換成 預估幾分鐘後抵達</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> estimateMin = <span style="color:#66d9ef">new</span> TimeSpan(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, busEstimateInfo.EstimateTime).Minutes;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 取得台北時區的目前時間，並和預估秒數計算出預估抵達時間</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> timeZone = TimeZoneInfo.FindSystemTimeZoneById(<span style="color:#e6db74">&#34;Taipei Standard Time&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> convertedTime = TimeZoneInfo.ConvertTime(DateTime.UtcNow, timeZone);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> estimateTime = convertedTime.AddSeconds(busEstimateInfo.EstimateTime).ToString(<span style="color:#e6db74">&#34;HH:mm&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> message = <span style="color:#e6db74">$&#34;您追蹤的公車 {busEstimateInfo.RouteName.Zh_tw} 將在 {estimateMin} 分鐘後（{estimateTime}）抵達 {busEstimateInfo.StopName.Zh_tw}&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> SendLineNotify(message);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>這邊要特別注意取得時間的部份，因為在伺服器的時間會是 UTC+0，因此我們這邊使用 <code>TimeZoneInfo.ConvertTime</code> 轉換成台北時區的時間。</p>
<blockquote>
<p>註：像這種丟到雲端平台的服務，會時常遇到時區時間的轉換。單純的時間轉換可以參照之前筆記的 <a href="https://igouist.github.io/post/2020/08/csharp-timezone/">C#: 時區轉換、民國西元、國曆農曆、中文月份週期</a></p>
<p>或是可以嘗試更優雅的 DateTimeOffset，請參考 <a href="https://demo.tc/post/%E9%82%84%E5%9C%A8%E7%94%A8%20DateTime%20%E5%97%8E%EF%BC%9F%E8%A9%A6%E8%A9%A6%20DateTimeOffset%20%E5%90%A7">還在用 DateTime 嗎？試試 DateTimeOffset 吧 - demo小鋪</a></p></blockquote>
<p>現在我們已經將前面撰寫的兩個小方法組裝起來，是時候來測試看看了！</p>
<h3 id="本機測試-functions">本機測試 Functions</h3>
<p>總之，啟動鍵先用力給它按下去：</p>
<p>


<img
  src="https://image.igouist.net/1U9G9IP.webp"
  alt="Image"width="154" height="34"loading="auto" decoding="async">
</p>
<p>接著就會看到小黑窗跑起來，告訴你已經啟動了哪些 Functions：</p>
<p>


<img
  src="https://image.igouist.net/DCiEz7z.webp"
  alt="Image"width="840" height="540"loading="auto" decoding="async">
</p>
<p>可以看到我們的 Http Trigger 以及 Timer Trigger</p>
<p>因為我們的 Http Trigger 有支援 GET，所以這邊直接複製 Api 網址丟到瀏覽器打看看就可以試囉：</p>
<p>


<img
  src="https://image.igouist.net/oJjtbAg.webp"
  alt="Image"width="399" height="135"loading="auto" decoding="async">
</p>
<p>


<img
  src="https://image.igouist.net/mcji7B5.webp"
  alt="Image"width="709" height="116"loading="auto" decoding="async">
</p>
<p>這時候小黑窗也會記錄到這次呼叫：</p>
<p>


<img
  src="https://image.igouist.net/yENwGQm.webp"
  alt="Image"width="841" height="540"loading="auto" decoding="async">
</p>
<p>看起來運行良好，該放上 Azure 上啦！</p>
<blockquote>
<p>補充：在 Azure 上要看小黑窗的話，可以從左邊選單找到「監視 &gt; 紀錄資料流」：



<img
  src="https://image.igouist.net/PPonKeW.webp"
  alt="Image"width="901" height="604"loading="auto" decoding="async">
</p></blockquote>
<h2 id="使用-visual-studio-發佈到-azure-functions">使用 Visual Studio 發佈到 Azure Functions</h2>
<p>現在讓我們把寫好的 Functions 佈到前面申請的 Azure Functions 服務上運行。為了方便這邊就使用 Visual Studio 來示範，首先讓我們對專案點選發佈：</p>
<p>


<img
  src="https://image.igouist.net/I99j6Ul.webp"
  alt="Image"width="621" height="334"loading="auto" decoding="async">
</p>
<p>接著選取發佈目標，我們想要發到 Azure 雲端上：</p>
<p>


<img
  src="https://image.igouist.net/1Kh4BNi.webp"
  alt="Image"width="804" height="564"loading="auto" decoding="async">
</p>
<p>接著會讓我們選擇目標，因為我們前面建立時的作業系統是選用建議的 Windows，因此選擇 Azure Functions (Windows)：</p>
<p>


<img
  src="https://image.igouist.net/2uslDph.webp"
  alt="Image"width="804" height="564"loading="auto" decoding="async">
</p>
<p>接著就可以選取符合條件的 Azure Functions，這邊當然是選擇我們前面建立好的「林北ㄟ Functions」</p>
<p>


<img
  src="https://image.igouist.net/7bMyFxY.webp"
  alt="Image"width="804" height="564"loading="auto" decoding="async">
</p>
<blockquote>
<p>註：如果先前沒有建立過 Azure Functions 服務，發佈的時候也可以從 Visual Studio 中建立，可以說是相當貼心：</p>
<p>


<img
  src="https://image.igouist.net/PWQvV8K.webp"
  alt="Image"width="229" height="61"loading="auto" decoding="async">
</p></blockquote>
<p>按下完成之後，我們的發佈檔就建立完囉！</p>
<p>


<img
  src="https://image.igouist.net/eOyR58Z.webp"
  alt="Image"width="1013" height="715"loading="auto" decoding="async">
</p>
<p>這邊要特別注意的是，我們先前有在 <code>local.settings.json</code> 加入一些設定值，例如 BusTracker 的公車路線等設定。因此我們這邊可以順手同步到目標服務上，在裝載的右上角點開「管理 Azure App Service 設定」：</p>
<p>


<img
  src="https://image.igouist.net/ojWSenU.webp"
  alt="Image"width="1066" height="376"loading="auto" decoding="async">
</p>
<p>就可以看到我們目前在 Local 的組態設定值，以及 Azure 服務裡的組態設定值。這邊為了將 Local 的設定值同步上去，就直接按下「插入本機的值」：</p>
<p>


<img
  src="https://image.igouist.net/zxCxX9z.webp"
  alt="Image"width="600" height="450"loading="auto" decoding="async">
</p>
<blockquote>
<p>註：按下「插入本機的值」並確定後，設定值就會同步到 Azure Functions 服務的組態中：</p>
<p>


<img
  src="https://image.igouist.net/750ONx8.webp"
  alt="Image"width="975" height="808"loading="auto" decoding="async">
</p>
<p>反過來說，如果沒有從本機同步上去，而是在 Azure 上設定組態也是完全 OK 的</p></blockquote>
<p>現在一切就緒，讓我們按下發佈吧！</p>
<p>


<img
  src="https://image.igouist.net/KMZYA70.webp"
  alt="Image"width="1031" height="534"loading="auto" decoding="async">
</p>
<p>接著就可以看到我們撰寫的 Functions 被發佈上去，並且幫我們重啟了 Azure Functions 服務：</p>
<p>


<img
  src="https://image.igouist.net/OImQVyw.webp"
  alt="Image"width="606" height="151"loading="auto" decoding="async">
</p>
<p>現在讓我們回到 Azure Functions 服務的函式看看：</p>
<p>


<img
  src="https://image.igouist.net/ux7MrMs.webp"
  alt="Image"width="940" height="435"loading="auto" decoding="async">
</p>
<p>可以確認我們撰寫的 Functions 已經出現囉！</p>
<p>回到概觀來複製一下我們 Azure Functions 的 Url：</p>
<p>


<img
  src="https://image.igouist.net/FsFomcm.webp"
  alt="Image"width="1554" height="380"loading="auto" decoding="async">
</p>
<p>並且加上我們的 HttpTrigger 路由 <code>api/BusReminder</code> 呼叫看看：</p>
<p>


<img
  src="https://image.igouist.net/HQQVi1t.webp"
  alt="Image"width="609" height="137"loading="auto" decoding="async">
</p>
<p>


<img
  src="https://image.igouist.net/3O0rAbZ.webp"
  alt="Image"width="709" height="116"loading="auto" decoding="async">
</p>
<p>大功告成！</p>
<h2 id="小結">小結</h2>
<p>終於把這個小提醒給上雲啦！唉呀不得不說 Azure Functions 真是香。</p>
<p>接下來只要下班前收到公車到站通知，然後在公車來之前下班就可以啦！</p>
<p>……只要在公車來之前下班，就可以……吧？</p>
<h2 id="參考資料">參考資料</h2>
<ul>
<li>公司前輩的 Azure Functions 範例</li>
<li><a href="https://ithelp.ithome.com.tw/articles/10202960">Azure Functions ⚡ 介紹及Serverless入門輕鬆學 - iT 邦幫忙</a></li>
<li><a href="https://dotblogs.com.tw/armycoding/2019/03/02/155945">使用 Azure Function 輕易打造屬於自己的Web API | 工程良田的小球場 - 點部落 (dotblogs.com.tw)</a></li>
<li><a href="https://mybaseball52.medium.com/build-a-function-app-732eecec39a1">建立一個 function App. 使用 Azure Functions | by (KJH) Kuan-Jung, Huang | Medium</a></li>
<li><a href="https://markheath.net/post/azure-functions-isolated">Is it time to start creating C# Azure Functions in isolated mode? (markheath.net)</a></li>
<li><a href="https://techcommunity.microsoft.com/t5/apps-on-azure-blog/net-on-azure-functions-roadmap/ba-p/2197916">.NET on Azure Functions Roadmap - Microsoft Tech Community</a></li>
</ul>
                            <hr/>
                        </div>

                        

<div class="post-archive">
    <h2>其他文章</h2>
    <ul class="listing">
        
        <li><a href="/post/2022/09/bus-reminder-1-powershell-and-windows-task-scheduler/">使用 Powershell &#43; 工作排程器 &#43; Line Notify 來定時提醒公車到站時間</a></li>
        
        <li><a href="/post/2022/08/azure-function-servicebus-trigger-max-auto-renew-duration/">菜雞抓蟲：Azure Functions ServiceBus Trigger 執行過久時會重複觸發 Functions</a></li>
        
        <li><a href="/post/2020/04/bandon-3-line-notify/">我要訂便當 (3): 用 Python &#43; Line Notify 傳送通知</a></li>
        
        <li><a href="/post/2022/08/azure-service-bus/">使用 Azure Service Bus 來建立簡單的訊息佇列（Message Queue）吧</a></li>
        
    </ul>
</div>


                        <div class="post-meta meta-tags">
                            
                            <ul class="clearfix">
                                
                                <li><a href="https://igouist.github.io/tags/azure">azure</a></li>
                                
                                <li><a href="https://igouist.github.io/tags/azure-functions">azure-functions</a></li>
                                
                                <li><a href="https://igouist.github.io/tags/line-notify">line-notify</a></li>
                                
                                <li><a href="https://igouist.github.io/tags/line">line</a></li>
                                
                            </ul>
                            
                        </div>
                    </article>
                    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "Igouist/Igouist.github.io"
            issue-term="pathname"
            theme="github-dark"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
                </div>
            </div>
            <div id="secondary">
    <section class="widget">
        <form id="search" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://igouist.github.io/">
      <button type="submit" class="submit">&#x1F50E;&#xFE0E;</button>
</form>
    </section>
    
    
        <section class="widget">
            <h3 class="widget-title">文章目錄</h3>
            <ul class="widget-list">
                <nav id="TableOfContents">
  <ul>
    <li><a href="#建立-azure-functions-資源">建立 Azure Functions 資源</a></li>
    <li><a href="#使用-azure-functions-開發公車到站提醒服務">使用 Azure Functions 開發公車到站提醒服務</a>
      <ul>
        <li><a href="#建立-azure-funtcions-專案">建立 Azure Funtcions 專案</a></li>
        <li><a href="#呼叫-motc-api-查詢公車到站預估時間">呼叫 MOTC Api 查詢公車到站預估時間</a></li>
        <li><a href="#發送-line-notify">發送 Line Notify</a></li>
        <li><a href="#組合查詢公車資訊與發送到站通知">組合查詢公車資訊與發送到站通知</a></li>
        <li><a href="#本機測試-functions">本機測試 Functions</a></li>
      </ul>
    </li>
    <li><a href="#使用-visual-studio-發佈到-azure-functions">使用 Visual Studio 發佈到 Azure Functions</a></li>
    <li><a href="#小結">小結</a></li>
    <li><a href="#參考資料">參考資料</a></li>
  </ul>
</nav>
            </ul>
        </section>
    
    
    <section class="widget">
        <h3 class="widget-title">系列文</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://igouist.github.io/series/%E6%88%91%E8%A6%81%E8%A8%82%E4%BE%BF%E7%95%B6/">我要訂便當 (5)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/series/%E8%8F%9C%E9%9B%9E%E6%96%B0%E8%A8%93%E8%A8%98/">菜雞新訓記 (8)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/series/%E8%8F%9C%E9%9B%9E%E8%88%87%E7%89%A9%E4%BB%B6%E5%B0%8E%E5%90%91/">菜雞與物件導向 (17)</a>
    </li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <small class="date">2026-02-28</small>
        <a href="https://igouist.github.io/post/2026/02/split-pot-and-srp/" title="鴛鴦鍋就是要分成涮肉區和煮湯區才符合單一職責吧？">鴛鴦鍋就是要分成涮肉區和煮湯區才符合單一職責吧？</a>
    </li>
    
    <li>
        <small class="date">2026-02-24</small>
        <a href="https://igouist.github.io/post/2026/02/automapper-flattening/" title="菜雞抓蟲：AutoMapper 出現奇怪的型別對應錯誤嗎？貼心的慣例式映射可能正在造訪你家">菜雞抓蟲：AutoMapper 出現奇怪的型別對應錯誤嗎？貼心的慣例式映射可能正在造訪你家</a>
    </li>
    
    <li>
        <small class="date">2026-01-31</small>
        <a href="https://igouist.github.io/post/2026/01/heptabase/" title="從紙筆到電子白板，我的 Heptabase 使用場景">從紙筆到電子白板，我的 Heptabase 使用場景</a>
    </li>
    
    <li>
        <small class="date">2025-07-31</small>
        <a href="https://igouist.github.io/post/2025/07/migrate-blog-images-to-cloudflare-r2/" title="記一次把部落格圖片從 Imgur 搬到 Cloudflare R2 的過程">記一次把部落格圖片從 Imgur 搬到 Cloudflare R2 的過程</a>
    </li>
    
    <li>
        <small class="date">2025-07-07</small>
        <a href="https://igouist.github.io/post/2025/07/dotnet-add-watermark-and-password-to-pdf-using-pdfsharp/" title="C#: 使用 PDFSharp 在 PDF 加上浮水印和檔案密碼吧">C#: 使用 PDFSharp 在 PDF 加上浮水印和檔案密碼吧</a>
    </li>
    
    <li>
        <small class="date">2025-06-29</small>
        <a href="https://igouist.github.io/post/2025/06/dotnet-using-iservicecollection-extensions-to-enforce-registration-constraints/" title=".Net: 善用 IServiceCollection Extension 和自製 Builder，讓服務註冊更有約束吧">.Net: 善用 IServiceCollection Extension 和自製 Builder，讓服務註冊更有約束吧</a>
    </li>
    
    <li>
        <small class="date">2025-06-14</small>
        <a href="https://igouist.github.io/post/2025/06/imgur-temporarily-over-capacity-maybe-your-ip-banned/" title="Imgur 一直 temporarily over capacity 嗎？先檢查網路看看吧">Imgur 一直 temporarily over capacity 嗎？先檢查網路看看吧</a>
    </li>
    
    <li>
        <small class="date">2025-06-14</small>
        <a href="https://igouist.github.io/post/2025/06/disable-onedrive-sync-and-restore-documents-folder/" title="Windows: 關閉 OneDrive 同步，並把我的文件移回預設路徑">Windows: 關閉 OneDrive 同步，並把我的文件移回預設路徑</a>
    </li>
    
    <li>
        <small class="date">2025-05-05</small>
        <a href="https://igouist.github.io/post/2025/05/csharp-convert-html-to-pdf-using-dinktopdf/" title="C#: 使用 DinkToPdf 把 HTML 轉成 PDF 吧">C#: 使用 DinkToPdf 把 HTML 轉成 PDF 吧</a>
    </li>
    
    <li>
        <small class="date">2025-04-27</small>
        <a href="https://igouist.github.io/post/2025/04/shin-sangoku-musou-origins/" title="《真三國無雙：起源》白金心得">《真三國無雙：起源》白金心得</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        

<h3 class="widget-title"><a href="https://igouist.github.io/timeline/">最近動態</a></h3>
<ul class="widget-list timeline-widget">
  
    
    <li>
      <small class="date">2026-02-24</small>
      <a href="https://igouist.github.io/timeline/#t-1771938000">
        
        
        
          溫柔貼心的好鄰居：AutoMapper
        
      </a>
    </li>
  
    
    <li>
      <small class="date">2026-02-15</small>
      <a href="https://igouist.github.io/timeline/#t-1771139400">
        
        
        
          部落格與霞鶩文楷
        
      </a>
    </li>
  
    
    <li>
      <small class="date">2026-01-29</small>
      <a href="https://igouist.github.io/timeline/#t-1769698800">
        
        
        
          特定知識與創造力
        
      </a>
    </li>
  
    
    <li>
      <small class="date">2026-01-26</small>
      <a href="https://igouist.github.io/timeline/#t-1769432400">
        
        
        
          《真三國無雙：起源》四英傑 DLC 劇情初通關心得
        
      </a>
    </li>
  
    
    <li>
      <small class="date">2026-01-06</small>
      <a href="https://igouist.github.io/timeline/#t-1767668400">
        
        
        
          陷阱街道
        
      </a>
    </li>
  
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title">轉貼推薦</h3>
<ul class="widget-list">    
    
    <li>
        <a href="https://igouist.github.io/repost/">每天推薦一篇文章 (101)</a>
    </li>
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title">分類</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://igouist.github.io/categories/android/">android (1)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/categories/automation/">automation (3)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/categories/azure/">azure (3)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/categories/bug/">bug (5)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/categories/csharp-and-dotnet/">csharp-and-dotnet (35)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/categories/css/">css (1)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/categories/explore/">explore (3)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/categories/ide/">ide (5)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/categories/life/">life (10)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/categories/murmur/">murmur (2)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/categories/object-oriented/">object-oriented (17)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/categories/powershell/">powershell (2)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/categories/python/">python (7)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/categories/reading/">reading (4)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/categories/tools/">tools (28)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/categories/windows/">windows (3)</a>
    </li>
    
</ul>
    </section>

    
<section class="widget">
    <h3 class="widget-title">友鏈</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="https://sunnyday0932.github.io/" title="Sian">🌙 Sian</a>
        </li>
        
        <li>
            <a target="_blank" href="https://www.facebook.com/arthurc.study" title="arthurc">亞瑟的學習筆記</a>
        </li>
        
        <li>
            <a target="_blank" href="https://kevintsengtw.blogspot.com/" title="mrkt">mrkt 的程式學習筆記</a>
        </li>
        
        <li>
            <a target="_blank" href="https://dddtw.hashnode.dev/" title="DDDTW">DDDTW Technical Blog</a>
        </li>
        
        <li>
            <a target="_blank" href="https://wellss12.github.io/" title="Wells">Wells</a>
        </li>
        
        <li>
            <a target="_blank" href="https://raychiutw.github.io/" title="ray">Ray&#39;s Notes</a>
        </li>
        
        <li>
            <a target="_blank" href="https://andrewliang25.github.io/" title="Andrew">Null Playground</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">標籤</h3>
<div class="tagcloud">
    
    <a href="https://igouist.github.io/tags/ai-tools/">ai-tools</a>
    
    <a href="https://igouist.github.io/tags/android/">android</a>
    
    <a href="https://igouist.github.io/tags/anglesharp/">anglesharp</a>
    
    <a href="https://igouist.github.io/tags/api/">api</a>
    
    <a href="https://igouist.github.io/tags/appsettings/">appsettings</a>
    
    <a href="https://igouist.github.io/tags/automapper/">automapper</a>
    
    <a href="https://igouist.github.io/tags/automation/">automation</a>
    
    <a href="https://igouist.github.io/tags/azure/">azure</a>
    
    <a href="https://igouist.github.io/tags/azure-functions/">azure-functions</a>
    
    <a href="https://igouist.github.io/tags/bandon/">bandon</a>
    
    <a href="https://igouist.github.io/tags/benchmarkdotnet/">benchmarkdotnet</a>
    
    <a href="https://igouist.github.io/tags/bug/">bug</a>
    
    <a href="https://igouist.github.io/tags/chrome/">chrome</a>
    
    <a href="https://igouist.github.io/tags/cloudflare/">cloudflare</a>
    
    <a href="https://igouist.github.io/tags/crawler/">crawler</a>
    
    <a href="https://igouist.github.io/tags/csharp/">csharp</a>
    
    <a href="https://igouist.github.io/tags/css/">css</a>
    
    <a href="https://igouist.github.io/tags/dapper/">dapper</a>
    
    <a href="https://igouist.github.io/tags/database/">database</a>
    
    <a href="https://igouist.github.io/tags/dotnet/">dotnet</a>
    
    <a href="https://igouist.github.io/tags/electron/">electron</a>
    
    <a href="https://igouist.github.io/tags/entity-framework/">entity framework</a>
    
    <a href="https://igouist.github.io/tags/enum/">enum</a>
    
    <a href="https://igouist.github.io/tags/excel/">excel</a>
    
    <a href="https://igouist.github.io/tags/game/">game</a>
    
    <a href="https://igouist.github.io/tags/git/">git</a>
    
    <a href="https://igouist.github.io/tags/headphone/">headphone</a>
    
    <a href="https://igouist.github.io/tags/heptabase/">heptabase</a>
    
    <a href="https://igouist.github.io/tags/heroku/">heroku</a>
    
    <a href="https://igouist.github.io/tags/ide/">ide</a>
    
    <a href="https://igouist.github.io/tags/imgur/">imgur</a>
    
    <a href="https://igouist.github.io/tags/life/">life</a>
    
    <a href="https://igouist.github.io/tags/line/">line</a>
    
    <a href="https://igouist.github.io/tags/line-notify/">line-notify</a>
    
    <a href="https://igouist.github.io/tags/linux/">linux</a>
    
    <a href="https://igouist.github.io/tags/markdown/">markdown</a>
    
    <a href="https://igouist.github.io/tags/midjourney/">midjourney</a>
    
    <a href="https://igouist.github.io/tags/mysql/">mysql</a>
    
    <a href="https://igouist.github.io/tags/newbieguide/">newbieguide</a>
    
    <a href="https://igouist.github.io/tags/object-oriented/">object-oriented</a>
    
    <a href="https://igouist.github.io/tags/one-drive/">one-drive</a>
    
    <a href="https://igouist.github.io/tags/pdf/">pdf</a>
    
    <a href="https://igouist.github.io/tags/php/">php</a>
    
    <a href="https://igouist.github.io/tags/powershell/">powershell</a>
    
    <a href="https://igouist.github.io/tags/ptt/">ptt</a>
    
    <a href="https://igouist.github.io/tags/python/">python</a>
    
    <a href="https://igouist.github.io/tags/queue/">queue</a>
    
    <a href="https://igouist.github.io/tags/reading/">reading</a>
    
    <a href="https://igouist.github.io/tags/rrs/">rrs</a>
    
    <a href="https://igouist.github.io/tags/rss/">rss</a>
    
    <a href="https://igouist.github.io/tags/selenium/">selenium</a>
    
    <a href="https://igouist.github.io/tags/service-bus/">service-bus</a>
    
    <a href="https://igouist.github.io/tags/soft-skills/">soft-skills</a>
    
    <a href="https://igouist.github.io/tags/sqlite/">sqlite</a>
    
    <a href="https://igouist.github.io/tags/swagger/">swagger</a>
    
    <a href="https://igouist.github.io/tags/tools/">tools</a>
    
    <a href="https://igouist.github.io/tags/travel/">travel</a>
    
    <a href="https://igouist.github.io/tags/visualstudio/">visualstudio</a>
    
    <a href="https://igouist.github.io/tags/vscode/">vscode</a>
    
    <a href="https://igouist.github.io/tags/w3hexschool/">w3hexschool</a>
    
    <a href="https://igouist.github.io/tags/windows/">windows</a>
    
    <a href="https://igouist.github.io/tags/xampp/">xampp</a>
    
</div>
    </section>

    <section class="widget">
    <h3 class="widget-title">統計資訊</h3>
    <ul class="widget-list">
        <li>文章總數：110</li>

        
        <li>瀏覽次數：<span id="vercount_value_site_pv">-</span></li>
        

        <li>本站訂閱：<a href="https://igouist.github.io/index.xml" target="_blank"><u>RSS</u> (index.xml)</a></li>

        
        <li>本文字數：6918</li>
        

        

        
        
        
    </ul>
</section>

    <section class="widget">
    <h3 class="widget-title">工商服務</h3>
    <ul class="widget-list">

        
        <a href="https://www.facebook.com/@DDDCommunity.tw/"><img src="https://i.imgur.com/5ItLxex.png" alt="DDDTaiwan" style="width:245px;height:auto;"></a>
        <br/>

        
        
        

        
        <script async 
            src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2119949858103459"
            crossorigin="anonymous"></script>
        <ins class="adsbygoogle"
            style="display:block"
            data-ad-client="ca-pub-2119949858103459"
            data-ad-slot="9031038367"
            data-ad-format="auto"
            data-full-width-responsive="true"></ins>
        <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
    </ul>
</section>

</div>
        </div>
    </div>
</div>
<footer id="footer">
    <div class="container">
        &copy; 2019-2025 <a href="https://igouist.github.io/">伊果的沒人看筆記本 By Igouist</a>.
        Powered by <a rel="nofollow noreferer noopener" href="https://gohugo.io" target="_blank">Hugo</a>.
        <a href="https://www.flysnow.org/" target="_blank">Theme</a> based on <a href="https://github.com/rujews/maupassant-hugo" target="_blank">maupassant</a>.
        
    </div>
</footer>


    <script type="text/javascript">
    
    (function(){
        
    }())

    window.MathJax = {
        tex2jax: {
            inlineMath: [ ['$','$'] ],
            processEscapes: true
        }
    };
    </script>
    <script type="text/javascript" src="/js/prism.js" async="true"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src="/js/totop.js?v=0.0.0" async=""></script>



<script defer src="https://events.vercount.one/js"></script>





<script type='text/javascript'>
    window.onload = function() {
      var links = document.links;
      for (var i = 0, linksLength = links.length; i < linksLength; i++) {
        if (links[i].hostname != window.location.hostname) {
          links[i].target = '_blank';
        }
      }
    }
  </script>
</body>
</html>
