<!doctype html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="utf-8">
    
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-92586970-4"></script>
    <script async>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-92586970-4');
    </script>

    <meta name="generator" content="Hugo 0.74.3" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <title>菜雞新訓記 (5): 使用 三層式架構 來切分服務的關注點和職責吧 | 伊果的沒人看筆記本</title>
    <meta property="og:title" content="菜雞新訓記 (5): 使用 三層式架構 來切分服務的關注點和職責吧 - 伊果的沒人看筆記本">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content="2021-10-03T14:00:00&#43;08:00">
        
        
    <meta property="article:modified_time" content="2021-10-03T14:00:00&#43;08:00">
        
        <meta name="keywords" content="三層式架構, 3-Layer Architecture, Service, Repository, dotnet core, web api">
    <meta name="description" content="這是俺整理公司新訓內容的第五篇文章，目標是使用三層式架構 (3-Layer Architecture) 來切分服務的關注點和職責；三層式架構顧名思義就是把應用程式分成三層，一般的分法是分成「展示層、商業邏輯層、資料存取層」，本篇將逐步說明三層式架構的優點和前提，以及實際實作一次分層流程">
        <meta name="author" content="Igouist">
        
    <meta property="og:url" content="https://igouist.github.io/post/2021/10/newbie-5-3-layer-architecture/">
    <link defer rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

    <link defer rel="stylesheet" href="/css/normalize.css">
    
        <link defer rel="stylesheet" href="/css/prism.css">
    
    <link defer rel="stylesheet" href="/css/style.css">
    <script async type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    
    <script data-ad-client="ca-pub-2119949858103459" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script async>
    (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "[map[]]",
        enable_page_level_ads: true
    });
    </script>
    


    
    
</head>

<body>
<header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://igouist.github.io/">
                        伊果的沒人看筆記本
                    </a>
                
                <p class="description">菜雞寫筆記，踩坑全紀錄</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://igouist.github.io/">Home</a>
                    
                    <a  href="https://igouist.github.io/categories/reading/" title="Reading">Reading</a>
                    
                    <a  href="https://igouist.github.io/categories/python/" title="Python">Python</a>
                    
                    <a  href="https://igouist.github.io/categories/csharp-and-dotnet/" title="CSharp">CSharp</a>
                    
                    <a  href="https://igouist.github.io/archives/" title="Archives">Archives</a>
                    
                    <a  href="https://igouist.github.io/about/" title="About">About</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>


<div id="body">
    <div class="container">
        <div class="col-group">

            <div class="col-8" id="main">
                <div class="res-cons">
                    <article class="post">
                        <header>
                            <h1 class="post-title">菜雞新訓記 (5): 使用 三層式架構 來切分服務的關注點和職責吧</h1>
                        </header>
                        <date class="post-meta meta-date">
                            2021-10-3,
                        </date>
                        
                        <div class="post-meta">
                            
                                <span class="meta-category"><a href="https://igouist.github.io/categories/csharp-and-dotnet">CSharp-and-Dotnet</a></span>
                            
                        </div>
                        
                        
                        <div class="post-meta">(
                            <span id="busuanzi_container_page_pv">
                                <span id="busuanzi_value_page_pv">?</span>
                                <span>&nbsp;read</span>
                            </span>)
                        </div>
                        
                        <div class="post-content">
                            <p><img src="https://i.imgur.com/S72H7sA.png" alt="img"></p>
<p>這是俺整理公司新訓內容的第五篇文章，目標是<strong>使用三層式架構 (3-Layer Architecture) 來切分服務的關注點和職責</strong>。</p>
<ul>
<li><a href="/post/2021/10/newbie-5-3-layer-architecture#%E4%BB%80%E9%BA%BC%E6%98%AF%E5%88%86%E5%B1%A4%E5%88%86%E5%B1%A4%E5%8F%AF%E4%BB%A5%E5%90%83%E5%97%8E">什麼是分層？分層可以吃嗎？</a>
<ul>
<li><a href="/post/2021/10/newbie-5-3-layer-architecture#%E4%B8%89%E5%B1%A4%E5%BC%8F%E6%9E%B6%E6%A7%8B">三層式架構</a></li>
<li><a href="/post/2021/10/newbie-5-3-layer-architecture#%E9%97%9C%E6%96%BC-dto">關於 DTO</a></li>
<li><a href="/post/2021/10/newbie-5-3-layer-architecture#%E7%82%BA%E4%BB%80%E9%BA%BC%E6%88%91%E5%80%91%E9%9C%80%E8%A6%81%E5%88%86%E5%B1%A4%E6%9E%B6%E6%A7%8B">為什麼我們需要分層架構？</a></li>
<li><a href="/post/2021/10/newbie-5-3-layer-architecture#%E6%9C%AC%E7%AF%80%E7%9A%84%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99">本節的參考資料</a></li>
</ul>
</li>
<li><a href="/post/2021/10/newbie-5-3-layer-architecture#%E5%AF%A6%E4%BD%9C">實作</a>
<ul>
<li><a href="/post/2021/10/newbie-5-3-layer-architecture#%E5%AF%A6%E4%BD%9C%E7%AF%84%E4%BE%8B%E7%9A%84%E6%9E%B6%E6%A7%8B%E8%88%87%E5%89%8D%E8%A8%80">實作範例的架構與前言</a></li>
<li><a href="/post/2021/10/newbie-5-3-layer-architecture#%E5%A4%A7%E8%87%B4%E4%B8%8A%E7%9A%84%E6%AD%A5%E9%A9%9F">大致上的步驟</a></li>
<li><a href="/post/2021/10/newbie-5-3-layer-architecture#%E7%AF%84%E4%BE%8B%E5%B0%88%E6%A1%88%E8%83%8C%E6%99%AF">範例專案背景</a></li>
<li><a href="/post/2021/10/newbie-5-3-layer-architecture#%E5%BB%BA%E7%AB%8B%E5%88%86%E5%B1%A4">建立分層</a></li>
<li><a href="/post/2021/10/newbie-5-3-layer-architecture#%E5%8A%A0%E5%85%A5%E5%8F%83%E8%80%83">加入參考</a></li>
<li><a href="/post/2021/10/newbie-5-3-layer-architecture#%E5%BB%BA%E7%AB%8B%E4%BB%8B%E9%9D%A2%E8%88%87-dto">建立介面與 DTO</a></li>
<li><a href="/post/2021/10/newbie-5-3-layer-architecture#%E5%AF%A6%E4%BD%9C-repository">實作 Repository</a></li>
<li><a href="/post/2021/10/newbie-5-3-layer-architecture#%E5%AF%A6%E4%BD%9C-service">實作 Service</a></li>
<li><a href="/post/2021/10/newbie-5-3-layer-architecture#%E5%AF%A6%E4%BD%9C-controller">實作 Controller</a></li>
</ul>
</li>
<li><a href="/post/2021/10/newbie-5-3-layer-architecture#%E8%87%AA%E5%95%8F%E8%87%AA%E7%AD%94%E5%BF%83%E5%BE%97%E7%AF%87">自問自答心得篇</a>
<ul>
<li><a href="/post/2021/10/newbie-5-3-layer-architecture#%E9%97%9C%E6%96%BC%E9%87%8D%E8%A4%87%E5%BB%BA%E7%AB%8B-dto-%E7%9A%84%E5%95%8F%E9%A1%8C">關於重複建立 DTO 的問題</a></li>
<li><a href="/post/2021/10/newbie-5-3-layer-architecture#%E4%B8%89%E5%B1%A4%E5%BC%8F%E6%9E%B6%E6%A7%8B%E8%B7%9F-mvc-%E4%B8%80%E6%A8%A3%E5%97%8E">三層式架構跟 MVC 一樣嗎？</a></li>
<li><a href="/post/2021/10/newbie-5-3-layer-architecture#service-%E5%8F%AF%E4%BB%A5%E4%BE%9D%E8%B3%B4-service-%E5%97%8E">Service 可以依賴 Service 嗎？</a></li>
</ul>
</li>
<li><a href="/post/2021/10/newbie-5-3-layer-architecture#%E5%B0%8F%E7%B5%90">小結</a></li>
<li><a href="/post/2021/10/newbie-5-3-layer-architecture#%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99">參考資料</a></li>
<li><a href="/post/2021/10/newbie-5-3-layer-architecture#%E6%9C%AC%E7%B3%BB%E5%88%97%E6%96%87%E7%AB%A0">本系列文章</a></li>
</ul>
<h2 id="什麼是分層分層可以吃嗎">什麼是分層？分層可以吃嗎？</h2>
<blockquote>
<p>天地混沌如雞子，商業邏輯生其中。</p>
<p>萬八千歲，天地開闢。表現層為天。資料層為地。商業邏輯層在其中……</p>
<p>　　　　－－民明書坊《盤古與他的CRUD之旅》</p>
</blockquote>
<p>根據民明書坊的文獻記載，我們常聽到的「天地玄黃，宇宙洪荒」云云，其實指的就是上古時期的開發狀況。當時世界還是一片混沌，所有的程式碼都混雜成一坨，不是所有東西寫在一起你儂我儂，一言不合就三千行；就是依賴關係交錯複雜，改了北極壞南極。</p>
<p>要說有多亂呢，大概就算前人嘗試引入了 MVC，也只是改成把所有程式都塞在 Controller 而已，其絕望程度可見一斑。</p>
<p>這時候隔壁課的老盤調過來接刀，一看不得了，便決定先對這屎山整頓一番。他大喝一聲，那些靠近使用者的便上浮起來化作了天，親近資料庫的便沉澱下去變成了地，而所有的商業邏輯就連接著兩者，支撐起了整個專案。這也就是分層架構的由來。</p>
<p>一般來說，最常見的分層架構就是<strong>三層式架構</strong>了。</p>
<h3 id="三層式架構">三層式架構</h3>
<blockquote>
<p>分層架構是運用最為廣泛的架構模式，幾乎每個軟體系統都需要通過層（Layer）來隔離不同的關注點（Concern Point），以此應對不同需求的變化，使得這種變化可以獨立進行；此外，分層架構模式還是隔離業務複雜度與技術複雜度的利器。 －－ <a href="https://raychiutw.github.io/2019/%E9%9A%A8%E6%89%8B-Design-Pattern-2-%E8%BB%9F%E9%AB%94%E5%88%86%E5%B1%A4%E8%A8%AD%E8%A8%88%E6%A8%A1%E5%BC%8F-Software-Layered-Architecture-Pattern/">Ray&rsquo;s Notes</a></p>
</blockquote>
<p>三層式架構顧名思義就是把應用程式分成三層，一般的分法是分成「<strong>展示層、商業邏輯層、資料存取層</strong>」。</p>
<p><img src="https://i.imgur.com/RxSrWJm.jpg" alt="分層架構01"></p>
<p>現在讓我們認識一些他們的分工：</p>
<ul>
<li><strong>展示層（Presentation Layer）</strong>
<ul>
<li>咱們軟體的門面。<strong>負責搞定需要跟外部使用者互動的部份</strong>，例如接收使用者的請求、路由的控制、呼叫的流程控制等等</li>
<li>日常工作就是確實地接收使用者的請求，然後叫商業邏輯層去處理，最後把商業邏輯層弄好的東西奉上給使用者</li>
<li>大多時候的開發會在 <code>Controller</code> 進行，例如 <code>ProductController</code></li>
</ul>
</li>
<li><strong>商業邏輯層（Business Layer）</strong>
<ul>
<li>咱們軟體的核心。<strong>負責處理商業邏輯</strong>，也就是商業規則和相關的邏輯處理都在這裡進行</li>
<li>日常工作就是接收展示層的呼叫、和資料存取層拿資料。在這個來往的過程中將資料內容進行商業邏輯的處理</li>
<li>常見的後綴有 <code>BLL</code>, <code>Service</code> 等等，例如 <code>ProductService</code></li>
</ul>
</li>
<li><strong>資料存取層（Data Layer）</strong>
<ul>
<li>顧名思義，就是<strong>負責存取資料的相關操作</strong></li>
<li>日常工作就是根據商業邏輯層的要求，去資料庫存取資料</li>
<li>常見的後綴有 <code>DAL</code>, <code>Repository</code> 等等，例如 <code>ProductRepository</code></li>
</ul>
</li>
</ul>
<p>另外一些比較中大型的架構會把共用的部份抽出來，就會多一層：</p>
<ul>
<li><strong>共用層（Common Layer）</strong>
<ul>
<li>負責放一些<strong>各層之間會共用到的工具</strong>。例如擴充方法、列舉等等</li>
<li>因為是用來放各種工具的，所以需要分離出一層，來讓各層都可以使用</li>
</ul>
</li>
</ul>
<p>用最常見的餐廳來比喻的話，資料庫大概就像是存放食材的冰箱、其他服務的ＡＰＩ就像是供應商之類的，各層的分工就會像這樣：</p>
<ul>
<li>資料層：負責採買食材、去冰箱拿食材等等</li>
<li>業務層：根據各式各樣的食譜把食材變成料理</li>
<li>展示層：負責櫃台的點餐，將做好的料理呈上給客人</li>
</ul>
<p>對這種過於模糊的比喻不太能理解的朋友，假設今天某網站的管理後台有個查詢某客戶的請求，可能會是這樣子：</p>
<ol>
<li>展示層 收到使用者查詢客戶的請求
<ul>
<li>ex: <code>GET Cust/1</code> -&gt; <code>CustController.Get(int custId)</code></li>
</ul>
</li>
<li>展示層 檢查是否登入和權限 ex: <code>[Authorize(Roles = UserRole.Admin)]</code></li>
<li>展示層 呼叫商業邏輯層查詢客戶 ex: <code>CustService.Get(int custId)</code></li>
<li>商業邏輯層 呼叫資料存取層查詢客戶 ex: <code>CustRepository.Get(int custId)</code></li>
<li>資料存取層 從 <code>Cust</code> 資料表取回資料</li>
<li>商業邏輯層 繼續執行，發現有「查詢客戶時需同時列出該客戶五筆最近訂單簡介」的規則
<ul>
<li><del>別問為什麼，問就是 Feature</del></li>
</ul>
</li>
<li>商業邏輯層 呼叫資料存取層
<ul>
<li>ex: <code>OrderRepository.GetLast(int custId, int count = 5)</code></li>
</ul>
</li>
<li>資料存取層 從 <code>Order</code> 資料表取回資料</li>
<li>商業邏輯層 根據規則組裝資料，回傳給展示層</li>
<li>展示層 取得商業邏輯層回覆的資料，回傳給使用者</li>
</ol>
<p>大概就是這種感覺。</p>
<p><img src="https://i.imgur.com/GF7cF9f.jpg" alt="分層架構02" style="zoom:33%;" /></p>
<p>當然，這邊還是要再提醒一下：分層架構並不是只有三層式架構，根據需求也可能會再增加或是減少。同樣地，<strong>分層架構只是一種「分工的概念」</strong>，並不是只限於軟體，也不一定得就是這三層。</p>
<p>曾經也有聽過「瀏覽器（展示層）、伺服器（商業邏輯層）、資料庫（資料存取層）」的說法，也看過遊戲是用「整體策略、基本操作」等動作規模去分層的，因此只需要有「把工作依據職責切分到不同層」的概念就可以了，切莫要走火入魔。</p>
<h3 id="關於-dto">關於 DTO</h3>
<p>我們回到上面的例子，可以注意到各層之間必須要頻繁地溝通、傳遞資訊。因此我們就會<strong>需要一些物件來幫忙在各層之間傳遞這些資料</strong>，這些只有資料欄位、沒有任何方法的物件就是 <strong>DTO（Data Transfer Object, 資料傳輸物件）</strong></p>
<p>在分層架構裡面使用 DTO 是絕對必要的，除了層與層之間需要讓資料傳遞之外，也能帶來幾個好處，例如：</p>
<ul>
<li>封裝過多的參數
<ul>
<li>針對參數過多的方法，我們可以收納成 Dto 來隱藏複雜性</li>
<li>封裝前 <code>GetProductList(int custLevel, string custName, int.....)</code></li>
<li>封裝後 <code>GetProductList(GetProductParameter parameter)</code></li>
</ul>
</li>
<li>減少層與層之間的耦合
<ul>
<li>當有修改欄位的時候，有時只需變動 DTO 就可以了</li>
<li>各層之間的溝通使用 Dto 傳輸，可以減少各層直接彼此影響的耦合狀況</li>
</ul>
</li>
</ul>
<p>這裡其實就是<strong>將「資料」和「方法」切割開來封裝</strong>的概念。如果切分得不錯的話，在呼叫的過程就會像是<strong>工廠流水線</strong>的感覺，資料隨著運輸帶到達每個工作區，然後工作區對資料進行處理之後，再送上運輸帶前往下個工作區，經歷了壯闊的旅程（？）之後最後終於到達使用者手上。</p>
<p>不過相對的，每層之間都用 DTO 去通訊、過多的參數封裝成 DTO 等等，都會增加整個系統中的類別數量，有時候甚至會多到畫面上列不下的程度（我的 DTO 就像宇宙一樣！），反而造成管理和修改上的困難。</p>
<p>因此 DTO 的應用場景，例如說是每一層都需要獨立的 DTO 嗎？或是使用同一個 DTO 來操作呢？會不會共用了參數反而造成耦合呢？都要到開發的時候來作取捨。</p>
<p>關於上面這段重複建立 DTO 的問題，我們在最後的 <a href="#%E9%97%9C%E6%96%BC%E9%87%8D%E8%A4%87%E5%BB%BA%E7%AB%8B-dto-%E7%9A%84%E5%95%8F%E9%A1%8C">QA 階段</a> 再稍微聊一下吧，先讓我們把鏡頭轉回分層架構。</p>
<h3 id="為什麼我們需要分層架構">為什麼我們需要分層架構？</h3>
<blockquote>
<p>專案分層架構其目的就是為了要職責確立、關注點分離，讓不同的方法或類別去做該做的事情而且只專注於這些方法、類別的職責上 －－ <a href="https://kevintsengtw.blogspot.com/2012/10/aspnet-mvc-part1.html">mrkt</a></p>
</blockquote>
<p>當我們想知道為什麼要使用分層架構，最快的方式就是了解一下採用分層架構的諸多好處。且讓我數給你聽：</p>
<p><strong>更符合單一職責、關注點分離</strong></p>
<p>也就是我們在單一職責原則篇曾提到的：「把工作交給負責該職責的類別去做，自己只需要關注在自己正在處理的職責即可」。如果一來就可以封裝出邊界、減少彼此耦合影響的機會，也可以減少閱讀大量不相關的程式碼。</p>
<blockquote>
<p>關於單一職責的介紹，和我們著重職責所帶來的好處等等，<br/>可以參閱之前的：<a href="https://igouist.github.io/post/2020/10/oo-10-single-responsibility-principle/">菜雞與物件導向 (10): 單一職責原則</a>。</p>
</blockquote>
<p><strong>快速鎖定目標、縮小範圍</strong></p>
<p>因為關注點分離成多個層（Layer）了，當物件的設計有符合職責的話，在開發或除錯時，甚至能像查詢表格一樣迅速！</p>
<p><img src="https://i.imgur.com/CZ0S51s.jpg" alt="分層架構04"></p>
<p>當分層和類別的定義都合乎職責的時候，在接收到需求的同時也就能抓出目標範圍在哪了，例如：</p>
<ul>
<li>這次針對某功能的一些判斷邏輯有變動 =&gt; OK，先從 Service 開始看</li>
<li>這個資料表的欄位名字被換掉了 =&gt; OK，往 Repository 前進</li>
<li>這個路由可以幫我調整一下嗎 =&gt; OK，Controller 改起來</li>
</ul>
<p>原先你可能要先閱讀一坨又臭又長的程式碼，花一堆時間從裡面找到你要改的地方才能開工。有明確的架構之後，就可以大幅地提升精準度，直接往相應職責的地方去就對了。</p>
<p>因此，乾淨、分工明確的架構可以給你大方向的指引，替你省下許多垃圾時間，對比垃圾探險記來說實在是舒服許多。</p>
<p><strong>適合多人合作、減少碰撞率</strong></p>
<p>因為範圍縮小了，多人合作的時候就可以靈活地去調度、搭配，提升開發時的效率。</p>
<p>例如說讓比較熟悉資料庫的朋友處理資料存取層、負責和 API 使用端商談規格的朋友先在展示層開好 API 接口等等，可以根據狀況從分層或是功能等方向去分工。</p>
<p>並且這樣的分工也能減少碰撞率 ……至少會讓 Git 的衝突少一點囧。</p>
<p><strong>增加程式碼的複用性</strong></p>
<p>最後也是最有感覺的就是增加程式碼的複用性了。在商業邏輯中可能很多地方都會用到其他來源的資料來加工組合，例如查詢客戶的時候要一併列出訂單、推薦商品的時候要附上目前的優惠活動等等。</p>
<p>這時候如果分層明確，一些像是資料存取層中的「查詢訂單」這種簡單又符合單一職責的方法，我們就可以加以取用，靈活組合出目前的需求。</p>
<p>比起到處都把同一段撈資料的 Code 複製貼上複製貼上，然後要修改的時候整個遍地開花的狀況，能夠重複使用實在是舒服許多。</p>
<p>到目前為止這應該是我最有感覺的一項，當你需要撈某個資料出來，發現隊友或是之前的自己已經寫好一個乾淨可用好擴充的 Function 在那邊讓你直接呼叫，那感覺真的是一個爽呀！</p>
<p><strong>提供抽換的靈活度</strong></p>
<p>這一項比較像是前面各項產生的結果。由於我們根據了不同職責卻拆分出各層，因此當我們面臨問題的時候是可以整層進行抽換的。</p>
<p>例如說當我們除了原先的網頁以外，還要提供 API 服務，那麼展示層即使抽換成了 Web API 專案，對整體的架構仍不會有影響，還是能保持同一套商業邏輯。</p>
<p>又或者是說今天這個專案的資料來源要從 MySQL 換到 MSSQL 之類的，我們就可以把資料存取層替換掉，而不影響商業邏輯和展示層的運作。</p>
<p><strong>享受以上優點的前提</strong></p>
<p>但要真的享受到上述的各項優點，還是需要達成一定的條件的，並不是說直接切三塊就「完！」這樣。例如說：</p>
<ul>
<li>物件的設計需要遵守 <a href="/post/2020/09/oo-9-solid/">SOLID 原則</a>
<ul>
<li>包括物件符合單一職責、各個物件之間使用介面來減少耦合等等</li>
<li>其實這一項還蠻直覺的：畢竟如果你的方法完全不管單一職責，動不動就塞個上百行的 SQL 之類的，當然就很難重複利用了嘛</li>
</ul>
</li>
<li>需要降低各層之間的依賴
<ul>
<li>為了解除層與層之間的直接依賴，因此會需要使用介面和依賴注入等解耦手段</li>
<li>只有將各層之間的耦合降低，才能實現可替換、關注點分離等效果</li>
<li>關於依賴注入的概念，可以參照 <a href="/post/2020/12/oo-14-dependency-inversion-principle/">依賴反轉原則</a></li>
<li>註：本篇的範例會先建立簡單的分層，下一篇才會進入依賴注入的實作</li>
</ul>
</li>
<li>可能會有額外的開發成本
<ul>
<li>即使是再簡單的功能，例如單純的查詢，也必須要貫穿每一層。自然就增加了開發成本
<ul>
<li>有時候只是為了要多提供一個欄位給使用者，就會變成從上到下的每一層都需要修改</li>
</ul>
</li>
<li>不過我個人覺得比起東西都塞在一起然後動輒上千行還改東壞西的，我是很能接受這些成本啦囧</li>
</ul>
</li>
</ul>
<h3 id="本節的參考資料">本節的參考資料</h3>
<p>由於接下來我們就要進入實作了，因此在這邊先放上分層架構概念的參考資料，提供給想更了解三層式架構觀念的朋友們。</p>
<ul>
<li><a href="https://kevintsengtw.blogspot.com/2012/10/aspnet-mvc-part1.html">mrkt 的程式學習筆記: ASP.NET MVC 專案分層架構 Part.1 初學者的起手式</a></li>
<li><a href="https://raychiutw.github.io/2019/%E9%9A%A8%E6%89%8B-Design-Pattern-2-%E8%BB%9F%E9%AB%94%E5%88%86%E5%B1%A4%E8%A8%AD%E8%A8%88%E6%A8%A1%E5%BC%8F-Software-Layered-Architecture-Pattern/">隨手 Design Pattern (2) - 軟體分層設計模式 (Software Layered Architecture Pattern) | Ray&rsquo;s Notes</a></li>
<li><a href="https://blog.johnwu.cc/article/software-layered-architecture-pattern.html">軟體分層架構模式 | John Wu&rsquo;s Blog</a></li>
<li><a href="https://shunnien.github.io/2017/07/29/3-tier-and-mvc-introduction/">三層結構與 Asp.Net MVC 的簡介 | ShunNien&rsquo;s Blog</a></li>
<li><a href="https://sunnyday0932.github.io/2020/%E4%B8%89%E5%B1%A4%E5%BC%8F%E6%9E%B6%E6%A7%8B/">三層式架構 | Sian</a></li>
<li><a href="http://34.80.81.192/?p=4614">Layered Architecture Pattern（分層架構模式） – Coding &amp; Writing</a></li>
<li><a href="https://medium.com/@steph.c/%E4%B8%89%E5%B1%A4%E6%9E%B6%E6%A7%8B%E6%98%AF%E4%BB%80%E9%BA%BC-%E6%88%91%E5%8F%AA%E7%9F%A5%E9%81%93%E4%B8%89%E5%B1%A4%E8%82%89-efe542c38aaf">MVC 三層架構 是什麼? 我只知道三層肉. 三層架構 (3-Tier Architecture) 是哪三層 ? | by Steph Dev 史帝夫和戴夫</a></li>
</ul>
<h2 id="實作">實作</h2>
<h4 id="實作範例的架構與前言">實作範例的架構與前言</h4>
<p>在這次的範例中，我會採用在公司時的切割標準：各層之間不同方向的通訊都有獨立的 DTO 來負責。</p>
<p>當然<strong>每一層和每個 DTO 的名稱都是很彈性的</strong>，例如 <a href="https://raychiutw.github.io/2019/%E9%9A%A8%E6%89%8B-Design-Pattern-2-%E8%BB%9F%E9%AB%94%E5%88%86%E5%B1%A4%E8%A8%AD%E8%A8%88%E6%A8%A1%E5%BC%8F-Software-Layered-Architecture-Pattern/">Ray</a> 大大的範例中，Service 和 Repository 的部份就是使用 Dto 和 Entity 來命名。</p>
<p>故這部份還請各位根據專案慣例作調整，我個人還是習慣用這套命名方式來處理。本範例的架構大致上會長這樣：</p>
<p><img src="https://i.imgur.com/MYmaXpt.jpg" alt="分層架構03" style="zoom:50%;" /></p>
<p>此外，實作部份主要的參考來源為：</p>
<ul>
<li><a href="https://kevintsengtw.blogspot.com/search/label/%E5%88%86%E5%B1%A4%E6%9E%B6%E6%A7%8B">mrkt 的程式學習筆記: ASP.NET MVC 專案分層架構系列</a></li>
<li><a href="https://raychiutw.github.io/2019/%E9%9A%A8%E6%89%8B-Design-Pattern-2-%E8%BB%9F%E9%AB%94%E5%88%86%E5%B1%A4%E8%A8%AD%E8%A8%88%E6%A8%A1%E5%BC%8F-Software-Layered-Architecture-Pattern/">軟體分層設計模式 (Software Layered Architecture Pattern) | Ray&rsquo;s Notes</a></li>
<li>公司的新訓文件以及同事 <a href="https://sunnyday0932.github.io/posts/">Sian</a> 的整理</li>
</ul>
<p>對想了解分層架構的朋友們，可以也看過 mrkt 大大的操作流程，整體的敘述比較深入。</p>
<p>但要特別注意，由於我個人平時工作上比較常收到動輒好幾項查詢條件要包裝成單一支 API 的 Parameter DTO 這類需求，故已較為習慣建出一卡車的 DTO 這種方式。</p>
<p><del>而且畢竟都要寫了，當然要用我習慣的流程來記錄嘛。作者特權！</del></p>
<p>而像 mrkt 大大的<a href="https://kevintsengtw.blogspot.com/search/label/%E5%88%86%E5%B1%A4%E6%9E%B6%E6%A7%8B">系列文</a>是示範將已有的程式拆分為分層架構的模式、Ray 大大的<a href="https://github.com/raychiutw/software-layered-architecture-pattern-smaple">範例程式</a>的 DTO 命名和這篇的範例不同等等，因為環境、條件和習慣的差別，各家的分層方式和命名都會不太一樣，主要還是看團隊的慣例啦。</p>
<p>因此本篇的範例，或是說每一篇說明分層的範例在操作的流程、DTO 的建立和使用上都會有所不同。還請有交叉閱讀的朋友們稍加留意。</p>
<p>不過就像上面引用的 mrkt 大大說的：「『專案分層架構』這個題目相當難以說明，因為要分幾層、怎麼分層、各層有什麼職責、要做什麼事？這些都可以再細分成很多個主題來說明」</p>
<p>所以希望各位不要拘泥於流程上的順序或是命名之類的，而是理解到這些<strong>都會依照實務上的狀況去做決策和調整</strong>。最後再重申一次：分層架構是一種分工的概念，所謂「兵無常勢，水無常形」請各位施主見機行事。善哉善哉。</p>
<p>那麼我們就準備開始囉！</p>
<h4 id="大致上的步驟">大致上的步驟</h4>
<p>感謝和同事 <a href="https://sunnyday0932.github.io/posts/">Sian</a> 的談話才整理這套步驟，基本上我習慣的流程如下：</p>
<ol>
<li>建立 Service 層</li>
<li>建立 Repository 層</li>
<li>建立 Controller 及 DTO (Parameter、ViewModel)</li>
<li>建立 Service 的介面及 DTO (Info、ResultModel)</li>
<li>建立 Repository 的介面及 DTO (Condition、DataModel)</li>
<li>將 Service 注入到 Controller, 將 Repository 注入到 Service</li>
<li>安裝 AutoMapper，後續使用 AutoMapper 處理來處理 DTO 的轉換</li>
<li>Controller 實作，並接上 Service 的介面</li>
<li>Service 實作，並接上 Repository 的介面</li>
<li>Repository 實作</li>
<li>進行整合測試，呼叫 Controller 試試看是否成功取得資料</li>
<li>自由發揮</li>
</ol>
<p>可以注意到其實就是：</p>
<ul>
<li>切出分層</li>
<li>開介面和用到的 DTO</li>
<li>用實作銜接各層</li>
<li>測試</li>
</ul>
<p>這樣子的流程。</p>
<p>但這邊要說明幾點：</p>
<ul>
<li>第 3 項的 Controller 我們會沿用本系列的專案，等等會稍作說明</li>
<li>第 6 項的注入我們會在下一個章節再進行介紹。這邊就先直接使用 new 的方式處理</li>
<li>同上，由於尚未使用注入，故 8 ~ 10 的實作部分會改從 Repository 開始實作</li>
</ul>
<p>以上部分就…等等實作就會瞭了。那讓我們先介紹一下目前的專案狀況吧！</p>
<h4 id="範例專案背景">範例專案背景</h4>
<p>接著回到專案的介紹，如果並不是很在乎專案狀況，而是想看實作過程的朋友，請跳到 <a href="#%E5%BB%BA%E7%AB%8B%E5%88%86%E5%B1%A4">建立分層</a> 繼續閱讀。</p>
<p>我們會使用這個系列的 ProjectN 專案繼續操作。該專案在先前的 <a href="/post/2021/05/newbie-2-webapi/">Api</a> 和 <a href="/post/2021/05/newbie-3-dapper/">Dapper</a> 章節中，已經建立了一個對卡牌資料表進行 CRUD 的 <code>CardController</code>。詳細部份就不附了（畢竟這篇都會打掉嘛）大致上長這樣：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#a6e22e">[ApiController]</span>
<span style="color:#a6e22e">[Route(&#34;[controller]</span><span style="color:#e6db74">&#34;)]
</span><span style="color:#e6db74"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CardController</span> : ControllerBase
{
    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 查詢卡片列表
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span><span style="color:#a6e22e">    [HttpGet]</span>
<span style="color:#a6e22e">    [Produces(&#34;application/json&#34;)]</span>
    <span style="color:#66d9ef">public</span> IEnumerable&lt;CardViewModel&gt; GetList()
    {
        <span style="color:#75715e">// 查詢卡片的一些操作
</span><span style="color:#75715e"></span>    }

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 查詢卡片
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;     
</span><span style="color:#75715e"></span><span style="color:#a6e22e">    [HttpGet]</span>
<span style="color:#a6e22e">    [Produces(&#34;application/json&#34;)]</span>
<span style="color:#a6e22e">    [ProducesResponseType(typeof(CardViewModel), 200)]</span>
<span style="color:#a6e22e">    [Route(&#34;{id}&#34;)]</span>
    <span style="color:#66d9ef">public</span> CardViewModel Get(
<span style="color:#a6e22e">        [FromRoute]</span> <span style="color:#66d9ef">int</span> id)
    {
        <span style="color:#75715e">// 查詢指定 ID 的卡片的一些操作
</span><span style="color:#75715e"></span>    }

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 新增卡片
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;param name=&#34;parameter&#34;&gt;卡片參數&lt;/param&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;
</span><span style="color:#75715e"></span><span style="color:#a6e22e">    [HttpPost]</span>
    <span style="color:#66d9ef">public</span> IActionResult Insert(
<span style="color:#a6e22e">        [FromBody]</span> CardParameter parameter)
    {
        <span style="color:#75715e">// 新增卡片的一些操作
</span><span style="color:#75715e"></span>    }

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 更新卡片
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;param name=&#34;id&#34;&gt;卡片編號&lt;/param&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;param name=&#34;parameter&#34;&gt;卡片參數&lt;/param&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;
</span><span style="color:#75715e"></span><span style="color:#a6e22e">    [HttpPut]</span>
<span style="color:#a6e22e">    [Route(&#34;{id}&#34;)]</span>
    <span style="color:#66d9ef">public</span> IActionResult Update(
<span style="color:#a6e22e">        [FromRoute]</span> <span style="color:#66d9ef">int</span> id,
<span style="color:#a6e22e">        [FromBody]</span> CardParameter parameter)
    {
        <span style="color:#75715e">// 更新卡片的一些操作
</span><span style="color:#75715e"></span>    }

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 刪除卡片
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;param name=&#34;id&#34;&gt;卡片編號&lt;/param&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;
</span><span style="color:#75715e"></span><span style="color:#a6e22e">    [HttpDelete]</span>
<span style="color:#a6e22e">    [Route(&#34;{id}&#34;)]</span>
    <span style="color:#66d9ef">public</span> IActionResult Delete(
<span style="color:#a6e22e">        [FromRoute]</span> <span style="color:#66d9ef">int</span> id)
    {
        <span style="color:#75715e">// 刪除卡片的一些操作
</span><span style="color:#75715e"></span>    }
}

</code></pre></div><p>其中用來回傳顯示卡片內容的 Card 類別為了和分層的 DTO 命名一致，已經改為為 <code>CardViewModel</code>：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e">/// 卡片
</span><span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CardViewModel</span>
{
    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 卡片編號
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Id { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 卡片名稱
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> Name { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 卡片描述
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> Description { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 攻擊力
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Attack { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 血量
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Health { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 花費
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Cost { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
}
</code></pre></div><p>以及當新增及修改卡片時使用的 <code>CardParameter</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e">/// 卡片參數
</span><span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CardParameter</span>
{
    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 卡片名稱
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> Name { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 卡片描述
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> Description { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 攻擊力
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Attack { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 血量
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Health { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 花費
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Cost { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
}
</code></pre></div><p>如果像本節開頭提到的，並沒有切分查詢和傳入的 DTO 時，這兩個就有可能使用同一個 Model，遇到這種狀況還請不要太驚慌了。</p>
<p>不過既然已經提到說不採用共用 Model 而是全部獨立的原因是「常會有多條件的查詢參數」之類的，這邊就補一下查詢列表用的參數吧。</p>
<p>如此如此，在 <code>Parameter</code> 資料夾下新增了一個 <code>CardSearchParameter</code>：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e">/// 卡片搜尋參數
</span><span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CardSearchParameter</span>
{
    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 卡片名稱
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> Name { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 攻擊力下限
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int?</span> MinAttack { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 攻擊力上限
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int?</span> MaxAttack { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 血量下限
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int?</span> MinHealth { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 血量上限
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int?</span> MaxHealth { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 花費值下限
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int?</span> MinCost { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 花費值上限
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int?</span> MaxCost { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
}
</code></pre></div><p>請注意因為參數是選填的，所以部分欄位使用的是 Nullable。畢竟在卡牌遊戲中，想查詢「攻擊力３以下的卡片」是很平常的需求嘛。</p>
<p>接著這個參數就放回到 <code>CardController</code> 的 <code>GetList()</code> 裡面作為參數吧：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e">/// 查詢卡片列表
</span><span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;
</span><span style="color:#75715e"></span><span style="color:#a6e22e">[HttpGet]</span>
<span style="color:#a6e22e">[Produces(&#34;application/json&#34;)]</span>
<span style="color:#66d9ef">public</span> IEnumerable&lt;CardViewModel&gt; GetList(
<span style="color:#a6e22e">    [FromQuery]</span> CardSearchParameter parameter)
{
        <span style="color:#75715e">// 查詢卡片的一些操作
</span><span style="color:#75715e"></span>}
</code></pre></div><p>畢竟是 GET 方法，標示一下 FromQuery 才是好習慣呦。</p>
<p>到這邊就說明完目前的專案狀況了，讓我們捲起袖子，開始切分層吧！</p>
<h4 id="建立分層">建立分層</h4>
<p>接著讓我們先來建立分層吧，這邊採用建立「類別庫」的方式來分層，對於一些比較小的專案，使用資料夾來分層也是沒有問題的。</p>
<p>首先，讓我們在方案總管對著方案按下右鍵，選擇 加入 → 新增專案</p>
<p><img src="https://i.imgur.com/5kRtiNF.png" alt="image-20210921153907902"></p>
<p>接著找到類別庫，由於範例專案是使用 .net Core 3.1 的版本，故選擇 .net Core 為目標的類別庫：</p>
<p><img src="https://i.imgur.com/rh83s9z.png" alt="image-20210921154045369"></p>
<p>接著讓我們用專案名稱 + Service 來命名這個專案：</p>
<p><img src="https://i.imgur.com/2TVpn3L.png" alt="image-20210921154155709"></p>
<p>下個畫面選擇完版本之後，就可以在解決方案看到多了一個 Service 的專案囉：</p>
<p><img src="https://i.imgur.com/3RBmvbp.png" alt="image-20210921154319429"></p>
<p>然後那個 Class1.cs 可以砍掉，我們不會用到。</p>
<p>接著請重複以上的步驟，建立 Repository 和 Common 的類別庫：</p>
<p><img src="https://i.imgur.com/OwXJY9F.png" alt="image-20210921154728674"></p>
<blockquote>
<p>補充：如果想要把專案做排序或整理的朋友，可以對解決方案右鍵，選擇 加入 → 新增方案資料夾，用資料夾去做排序和整理</p>
<p><del>有的時候我都懷疑其他人的分層用 Business 和 Data 命名，該不會是為了排序起來比較好看……？！</del></p>
</blockquote>
<h4 id="加入參考">加入參考</h4>
<p>建立完類別庫之後，接著我們就要來<strong>加入參考</strong>，也就是設定這些庫之間的依賴方向。</p>
<p>一般的分層架構的依賴關係會是從上到下，也就是 展示層 → 商業邏輯層 → 資料存取層，然後他們三個都參考共用層。</p>
<p><img src="https://i.imgur.com/uYlhVjn.jpg" alt="分層架構05" style="zoom:33%;" /></p>
<p>現在讓我們從最外圍開始：對 <code>ProjectN</code> （或是你 WEB／API 等等所在的專案）右鍵 → 加入 → 專案參考</p>
<p><img src="https://i.imgur.com/SB841e8.png" alt="image-20210921162356712"></p>
<p>然後讓它參考我們的 Service 層以及共用的 Common：</p>
<p><img src="https://i.imgur.com/fawAtxz.png" alt="image-20210921163054655"></p>
<p>同樣地，也請各位對 Service 和 Repository 進行同樣的操作加入參考。各層的參考關係現在應該要是這樣的：</p>
<ul>
<li>API or APP: Service + Common</li>
<li>Service: Repository + Common</li>
<li>Repository: Common</li>
</ul>
<blockquote>
<p>小提示：如果想確認目前專案的相依性，可以在方案總管的解決方案上按下右鍵 → 專案相依性</p>
</blockquote>
<h4 id="建立介面與-dto">建立介面與 DTO</h4>
<blockquote>
<p>在這個小節，你可能會需要對介面有些了解。還不太了解的朋友，可以參照上個系列的<a href="/post/2020/07/oo-7-interface/">介面篇</a>。</p>
</blockquote>
<blockquote>
<p>對於分層是否要使用介面有疑惑的朋友，可以參考 mrkt 大大的這篇 <a href="https://kevintsengtw.blogspot.com/2013/07/aspnet-mvc.html">專案分層架構建議</a> 中的「問題三、一定要用介面嗎？」的段落。</p>
</blockquote>
<p>接著，讓我們開始著手處理介面的部分吧，先讓我們在 <code>Service</code> 中新增一個叫做 <code>Interface</code> 的資料夾來放我們的介面。</p>
<p><img src="https://i.imgur.com/FATU0lt.png" alt="image-20210921182347662"></p>
<p>接著因為是做卡片管理的 CRUD，當然要用 Card 當前綴。並且由於習慣的關係，只要是 Interface 我會在最前面加上一個</p>
<p><code>I</code> 來標示，所以讓我們在該資料夾下建立一個 <code>ICardService</code>：</p>
<p><img src="https://i.imgur.com/vr5RTrG.png" alt="image-20210921194022072"></p>
<p><img src="https://i.imgur.com/CAMytoF.png" alt="image-20210921194110374"></p>
<p>如此一來就會建立一個空的介面。啊，記得加上 <code>Public</code> 呦。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e">/// 卡片管理服務
</span><span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> ICardService
{

}
</code></pre></div><p>接著讓我們補上 CRUD 的五個方法，如果是去 Controller 複製的朋友要注意這邊的 DTO 已經不同囉：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e">/// 卡片管理服務
</span><span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> ICardService
{
    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 查詢卡片列表
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;
</span><span style="color:#75715e"></span>    IEnumerable&lt;CardResultModel&gt; GetList(CardSearchInfo info);

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 查詢卡片
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;param name=&#34;id&#34;&gt;卡片編號&lt;/param&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;   
</span><span style="color:#75715e"></span>    CardResultModel Get(<span style="color:#66d9ef">int</span> id);

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 新增卡片
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;param name=&#34;parameter&#34;&gt;卡片參數&lt;/param&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">bool</span> Insert(CardInfo info);

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 更新卡片
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;param name=&#34;id&#34;&gt;卡片編號&lt;/param&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;param name=&#34;parameter&#34;&gt;卡片參數&lt;/param&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">bool</span> Update(<span style="color:#66d9ef">int</span> id, CardInfo info);

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 刪除卡片
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;param name=&#34;id&#34;&gt;卡片編號&lt;/param&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">bool</span> Delete(<span style="color:#66d9ef">int</span> id);
}
</code></pre></div><p>因為我們還沒建立對應的 DTO，所以會有紅字也是正常的。我個人平常都是邊捏介面邊開 DTO 就是了。</p>
<p>畢竟<strong>介面就是各層之間溝通的契約，傳遞的 DTO 當然也就是契約內容了</strong>。所以在決定這功能要幹嘛的時候就會順便捏起來。</p>
<p>綜上所述，接著就讓我們來把 DTO 補上吧，因為我們只有 Card 一條線，所以這裡的 DTO 就會是對應展示層的那三個 DTO，反過來說也就是說，如果你的架構裡會有多個 Service 互相協作，或是 Service 需要從多個 Repository 取得資料的話，<strong>諸如此類需要多個部份互相配合的時侯，DTO 就不一定會是和上一層對照起來的了</strong>。這一點還請注意。</p>
<p>畢竟這個範例只有單線，已經是最最最簡單的狀況了，還是有蠻多亂七八糟的地方是難以表達的…屆時再請各位切身體會了。</p>
<p>所以請容我再貼一次九成像的 DTO 吧 XD。此外，因為都九成像了，呈現的時候就先不加上欄位註解囉。</p>
<p>關於存放的位置，我個人習慣會再開一個 <code>Models</code> 或是 <code>Dtos</code> 的資料夾來放這些 DTO，如果功能比較多的就再多一層做個分類。本範例的 DTO 路徑如註解。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#75715e">// ProjectN.Service.Dtos.ResultModel
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CardResultModel</span>
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Id { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> Name { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> Description { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Attack { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Health { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Cost { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
}


<span style="color:#75715e">// ProjectN.Service.Dtos.Info
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CardInfo</span>
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> Name { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> Description { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Attack { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Health { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Cost { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
}


<span style="color:#75715e">// ProjectN.Service.Dtos.Info
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CardSearchInfo</span>
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> Name { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int?</span> MinAttack { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int?</span> MaxAttack { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int?</span> MinHealth { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int?</span> MaxHealth { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int?</span> MinCost { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int?</span> MaxCost { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
}
</code></pre></div><p>不要忘了要回到 Interface 的地方好好 using 進來呦：</p>
<p><img src="https://i.imgur.com/vJSR9Qo.png" alt="image-20210921200741002"></p>
<p>現在我們的 Service 層應該會是這個樣子的：</p>
<p><img src="https://i.imgur.com/ScSGHFK.png" alt="image-20210921200831418"></p>
<p>接著就讓我們用同樣的節奏來處理 Repository 吧。</p>
<p>首先仍然是先建立一個 <code>Interface</code> 資料夾、<code>建立一個 </code>ICardRepository，並加上我們的 CRUD 五天王：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e">/// 卡片管理服務
</span><span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> ICardRepository
{
    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 查詢卡片列表
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;
</span><span style="color:#75715e"></span>    IEnumerable&lt;CardDataModel&gt; GetList(CardSearchCondition info);

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 查詢卡片
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;param name=&#34;id&#34;&gt;卡片編號&lt;/param&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;   
</span><span style="color:#75715e"></span>    CardDataModel Get(<span style="color:#66d9ef">int</span> id);

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 新增卡片
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;param name=&#34;parameter&#34;&gt;卡片參數&lt;/param&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">bool</span> Insert(CardCondition info);

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 更新卡片
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;param name=&#34;id&#34;&gt;卡片編號&lt;/param&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;param name=&#34;parameter&#34;&gt;卡片參數&lt;/param&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">bool</span> Update(<span style="color:#66d9ef">int</span> id, CardCondition info);

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 刪除卡片
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;param name=&#34;id&#34;&gt;卡片編號&lt;/param&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">bool</span> Delete(<span style="color:#66d9ef">int</span> id);
}
</code></pre></div><p>接著是我們的 DTO 們：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#75715e">// ProjectN.Repository.Dtos.DataModel
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CardDataModel</span>
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Id { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> Name { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> Description { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Attack { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Health { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Cost { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
}


<span style="color:#75715e">// ProjectN.Repository.Dtos.Condition
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CardCondition</span>
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> Name { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> Description { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Attack { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Health { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Cost { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
}


<span style="color:#75715e">// ProjectN.Repository.Dtos.Condition
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CardSearchCondition</span>
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> Name { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int?</span> MinAttack { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int?</span> MaxAttack { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int?</span> MinHealth { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int?</span> MaxHealth { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int?</span> MinCost { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int?</span> MaxCost { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
}
</code></pre></div><p>這邊特別提一下 <code>CardSearchCondition</code> 好了。</p>
<p>我個人是喜歡先在 Repository 中把一些簡單、跟資料有關的欄位先用 Condition 允許第一次篩選，如果有複雜的、需要別的條件的就再 Service 進行篩選。如此一來如果有別的 Service 需要用差不多的條件查詢該資料的時候，就可以用組合這些參數的方式來重複使用這個 Repository。</p>
<p>也就是說和 Service 時提到的時候一樣：如果有需要多個資料來源合併處理時，每層的 DTO 就會有所不同。</p>
<p>這個時候的 Repository 參數應該注重在「<strong>針對這個資料，有哪些基本的過濾條件？</strong>」下去設計，維持這個篩選的條件是和這個資料來源有關的，這樣才真的能夠<strong>重複利用</strong>。</p>
<p>千萬不要為了需求需要多個資料來源，就打破單一職責原則，把所有參數都丟到 Repository 然後才想辦法把資料表之類的兜在一起去滿足需求，這樣就難以複用、本末倒置了。</p>
<p>如果這樣說可能有點難以理解的話，想像一個「查詢重要訂單」功能的參數同時有「該訂單的交易金額大於五十萬」和「該訂單客戶年收入大於五十萬」這兩個查詢條件，很明顯一個是從訂單本身的資料內容下去篩選、而另一個是從客戶的資料內容下去篩選。</p>
<p>這種時候就應該是分別去呼叫 訂單的 Repo 和 客戶的 Repo 來拿到相對應的資料，例如說有客戶年收入的條件時，先取出年收入符合的客戶，再用這些客戶的編號取得對應的訂單等等（具體順序看資料大小），那麼這種場合兩者的參數 DTO 就會自然地和 Service 的 DTO 不一樣了。</p>
<p>請盡量不要為了一路打到底就硬把這兩個條件綑綁在一起，弄成什麼「以交易金額與客戶年收入查詢訂單」的「專用」方法，這樣將來就很難重複使用了。</p>
<p>（不過凡事都有例外嘛，當你的效能爆炸到被要求只能在 SQL 就先做完篩選的時候，或是只能從舊有功能移植過來的時候，還是要乖乖想辦法就是了囧…）</p>
<p>聊得遠了，讓我們回到 ProjectN 的 Repository，目前應該會是長這個樣子：</p>
<p><img src="https://i.imgur.com/iNQdSnm.png" alt="image-20210921204201764"></p>
<p>到這邊我們的介面和功能都訂好啦，接著就讓我們開始實作這些介面吧！</p>
<h4 id="實作-repository">實作 Repository</h4>
<blockquote>
<p>註：本篇範例還不會用到依賴注入，因此會將需要用到的依賴對象，例如 Controller 中的 IService 實體直接在建構式裡面建立出來。也因為必須建立實體的關係，故必須從最底的 Repository 開始實作。</p>
<p>如果是已經有在使用依賴注入的朋友，還請自行在腦內調整一下。不過我個人是覺得實作的順序沒有什麼關係啦，各位朋友有習慣的就按自己習慣的就好溜。</p>
<p>而還不太知道依賴注入的朋友們，我們下一篇再來說明。或是也可以先參照<a href="/post/2020/12/oo-14-dependency-inversion-principle/">依賴反轉原則</a>的範例自己改看看，此處就先按下不表。</p>
</blockquote>
<p>首先讓我們從 Repository 開始實作吧！</p>
<p>第一步就是建立實作的資料夾，方便和 <code>Interface</code> 做個區隔，所以這邊在 Repository 建立一個 <code>Implement</code> 資料夾，並在裡面建立 <code>CardRepository</code> ：</p>
<p><img src="https://i.imgur.com/mxPAvRb.png" alt="image-20210926181827673"></p>
<p>建立之後，別忘記把類別改為 <code>Public</code> 並告訴他我們要實作介面 <code>ICardRepository</code>（記得 using）：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CardRepository</span> : ICardRepository
{

}
</code></pre></div><p>接著 IDE 通常都會提醒一下說你有哪些要求沒有做到，這邊就讓我偷懶一下直接讓 IDE 產生空方法：</p>
<p><img src="https://i.imgur.com/nJIaMAR.png" alt="image-20210926182828485"></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CardRepository</span> : ICardRepository
{
    <span style="color:#66d9ef">public</span> IEnumerable&lt;CardDataModel&gt; GetList(CardSearchCondition info)
    {
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NotImplementedException();
    }

    <span style="color:#66d9ef">public</span> CardDataModel Get(<span style="color:#66d9ef">int</span> id)
    {
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NotImplementedException();
    }
    
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> Insert(CardCondition info)
    {
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NotImplementedException();
    }

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> Update(<span style="color:#66d9ef">int</span> id, CardCondition info)
    {
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NotImplementedException();
    }
    
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> Delete(<span style="color:#66d9ef">int</span> id)
    {
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NotImplementedException();
    }
}
</code></pre></div><p>各位朋友在切出資料存取層的實作時，如果是從舊專案移植過來的，也可以從「把操作資料表的部份都先剪過來」來起手。</p>
<p>從資料庫裏面操作資料的 CRUD 相關部份我們在上一篇的 <a href="/post/2021/05/newbie-3-dapper/">Dapper</a> 章節已經做得差不多了，這邊就不再贅述，稍微補上這次新增的查詢列表就行。</p>
<blockquote>
<p>補充：為了避免我之後回來抄的時候想不起來，這邊也放一下資料表目前狀況好了：
<img src="https://i.imgur.com/8qhFQBb.png" alt="image-20211002135411755"></p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e">/// 卡片管理
</span><span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e">/// &lt;seealso cref=&#34;ProjectN.Repository.Interface.ICardRepository&#34; /&gt;
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CardRepository</span> : ICardRepository
{
    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 連線字串
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> <span style="color:#66d9ef">string</span> _connectString = <span style="color:#e6db74">@&#34;Server=(LocalDB)\MSSQLLocalDB;Database=Newbie;Trusted_Connection=True;&#34;</span>;

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 查詢卡片列表
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;param name=&#34;info&#34;&gt;&lt;/param&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> IEnumerable&lt;CardDataModel&gt; GetList(CardSearchCondition condition)
    {
        <span style="color:#66d9ef">var</span> sql = <span style="color:#e6db74">&#34;SELECT * FROM Card&#34;</span>;

        <span style="color:#66d9ef">var</span> sqlQuery = <span style="color:#66d9ef">new</span> List&lt;<span style="color:#66d9ef">string</span>&gt;();
        <span style="color:#66d9ef">var</span> parameter = <span style="color:#66d9ef">new</span> DynamicParameters();

        <span style="color:#66d9ef">if</span> (condition.MinCost.HasValue)
        {
            sqlQuery.Add(<span style="color:#e6db74">$&#34; Cost &gt;= @MinCost &#34;</span>);
            parameter.Add(<span style="color:#e6db74">&#34;MinCost&#34;</span>, condition.MinCost);
        }

        <span style="color:#66d9ef">if</span> (condition.MaxCost.HasValue)
        {
            sqlQuery.Add(<span style="color:#e6db74">$&#34; Cost &lt;= @MaxCost &#34;</span>);
            parameter.Add(<span style="color:#e6db74">&#34;MaxCost&#34;</span>, condition.MaxCost);
        }

        <span style="color:#66d9ef">if</span> (condition.MinAttack.HasValue)
        {
            sqlQuery.Add(<span style="color:#e6db74">$&#34; Attack &gt;= @MinAttack &#34;</span>);
            parameter.Add(<span style="color:#e6db74">&#34;MinAttack&#34;</span>, condition.MinAttack);
        }

        <span style="color:#66d9ef">if</span> (condition.MaxAttack.HasValue)
        {
            sqlQuery.Add(<span style="color:#e6db74">$&#34; Attack &lt;= @MaxAttack &#34;</span>);
            parameter.Add(<span style="color:#e6db74">&#34;MaxAttack&#34;</span>, condition.MaxAttack);
        }

        <span style="color:#66d9ef">if</span> (condition.MinHealth.HasValue)
        {
            sqlQuery.Add(<span style="color:#e6db74">$&#34; Health &gt;= @MinHealth &#34;</span>);
            parameter.Add(<span style="color:#e6db74">&#34;MinHealth&#34;</span>, condition.MinHealth);
        }

        <span style="color:#66d9ef">if</span> (condition.MaxHealth.HasValue)
        {
            sqlQuery.Add(<span style="color:#e6db74">$&#34; Health &lt;= @MaxHealth &#34;</span>);
            parameter.Add(<span style="color:#e6db74">&#34;MaxHealth&#34;</span>, condition.MaxHealth);
        }

        <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">string</span>.IsNullOrWhiteSpace(condition.Name) <span style="color:#66d9ef">is</span> <span style="color:#66d9ef">false</span>)
        {
            sqlQuery.Add(<span style="color:#e6db74">$&#34; Name LIKE @Name &#34;</span>);
            parameter.Add(<span style="color:#e6db74">&#34;Name&#34;</span>, <span style="color:#e6db74">$&#34;%{condition.MaxHealth}%&#34;</span>);
        }
        
        <span style="color:#66d9ef">if</span> (sqlQuery.Any())
        {
            sql += <span style="color:#e6db74">$&#34; WHERE {string.Join(&#34;</span> AND <span style="color:#e6db74">&#34;, sqlQuery)} &#34;</span>;
        }

        <span style="color:#66d9ef">using</span> (<span style="color:#66d9ef">var</span> conn = <span style="color:#66d9ef">new</span> SqlConnection(_connectString))
        {
            <span style="color:#66d9ef">var</span> result = conn.Query&lt;CardDataModel&gt;(sql, parameter);
            <span style="color:#66d9ef">return</span> result;
        }
    }
	
    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 查詢卡片
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;param name=&#34;id&#34;&gt;卡片編號&lt;/param&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> CardDataModel Get(<span style="color:#66d9ef">int</span> id)
    {
        <span style="color:#66d9ef">var</span> sql =
            <span style="color:#e6db74">@&#34;		
</span><span style="color:#e6db74">                SELECT * 
</span><span style="color:#e6db74">                FROM Card 
</span><span style="color:#e6db74">                Where Id = @id
</span><span style="color:#e6db74">            &#34;</span>;

        <span style="color:#66d9ef">var</span> parameters = <span style="color:#66d9ef">new</span> DynamicParameters();
        parameters.Add(<span style="color:#e6db74">&#34;Id&#34;</span>, id, System.Data.DbType.Int32);

        <span style="color:#66d9ef">using</span> (<span style="color:#66d9ef">var</span> conn = <span style="color:#66d9ef">new</span> SqlConnection(_connectString))
        {
            <span style="color:#66d9ef">var</span> result = conn.QueryFirstOrDefault&lt;CardDataModel&gt;(sql, parameters);
            <span style="color:#66d9ef">return</span> result;
        }
    }


    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> Insert(CardCondition condition)
    {
        <span style="color:#66d9ef">var</span> sql =
            <span style="color:#e6db74">@&#34;
</span><span style="color:#e6db74">                INSERT INTO Card 
</span><span style="color:#e6db74">                (
</span><span style="color:#e6db74">                   [Name]
</span><span style="color:#e6db74">                  ,[Description]
</span><span style="color:#e6db74">                  ,[Attack]
</span><span style="color:#e6db74">                  ,[Health]
</span><span style="color:#e6db74">                  ,[Cost]
</span><span style="color:#e6db74">                ) 
</span><span style="color:#e6db74">                VALUES 
</span><span style="color:#e6db74">                (
</span><span style="color:#e6db74">                    @Name
</span><span style="color:#e6db74">                   ,@Description
</span><span style="color:#e6db74">                   ,@Attack
</span><span style="color:#e6db74">                   ,@Health
</span><span style="color:#e6db74">                   ,@Cost
</span><span style="color:#e6db74">                );
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">                SELECT @@IDENTITY;
</span><span style="color:#e6db74">            &#34;</span>;

        <span style="color:#66d9ef">using</span> (<span style="color:#66d9ef">var</span> conn = <span style="color:#66d9ef">new</span> SqlConnection(_connectString))
        {
            <span style="color:#66d9ef">var</span> result = conn.Execute(sql, condition);
            <span style="color:#66d9ef">return</span> result &gt; <span style="color:#ae81ff">0</span>;
        }
    }

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 更新卡片
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;param name=&#34;id&#34;&gt;卡片編號&lt;/param&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;param name=&#34;condition&#34;&gt;&lt;/param&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> Update(<span style="color:#66d9ef">int</span> id, CardCondition condition)
    {
        <span style="color:#66d9ef">var</span> sql =
            <span style="color:#e6db74">@&#34;
</span><span style="color:#e6db74">                UPDATE Card
</span><span style="color:#e6db74">                SET 
</span><span style="color:#e6db74">                    [Name] = @Name
</span><span style="color:#e6db74">                   ,[Description] = @Description
</span><span style="color:#e6db74">                   ,[Attack] = @Attack
</span><span style="color:#e6db74">                   ,[Health] = @Health
</span><span style="color:#e6db74">                   ,[Cost] = @Cost
</span><span style="color:#e6db74">                WHERE
</span><span style="color:#e6db74">                    Id = @id
</span><span style="color:#e6db74">            &#34;</span>;

        <span style="color:#66d9ef">var</span> parameters = <span style="color:#66d9ef">new</span> DynamicParameters();

        parameters.AddDynamicParams(condition);
        parameters.Add(<span style="color:#e6db74">&#34;Id&#34;</span>, id, System.Data.DbType.Int32);

        <span style="color:#66d9ef">using</span> (<span style="color:#66d9ef">var</span> conn = <span style="color:#66d9ef">new</span> SqlConnection(_connectString))
        {
            <span style="color:#66d9ef">var</span> result = conn.Execute(sql, parameters);
            <span style="color:#66d9ef">return</span> result &gt; <span style="color:#ae81ff">0</span>;
        }
    }

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 刪除卡片
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;param name=&#34;id&#34;&gt;卡片編號&lt;/param&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> Delete(<span style="color:#66d9ef">int</span> id)
    {
        <span style="color:#66d9ef">var</span> sql =
            <span style="color:#e6db74">@&#34;
</span><span style="color:#e6db74">                DELETE FROM Card
</span><span style="color:#e6db74">                WHERE Id = @Id
</span><span style="color:#e6db74">            &#34;</span>;

        <span style="color:#66d9ef">var</span> parameters = <span style="color:#66d9ef">new</span> DynamicParameters();
        parameters.Add(<span style="color:#e6db74">&#34;Id&#34;</span>, id, System.Data.DbType.Int32);

        <span style="color:#66d9ef">using</span> (<span style="color:#66d9ef">var</span> conn = <span style="color:#66d9ef">new</span> SqlConnection(_connectString))
        {
            <span style="color:#66d9ef">var</span> result = conn.Execute(sql, parameters);
            <span style="color:#66d9ef">return</span> result &gt; <span style="color:#ae81ff">0</span>;
        }
    }
}
</code></pre></div><h4 id="實作-service">實作 Service</h4>
<p>接著是我們 Service 層的實作。要注意的是，<strong>在 DTO 的轉換上，推薦使用 <a href="/post/2020/07/automapper/">AutoMapper</a> 來處理</strong>，讓方法關注在商業邏輯本身，而不用被 DTO 的賦值過程洗版。</p>
<blockquote>
<p>補充：對 AutoMapper 不太熟悉的朋友，可以先閱讀 <a href="https://igouist.github.io/post/2020/07/automapper/">AutoMapper —— 類別轉換超省力</a></p>
<p>如果是在本篇流程不打算使用 AutoMapper 的朋友，請在使用到 AutoMapper 的場合自行 new 出目標物件並賦值即可。</p>
</blockquote>
<p>首先一樣先建立實作用的資料夾，並建立 <code>CardService</code>：</p>
<p><img src="https://i.imgur.com/rJ4rMgs.png" alt="image-20211003091808904"></p>
<p>並且讓 IDE 幫忙把要實作的介面都先列出來：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CardService</span> : ICardService
{
    <span style="color:#66d9ef">public</span> IEnumerable&lt;CardResultModel&gt; GetList(CardSearchInfo info)
    {
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NotImplementedException();
    }

    <span style="color:#66d9ef">public</span> CardResultModel Get(<span style="color:#66d9ef">int</span> id)
    {
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NotImplementedException();
    }

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> Insert(CardInfo info)
    {
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NotImplementedException();
    }

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> Update(<span style="color:#66d9ef">int</span> id, CardInfo info)
    {
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NotImplementedException();
    }
    
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> Delete(<span style="color:#66d9ef">int</span> id)
    {
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NotImplementedException();
    }
}
</code></pre></div><p>那因為這個範例還沒有什麼需要注意的商業邏輯，因此我們就先在 Service 做一個承上（Controller）啟下（Repository）的動作。</p>
<p>也就是說每個方法負責去接收 Controller 的請求，並呼叫 Repository 來完成工作，並用 AutoMapper 來進行過程的轉換。</p>
<p>因此我們的 Service 要能夠呼叫到 Repository 和 Mapper，現在先讓我們把 Repository 當作私有成員建立進來：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CardService</span> : ICardService
{
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> ICardRepository _cardRepository;

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 建構式
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> CardService()
    {
        <span style="color:#66d9ef">this</span>._cardRepository = <span style="color:#66d9ef">new</span> CardRepository();
    }

    <span style="color:#75715e">// 其他實作部分
</span><span style="color:#75715e"></span>}
</code></pre></div><p>接著是 DTO 的對映部分，先建立 Service 的對映表。我個人習慣跟隨公司慣例開一個 <code>Mappings</code> 資料夾來放：</p>
<p><img src="https://i.imgur.com/wwEi2pW.png" alt="image-20211003094809104"></p>
<blockquote>
<p>補充：當專案還有 Mappings, Enum（列舉）和其他設定檔等等，資料夾就會變得挺多的。</p>
<p>這種時候，也可以把這類基礎建設相關的都放到 <code>Infrastructure</code> 資料夾做個整理，閱讀和操作上會比較舒服。</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ServiceMappings</span> : Profile
{
    <span style="color:#66d9ef">public</span> ServiceMappings()
    {
        <span style="color:#75715e">// Info -&gt; Condition
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">this</span>.CreateMap&lt;CardInfo, CardCondition&gt;();
        <span style="color:#66d9ef">this</span>.CreateMap&lt;CardSearchInfo, CardSearchCondition&gt;();

        <span style="color:#75715e">// DataModel -&gt; ResultModel
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">this</span>.CreateMap&lt;CardDataModel, CardResultModel&gt;();
    }
}
</code></pre></div><p>接著讓我們也把 AutoMapper 的部份放到建構式裡面吧：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CardService</span> : ICardService
{
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> IMapper _mapper;
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> ICardRepository _cardRepository;

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 建構式
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> CardService()
    {
        <span style="color:#66d9ef">var</span> config = <span style="color:#66d9ef">new</span> MapperConfiguration(cfg =&gt;
			cfg.AddProfile&lt;ServiceMappings&gt;());

        <span style="color:#66d9ef">this</span>._mapper = config.CreateMapper();
        <span style="color:#66d9ef">this</span>._cardRepository = <span style="color:#66d9ef">new</span> CardRepository();
    }
    
    <span style="color:#75715e">// 其他實作部分
</span><span style="color:#75715e"></span>}
</code></pre></div><p>接著就化身為無情的串接機器，把各個實作接起來。</p>
<p>例如說 查詢列表 <code>GetList</code>，標準流程就是 轉換參數 DTO、呼叫目標方法、轉換回傳 DTO：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e">/// 查詢卡片列表
</span><span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e">/// &lt;param name=&#34;info&#34;&gt;&lt;/param&gt;
</span><span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> IEnumerable&lt;CardResultModel&gt; GetList(CardSearchInfo info)
{
    <span style="color:#66d9ef">var</span> condition = <span style="color:#66d9ef">this</span>._mapper.Map&lt;CardSearchInfo, CardSearchCondition&gt;(info);
    <span style="color:#66d9ef">var</span> data = <span style="color:#66d9ef">this</span>._cardRepository.GetList(condition);

    <span style="color:#66d9ef">var</span> result = <span style="color:#66d9ef">this</span>._mapper.Map&lt;
        IEnumerable&lt;CardDataModel&gt;, 
    	IEnumerable&lt;CardResultModel&gt;&gt;(data);

    <span style="color:#66d9ef">return</span> result;
}
</code></pre></div><p>當然實際上還會根據需求，在這邊做一些商業邏輯的處理，例如說呼叫多個 Repository 方法、參數內容換成內部商業邏輯定義好的代號等等。</p>
<blockquote>
<p>叮嚀一下：如果感覺公開方法裡面做的事情太多的話，還請考慮是不是職責太複雜、並嘗試適當地拆出私有方法或其他類別呦。</p>
</blockquote>
<p>那麼這邊就直接補上剩下的方法，貼上整個 <code>CardService</code> 吧：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e">/// 卡片管理
</span><span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e">/// &lt;seealso cref=&#34;ProjectN.Service.Interface.ICardService&#34; /&gt;
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CardService</span> : ICardService
{
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> IMapper _mapper;
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> ICardRepository _cardRepository;

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 建構式
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> CardService()
    {
        <span style="color:#66d9ef">this</span>._cardRepository = <span style="color:#66d9ef">new</span> CardRepository();

        <span style="color:#66d9ef">var</span> config = <span style="color:#66d9ef">new</span> MapperConfiguration(cfg =&gt; 
			cfg.AddProfile&lt;ServiceMappings&gt;());

        <span style="color:#66d9ef">this</span>._mapper = config.CreateMapper();
    }

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 查詢卡片列表
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;param name=&#34;info&#34;&gt;&lt;/param&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> IEnumerable&lt;CardResultModel&gt; GetList(CardSearchInfo info)
    {
        <span style="color:#66d9ef">var</span> condition = <span style="color:#66d9ef">this</span>._mapper.Map&lt;CardSearchInfo, CardSearchCondition&gt;(info);
        <span style="color:#66d9ef">var</span> cards = <span style="color:#66d9ef">this</span>._cardRepository.GetList(condition);

        <span style="color:#66d9ef">var</span> result = <span style="color:#66d9ef">this</span>._mapper.Map&lt;
            IEnumerable&lt;CardDataModel&gt;, 
        	IEnumerable&lt;CardResultModel&gt;&gt;(cards);

        <span style="color:#66d9ef">return</span> result;
    }

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 查詢卡片
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;param name=&#34;id&#34;&gt;卡片編號&lt;/param&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> CardResultModel Get(<span style="color:#66d9ef">int</span> id)
    {
        <span style="color:#66d9ef">var</span> card = <span style="color:#66d9ef">this</span>._cardRepository.Get(id);
        <span style="color:#66d9ef">var</span> result = <span style="color:#66d9ef">this</span>._mapper.Map&lt;CardDataModel, CardResultModel&gt;(card);
        <span style="color:#66d9ef">return</span> result;
    }

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 新增卡片
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;param name=&#34;info&#34;&gt;&lt;/param&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> Insert(CardInfo info)
    {
        <span style="color:#66d9ef">var</span> condition = <span style="color:#66d9ef">this</span>._mapper.Map&lt;CardInfo, CardCondition&gt;(info);
        <span style="color:#66d9ef">var</span> result = <span style="color:#66d9ef">this</span>._cardRepository.Insert(condition);
        <span style="color:#66d9ef">return</span> result;
    }

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 更新卡片
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;param name=&#34;id&#34;&gt;卡片編號&lt;/param&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;param name=&#34;info&#34;&gt;&lt;/param&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> Update(<span style="color:#66d9ef">int</span> id, CardInfo info)
    {
        <span style="color:#66d9ef">var</span> condition = <span style="color:#66d9ef">this</span>._mapper.Map&lt;CardInfo, CardCondition&gt;(info);
        <span style="color:#66d9ef">var</span> result = <span style="color:#66d9ef">this</span>._cardRepository.Update(id, condition);
        <span style="color:#66d9ef">return</span> result;
    }

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 刪除卡片
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;param name=&#34;id&#34;&gt;卡片編號&lt;/param&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> Delete(<span style="color:#66d9ef">int</span> id)
    {
        <span style="color:#66d9ef">var</span> result = <span style="color:#66d9ef">this</span>._cardRepository.Delete(id);
        <span style="color:#66d9ef">return</span> result;
    }
}
</code></pre></div><h4 id="實作-controller">實作 Controller</h4>
<p>最後就是讓我們的 Controller 來接上 Service 的介面，把方法公開出去啦！</p>
<p>同樣的也先放一下 Mappings：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ControllerMappings</span> : Profile
{
    <span style="color:#66d9ef">public</span> ControllerMappings()
    {
        <span style="color:#75715e">// Parameter -&gt; Info
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">this</span>.CreateMap&lt;CardParameter, CardInfo&gt;();
        <span style="color:#66d9ef">this</span>.CreateMap&lt;CardSearchParameter, CardSearchInfo&gt;();

        <span style="color:#75715e">// ResultModel -&gt; ViewModel
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">this</span>.CreateMap&lt;CardResultModel, CardViewModel&gt;();
    }
}
</code></pre></div><p>最後一樣把 Controller 的各方法補上：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e">/// 卡片管理
</span><span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e">/// &lt;seealso cref=&#34;Microsoft.AspNetCore.Mvc.ControllerBase&#34; /&gt;
</span><span style="color:#75715e"></span><span style="color:#a6e22e">[ApiController]</span>
<span style="color:#a6e22e">[Route(&#34;[controller]</span><span style="color:#e6db74">&#34;)]
</span><span style="color:#e6db74"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CardController</span> : ControllerBase
{
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> IMapper _mapper;
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> ICardService _cardService;

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 建構式
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> CardController()
    {
        <span style="color:#66d9ef">var</span> config = <span style="color:#66d9ef">new</span> MapperConfiguration(cfg =&gt;
        	cfg.AddProfile&lt;ControllerMappings&gt;());

        <span style="color:#66d9ef">this</span>._mapper = config.CreateMapper();
        <span style="color:#66d9ef">this</span>._cardService = <span style="color:#66d9ef">new</span> CardService();
    }

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 查詢卡片列表
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;
</span><span style="color:#75715e"></span><span style="color:#a6e22e">    [HttpGet]</span>
<span style="color:#a6e22e">    [Produces(&#34;application/json&#34;)]</span>
    <span style="color:#66d9ef">public</span> IEnumerable&lt;CardViewModel&gt; GetList(
<span style="color:#a6e22e">        [FromQuery]</span> CardSearchParameter parameter)
    {
        <span style="color:#66d9ef">var</span> info = <span style="color:#66d9ef">this</span>._mapper.Map&lt;
            CardSearchParameter, 
        	CardSearchInfo&gt;(parameter);

        <span style="color:#66d9ef">var</span> cards = <span style="color:#66d9ef">this</span>._cardService.GetList(info);

        <span style="color:#66d9ef">var</span> result = <span style="color:#66d9ef">this</span>._mapper.Map&lt;
            IEnumerable&lt;CardResultModel&gt;,
        	IEnumerable&lt;CardViewModel&gt;&gt;(cards);

        <span style="color:#66d9ef">return</span> result;
    }

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 查詢卡片
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;remarks&gt;我是附加說明&lt;/remarks&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;param name=&#34;id&#34;&gt;卡片編號&lt;/param&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;response code=&#34;200&#34;&gt;回傳對應的卡片&lt;/response&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;response code=&#34;404&#34;&gt;找不到該編號的卡片&lt;/response&gt;          
</span><span style="color:#75715e"></span><span style="color:#a6e22e">    [HttpGet]</span>
<span style="color:#a6e22e">    [Produces(&#34;application/json&#34;)]</span>
<span style="color:#a6e22e">    [ProducesResponseType(typeof(CardViewModel), 200)]</span>
<span style="color:#a6e22e">    [Route(&#34;{id}&#34;)]</span>
    <span style="color:#66d9ef">public</span> CardViewModel Get(
<span style="color:#a6e22e">        [FromRoute]</span> <span style="color:#66d9ef">int</span> id)
    {
        <span style="color:#66d9ef">var</span> card = <span style="color:#66d9ef">this</span>._cardService.Get(id);

        <span style="color:#66d9ef">var</span> result = <span style="color:#66d9ef">this</span>._mapper.Map&lt;
            CardResultModel,
        	CardViewModel&gt;(card);

        <span style="color:#66d9ef">return</span> result;
    }

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 新增卡片
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;param name=&#34;parameter&#34;&gt;卡片參數&lt;/param&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;
</span><span style="color:#75715e"></span><span style="color:#a6e22e">    [HttpPost]</span>
    <span style="color:#66d9ef">public</span> IActionResult Insert(
<span style="color:#a6e22e">        [FromBody]</span> CardParameter parameter)
    {
        <span style="color:#66d9ef">var</span> info = <span style="color:#66d9ef">this</span>._mapper.Map&lt;
            CardParameter,
        	CardInfo&gt;(parameter);

        <span style="color:#66d9ef">var</span> isInsertSuccess = <span style="color:#66d9ef">this</span>._cardService.Insert(info);
        <span style="color:#66d9ef">if</span> (isInsertSuccess)
        {
            <span style="color:#66d9ef">return</span> Ok();
        }
        <span style="color:#66d9ef">return</span> StatusCode(<span style="color:#ae81ff">500</span>);
    }

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 更新卡片
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;param name=&#34;id&#34;&gt;卡片編號&lt;/param&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;param name=&#34;parameter&#34;&gt;卡片參數&lt;/param&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;
</span><span style="color:#75715e"></span><span style="color:#a6e22e">    [HttpPut]</span>
<span style="color:#a6e22e">    [Route(&#34;{id}&#34;)]</span>
    <span style="color:#66d9ef">public</span> IActionResult Update(
<span style="color:#a6e22e">        [FromRoute]</span> <span style="color:#66d9ef">int</span> id,
<span style="color:#a6e22e">        [FromBody]</span> CardParameter parameter)
    {
        <span style="color:#66d9ef">var</span> targetCard = <span style="color:#66d9ef">this</span>._cardService.Get(id);
        <span style="color:#66d9ef">if</span> (targetCard <span style="color:#66d9ef">is</span> <span style="color:#66d9ef">null</span>)
        {
            <span style="color:#66d9ef">return</span> NotFound();
        }

        <span style="color:#66d9ef">var</span> info = <span style="color:#66d9ef">this</span>._mapper.Map&lt;
            CardParameter,
        	CardInfo&gt;(parameter);

        <span style="color:#66d9ef">var</span> isUpdateSuccess = <span style="color:#66d9ef">this</span>._cardService.Update(id, info);
        <span style="color:#66d9ef">if</span> (isUpdateSuccess)
        {
            <span style="color:#66d9ef">return</span> Ok();
        }
        <span style="color:#66d9ef">return</span> StatusCode(<span style="color:#ae81ff">500</span>);
    }

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// 刪除卡片
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;param name=&#34;id&#34;&gt;卡片編號&lt;/param&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;
</span><span style="color:#75715e"></span><span style="color:#a6e22e">    [HttpDelete]</span>
<span style="color:#a6e22e">    [Route(&#34;{id}&#34;)]</span>
    <span style="color:#66d9ef">public</span> IActionResult Delete(
<span style="color:#a6e22e">        [FromRoute]</span> <span style="color:#66d9ef">int</span> id)
    {
        <span style="color:#66d9ef">this</span>._cardService.Delete(id);
        <span style="color:#66d9ef">return</span> Ok();
    }
}
</code></pre></div><p>測試一下有沒有接上去</p>
<p><img src="https://i.imgur.com/IHsfTjU.png" alt="image-20211003114955056"></p>
<p>打完收工！</p>
<h2 id="自問自答心得篇">自問自答心得篇</h2>
<p>實作結束之後，這邊就留個版面放一些上面沒提到／塞不進去／老人碎碎念的部份。</p>
<p>感謝 <a href="https://sunnyday0932.github.io/2020/%E4%B8%89%E5%B1%A4%E5%BC%8F%E6%9E%B6%E6%A7%8B/">Sian</a> 提供的建議和示範，這邊補上一些關於我個人分層上遇到的一些問題和想法，整理成Ｑ＆Ａ的方式。</p>
<h4 id="關於重複建立-dto-的問題">關於重複建立 DTO 的問題</h4>
<p>Q: 資料處理給商業邏輯要開一個 DataModel，商業邏輯出去又要開一個 ResultModel……每次都要開一堆重複的 DTO 很麻煩！一定要這樣做嗎？</p>
<p>A: 不一定。</p>
<p>我這邊也遇過一些系統，由於場景相對單純，存取上基本只有增修查改，商業邏輯也多是驗證和內容資料的處理，因此就採用一個 Dto 貫穿三層的方式進行。例如說跟訂單有關的就只使用一個 OrderDto、跟產品有關的就只用一個 ProductDto 這樣，整體用起來會比較像是一個實體對應一個 Dto的感覺。</p>
<p>我個人認為「要不要把各層之間溝通用的 DTO 都獨立出來」，基本上就是在問這個系統：</p>
<ul>
<li>會不會有「你對資料表比較熟悉，負責資料存取層；我對外制定規格，負責展示層」等等，這種<strong>需要針對分層去分工的時候？</strong></li>
<li>每一層之間傳遞的 Model 是否會在各層進一步加工，<strong>每一層需要傳遞的資料會不會有所不同？</strong></li>
<li>每一層之間呼叫方法的參數是否會不同，<strong>有沒有需要把參數封裝成一個物件？</strong></li>
</ul>
<p>例如說：</p>
<ul>
<li>資料存取層將資料表的資料查詢出來，但該功能展示給使用者的時候並不需要這麼多欄位</li>
<li>商業邏輯層需要針對這個內容去和別的資料進行組裝、運算
<ul>
<li>例如說需求不只是單純的客戶查詢，而是客戶平均消費排行榜之類的</li>
</ul>
</li>
<li>展示層需要進行一些給使用者介面顯示時的調整
<ul>
<li>浮點數顯示的時候只到小數後兩位之類的</li>
</ul>
</li>
</ul>
<p>像這種分工明確的情況下，就很容易會遇到每一層之間傳遞的 Dto 內容必須不同的情況。</p>
<p>以上的狀況如果都共用同一個 DTO 反而綁手綁腳的，把各層之間盡責地拆分開來，更可以降低彼此間的耦合，讓修改的範圍變小、並盡量只在符合該職責的地方修改，整體會比較靈活。</p>
<p>回到問題上來說，要不要確實地把每一層的 DTO 做拆分？或是想採用一個 DTO 代表該資料來貫穿整個系統？我個人覺得都還是蠻彈性的，可以根據系統的複雜度去嘗試。</p>
<p>如果你可能會根據分層去指派分工，又或者是有些地方會頻繁地修改、每一層之間傳遞的資訊常常會有所差異，甚至是收到的需求常常挺客製化的時候，拆分開來在往後的修改就可能可以迴避一些耦合上的問題。但相對的，因為 Model 終究還是變多了，有時候也會遇到重複且多餘的修改。</p>
<p>反過來說如果系統的工作單一，場景相對單純，例如說是針對某個職責去架設的、提供給其他系統使用的小型服務。那麼先採用 DTO 對映資料內容並共用的做法，在開發上反而比較迅速。</p>
<p>就再請各位使用時細細品味吧。<del>我都是前輩怎麼開我就怎麼寫啦</del></p>
<h4 id="三層式架構跟-mvc-一樣嗎">三層式架構跟 MVC 一樣嗎？</h4>
<p>這個吼，不太一樣啦（抓頭）</p>
<p>雖然兩者的目標都算是「區分職責＋解除耦合」的感覺，但並不是一樣的東西。</p>
<p>MVC 是一種框架，主要分為 View, Controller, Model，特別強調此三者並不能直接類比到三層式架構的三層。我們從兩邊的角度來比對一下：</p>
<p>以 MVC 的角度出發，對應三層式中的商業邏輯和資料存取都是塞到 Model 中處理的（當然也會遇到全部塞在 Controller 的朋友囧），這時候最大的差別就是有沒有區分出商業邏輯。畢竟三層式就是為了要能重複使用而分層的嘛。</p>
<p>反過來從三層式架構的角度出發的話，MVC 也只是用在展示層的一種模式而已。例如說展示層使用 MVC 的架構，往下接到商業邏輯等等。實際上使用分層的話，最終不管展示層是 MVC 框架、WebForm、Web Api 等等，對底下的商業邏輯層等等都不會有任何影響。</p>
<p>因此兩者是可以並存的不同層級下的不同拆分方式，並不能簡單地一概而論。</p>
<p>這個問題也可以參考以下文章，分享給大家：</p>
<ul>
<li><a href="https://shunnien.github.io/2017/07/29/3-tier-and-mvc-introduction/">三層結構與 Asp.Net MVC 的簡介 | ShunNien&rsquo;s Blog</a></li>
<li><a href="https://social.msdn.microsoft.com/Forums/expression/zh-TW/9b08c038-e365-449a-bd24-1a0771a525c2/3553121839webform33287mvc1997723652243352655027083303403526424565?forum=236">請問 WebForm 與 MVC 三層式架構的觀念問題 (microsoft.com)</a></li>
</ul>
<h4 id="service-可以依賴-service-嗎">Service 可以依賴 Service 嗎？</h4>
<p>可以。<del>既然人家都寫好了不用白不用</del></p>
<p>基本上來說在兩個 Service 之間就是物件和物件的關係，如果需要對方的公開方法，當然可以依賴對方。</p>
<p>不過為了避免循環參考，和同事經過了一些討論，還是有一些地方可以注意：</p>
<ul>
<li>如果只是純粹的流程控制，可以把工作還給流程控制的 Controller，讓該功能的 Controller 依序呼叫 Service 處理</li>
<li>如果是多個商業邏輯的整合，可以用一個高階的 Service 去整合負責較小職責的 Service，避免循環參考或則是依賴關係混亂</li>
</ul>
<p>另外在使用上也要注意呼叫對象是否有經過一些複雜的商業處理，如果那正是你要的，例如說你就是要訂單計算之後的結果，那當然沒有問題；倘若只是需要乾淨的資料，也可以乾脆往下去依賴 Repository 就可以，避免商業邏輯間意料之外的耦合。</p>
<p>所以請不要被從上到下這個方向束縛了，Service 也可以是厚厚的一層。</p>
<h2 id="小結">小結</h2>
<p>本篇記錄了為什麼要分層，以及我個人平常開新專案的分層步驟。最後總結一下幾個點：</p>
<ul>
<li>分層是為了分離關注點。讓每一層的職責明確、專注在各自的工作</li>
<li>分層帶來的好處：
<ul>
<li>修改時能更快鎖定目標、縮小範圍</li>
<li>適合多人合作，提升開發效率</li>
<li>增加程式碼的複用性</li>
<li>必要的時候可以抽換掉某一層</li>
</ul>
</li>
<li>分層的前提：
<ul>
<li>物件的設計要遵守 SOLID 原則</li>
<li>使用依賴注入來解除層與層之間的依賴</li>
<li>額外的開發成本</li>
</ul>
</li>
<li>常見的三層式架構：
<ul>
<li>展示層：負責和外部使用者互動</li>
<li>商業邏輯層：負責處理商業規則和相關的邏輯處理</li>
<li>資料存取層：負責存取資料的相關操作</li>
<li>共用層：負責擴充方法等不屬於任何一層的共用模組</li>
</ul>
</li>
<li>資料傳輸物件（DTO）
<ul>
<li>層與層之間需要資料的傳遞，因此我們會建立只有欄位沒有方法的 DTO 來傳輸資料</li>
<li>DTO 的轉換挺麻煩的，這時候就可以考慮使用 AutoMapper</li>
</ul>
</li>
<li>分層本身是分工的概念
<ul>
<li>要分成幾層、每一層負責什麼工作，這些都是需要決策的</li>
<li>綜上所述，請根據專案需求和團隊慣例作調整</li>
</ul>
</li>
</ul>
<p>大概這樣。</p>
<p>實作的部份也因為分層這個題目太廣了，其實有點不太知道要怎麼寫比較好，放置了一段時間。</p>
<p>最後決定就接續先前文章的進度，用平常習慣的方式調整一下來跑完一輪。當然內容還有許多地方是需要調整的，例如我們下一篇要加入的依賴注入，或是將方法改寫為非同步等等。內文的範例也延續了單純的 CRUD，並沒有完整展現商業邏輯分工出來的魅力，算是一些小遺憾。</p>
<p>後面的段落會補充一些我個人的心得，以及本篇的參考資料。如果有想要補充或討論的朋友，也歡迎分享您的看法，感謝感謝。</p>
<p>那麼，我們下篇再見囉～</p>
<h2 id="參考資料">參考資料</h2>
<ul>
<li><a href="https://kevintsengtw.blogspot.com/2012/10/aspnet-mvc-part1.html">mrkt 的程式學習筆記: ASP.NET MVC 專案分層架構 Part.1 初學者的起手式 (kevintsengtw.blogspot.com)</a></li>
<li><a href="https://raychiutw.github.io/2019/%E9%9A%A8%E6%89%8B-Design-Pattern-2-%E8%BB%9F%E9%AB%94%E5%88%86%E5%B1%A4%E8%A8%AD%E8%A8%88%E6%A8%A1%E5%BC%8F-Software-Layered-Architecture-Pattern/">隨手 Design Pattern (2) - 軟體分層設計模式</a></li>
<li><a href="https://blog.johnwu.cc/article/software-layered-architecture-pattern.html">軟體分層架構模式 | John Wu&rsquo;s Blog</a></li>
<li><a href="https://sunnyday0932.github.io/2020/%E4%B8%89%E5%B1%A4%E5%BC%8F%E6%9E%B6%E6%A7%8B/">三層式架構 (sunnyday0932.github.io)</a></li>
<li><a href="https://docs.microsoft.com/zh-tw/aspnet/web-forms/overview/data-access/introduction/creating-a-business-logic-layer-cs">建立商務邏輯層（C#） | Microsoft Docs</a></li>
<li><a href="https://shunnien.github.io/2017/07/29/3-tier-and-mvc-introduction/">三層結構與 Asp.Net MVC 的簡介 | ShunNien&rsquo;s Blog</a></li>
<li><a href="https://medium.com/@steph.c/%E4%B8%89%E5%B1%A4%E6%9E%B6%E6%A7%8B%E6%98%AF%E4%BB%80%E9%BA%BC-%E6%88%91%E5%8F%AA%E7%9F%A5%E9%81%93%E4%B8%89%E5%B1%A4%E8%82%89-efe542c38aaf">MVC 三層架構 是什麼? 我只知道三層肉. 三層架構 (3-Tier Architecture)是哪三層 ? | by Steph Dev 史帝夫和戴夫 | Medium</a></li>
<li><a href="https://ithelp.ithome.com.tw/articles/10227123">DDD 戰術設計：Domain Service - iT 邦幫忙</a></li>
<li><a href="https://kevintsengtw.blogspot.com/2013/07/aspnet-mvc.html">mrkt 的程式學習筆記: ASP.NET MVC 專案分層架構 - 建議與補充說明 (kevintsengtw.blogspot.com)</a></li>
</ul>
<h2 id="本系列文章">本系列文章</h2>
<ul>
<li><a href="/post/2021/04/newbie-0-menu">菜雞新訓記 (0): 目錄</a></li>
<li><a href="/post/2021/04/newbie-1-hello-git">菜雞新訓記 (1): Git 入門這樣做</a></li>
<li><a href="/post/2021/05/newbie-2-webapi">菜雞新訓記 (2): 使用 .net Core 來建立簡單的 Api 吧<br/>（上）認識 Api 與建置 Web Api 服務</a></li>
<li><a href="/post/2021/05/newbie-3-dapper">菜雞新訓記 (3): 使用 .net Core 來建立簡單的 Api 吧<br/>（下）使用 Dapper 連線到資料庫</a></li>
<li><a href="/post/2021/05/newbie-4-swagger">菜雞新訓記 (4): 使用 Swagger 來自動產生簡單好看可測試的 API 文件吧</a></li>
<li><a href="/post/2021/10/newbie-5-3-layer-architecture">菜雞新訓記 (5): 使用 三層式架構 來切分服務的關注點和職責吧</a></li>
</ul>
                        </div>

                        

<div class="post-archive">
    <h2>其他文章</h2>
    <ul class="listing">
        
        <li><a href="/post/2021/05/newbie-4-swagger/">菜雞新訓記 (4): 使用 Swagger 來自動產生簡單好看可測試的 API 文件吧</a></li>
        
        <li><a href="/post/2021/05/newbie-2-webapi/">菜雞新訓記 (2): 使用 .net Core 來建立簡單的 Api 吧（上）認識 Api 與建置 Web Api 服務</a></li>
        
        <li><a href="/post/2021/05/newbie-3-dapper/">菜雞新訓記 (3): 使用 .net Core 來建立簡單的 Api 吧（下）使用 Dapper 連線到資料庫</a></li>
        
        <li><a href="/post/2021/06/benchmarkdotnet/">C#: BenchmarkDotnet －－ 效能測試好簡單</a></li>
        
        <li><a href="/post/2021/04/newbie-0-menu/">菜雞新訓記 (0): 前言</a></li>
        
    </ul>
</div>


                        <div class="post-meta meta-tags">
                            
                            <ul class="clearfix">
                                
                                <li><a href="https://igouist.github.io/tags/newbieguide">NewbieGuide</a></li>
                                
                                <li><a href="https://igouist.github.io/tags/dotnet">dotnet</a></li>
                                
                                <li><a href="https://igouist.github.io/tags/csharp">csharp</a></li>
                                
                                <li><a href="https://igouist.github.io/tags/api">api</a></li>
                                
                            </ul>
                            
                        </div>
                        <hr />
<p>哈囉，如果你也有 LikeCoin，也覺得我的文章有幫上忙的話，還請不吝給我拍拍手呦，謝謝～ ;) </p>
<iframe class="LikeCoin" height="190" src="https://button.like.co/in/embed/igouist/button?referrer=https%3a%2f%2figouist.github.io%2fpost%2f2021%2f10%2fnewbie-5-3-layer-architecture%2f" width="100%" frameborder=0></iframe>
                    </article>
                    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "Igouist/Igouist.github.io"
            issue-term="pathname"
            theme="github-dark"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
                </div>
            </div>
            <div id="secondary">
    <section class="widget">
        <form id="search" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://igouist.github.io/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">系列文</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://igouist.github.io/series/%E6%88%91%E8%A6%81%E8%A8%82%E4%BE%BF%E7%95%B6/">我要訂便當 (5)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/series/%E8%8F%9C%E9%9B%9E%E6%96%B0%E8%A8%93%E8%A8%98/">菜雞新訓記 (6)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/series/%E8%8F%9C%E9%9B%9E%E8%88%87%E7%89%A9%E4%BB%B6%E5%B0%8E%E5%90%91/">菜雞與物件導向 (17)</a>
    </li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://igouist.github.io/post/2021/10/newbie-5-3-layer-architecture/" title="菜雞新訓記 (5): 使用 三層式架構 來切分服務的關注點和職責吧">菜雞新訓記 (5): 使用 三層式架構 來切分服務的關注點和職責吧</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/post/2021/08/set-default-value-with-model-when-fromuri/" title="菜雞抓蟲: 使用 FromUri 的複雜型別在有傳遞 QueryString 的情況下會先建立再賦值">菜雞抓蟲: 使用 FromUri 的複雜型別在有傳遞 QueryString 的情況下會先建立再賦值</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/post/2021/06/zero-width-space/" title="菜雞抓蟲: Url 變得怪怪的？你可能是零寬空格（ZWSP）的受害者！">菜雞抓蟲: Url 變得怪怪的？你可能是零寬空格（ZWSP）的受害者！</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/post/2021/06/benchmarkdotnet/" title="C#: BenchmarkDotnet －－ 效能測試好簡單">C#: BenchmarkDotnet －－ 效能測試好簡單</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/post/2021/05/newbie-4-swagger/" title="菜雞新訓記 (4): 使用 Swagger 來自動產生簡單好看可測試的 API 文件吧">菜雞新訓記 (4): 使用 Swagger 來自動產生簡單好看可測試的 API 文件吧</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/post/2021/05/newbie-3-dapper/" title="菜雞新訓記 (3): 使用 .net Core 來建立簡單的 Api 吧（下）使用 Dapper 連線到資料庫">菜雞新訓記 (3): 使用 .net Core 來建立簡單的 Api 吧（下）使用 Dapper 連線到資料庫</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/post/2021/05/newbie-2-webapi/" title="菜雞新訓記 (2): 使用 .net Core 來建立簡單的 Api 吧（上）認識 Api 與建置 Web Api 服務">菜雞新訓記 (2): 使用 .net Core 來建立簡單的 Api 吧（上）認識 Api 與建置 Web Api 服務</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/post/2021/05/visual-studio-split-window-in-one-file/" title="Visual Studio: 在同一個檔案分割視窗">Visual Studio: 在同一個檔案分割視窗</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/post/2021/04/newbie-1-hello-git/" title="菜雞新訓記 (1): 使用 Git 來進行版本控制吧">菜雞新訓記 (1): 使用 Git 來進行版本控制吧</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/post/2021/04/newbie-0-menu/" title="菜雞新訓記 (0): 前言">菜雞新訓記 (0): 前言</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">分類</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://igouist.github.io/categories/android/">android (1)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/categories/automation/">automation (3)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/categories/bug/">bug (2)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/categories/csharp-and-dotnet/">csharp-and-dotnet (20)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/categories/css/">css (1)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/categories/ide/">ide (3)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/categories/life/">life (1)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/categories/object-oriented/">object-oriented (17)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/categories/python/">python (7)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/categories/reading/">reading (3)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/categories/tools/">tools (14)</a>
    </li>
    
    <li>
        <a href="https://igouist.github.io/categories/w3hexschool/">w3hexschool (47)</a>
    </li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title">標籤</h3>
<div class="tagcloud">
    
    <a href="https://igouist.github.io/tags/android/">android</a>
    
    <a href="https://igouist.github.io/tags/api/">api</a>
    
    <a href="https://igouist.github.io/tags/automapper/">automapper</a>
    
    <a href="https://igouist.github.io/tags/automation/">automation</a>
    
    <a href="https://igouist.github.io/tags/bandon/">bandon</a>
    
    <a href="https://igouist.github.io/tags/benchmarkdotnet/">benchmarkdotnet</a>
    
    <a href="https://igouist.github.io/tags/bug/">bug</a>
    
    <a href="https://igouist.github.io/tags/chrome/">chrome</a>
    
    <a href="https://igouist.github.io/tags/crawler/">crawler</a>
    
    <a href="https://igouist.github.io/tags/csharp/">csharp</a>
    
    <a href="https://igouist.github.io/tags/css/">css</a>
    
    <a href="https://igouist.github.io/tags/dapper/">dapper</a>
    
    <a href="https://igouist.github.io/tags/database/">database</a>
    
    <a href="https://igouist.github.io/tags/dotnet/">dotnet</a>
    
    <a href="https://igouist.github.io/tags/electron/">electron</a>
    
    <a href="https://igouist.github.io/tags/entity-framework/">entity-framework</a>
    
    <a href="https://igouist.github.io/tags/enum/">enum</a>
    
    <a href="https://igouist.github.io/tags/excel/">excel</a>
    
    <a href="https://igouist.github.io/tags/game/">game</a>
    
    <a href="https://igouist.github.io/tags/git/">git</a>
    
    <a href="https://igouist.github.io/tags/heroku/">heroku</a>
    
    <a href="https://igouist.github.io/tags/ide/">ide</a>
    
    <a href="https://igouist.github.io/tags/life/">life</a>
    
    <a href="https://igouist.github.io/tags/linux/">linux</a>
    
    <a href="https://igouist.github.io/tags/mysql/">mysql</a>
    
    <a href="https://igouist.github.io/tags/newbieguide/">newbieguide</a>
    
    <a href="https://igouist.github.io/tags/object-oriented/">object-oriented</a>
    
    <a href="https://igouist.github.io/tags/php/">php</a>
    
    <a href="https://igouist.github.io/tags/powershell/">powershell</a>
    
    <a href="https://igouist.github.io/tags/ptt/">ptt</a>
    
    <a href="https://igouist.github.io/tags/python/">python</a>
    
    <a href="https://igouist.github.io/tags/reading/">reading</a>
    
    <a href="https://igouist.github.io/tags/selenium/">selenium</a>
    
    <a href="https://igouist.github.io/tags/sqlite/">sqlite</a>
    
    <a href="https://igouist.github.io/tags/swagger/">swagger</a>
    
    <a href="https://igouist.github.io/tags/tools/">tools</a>
    
    <a href="https://igouist.github.io/tags/visualstudio/">visualstudio</a>
    
    <a href="https://igouist.github.io/tags/w3hexschool/">w3hexschool</a>
    
    <a href="https://igouist.github.io/tags/xampp/">xampp</a>
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">蹭一下</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="https://sunnyday0932.github.io/" title="Sian">🌙 Sian</a>
        </li>
        
        <li>
            <a target="_blank" href="https://kevintsengtw.blogspot.com/" title="mrkt">mrkt 的程式學習筆記</a>
        </li>
        
        <li>
            <a target="_blank" href="https://raychiutw.github.io/" title="ray">Ray&#39;s Notes</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">小東西</h3>
        <ul class="widget-list">
            <li><a href="https://igouist.github.io/index.xml">RSS</a></li>
        </ul>
    </section>

    <section class="widget">
    <h3 class="widget-title">放個廣告加減賺</h3>
    <ul class="widget-list">
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        
        <ins class="adsbygoogle"
            style="display:block"
            data-ad-client="ca-pub-2119949858103459"
            data-ad-slot="9031038367"
            data-ad-format="auto"
            data-full-width-responsive="true"></ins>
        <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
    </ul>
</section>

</div>
        </div>
    </div>
</div>
<footer id="footer">
    <div class="container">
        &copy; 2019 <a href="https://igouist.github.io/">伊果的沒人看筆記本 By Igouist</a>.
        Powered by <a rel="nofollow noreferer noopener" href="https://gohugo.io" target="_blank">Hugo</a>.
        <a href="https://www.flysnow.org/" target="_blank">Theme</a> based on <a href="https://github.com/rujews/maupassant-hugo" target="_blank">maupassant</a>.
        
        
        
        <span id="busuanzi_container_site_pv"> PV： <span id="busuanzi_value_site_pv"></span></span>
        
    </div>
</footer>


    <script type="text/javascript">
    
    (function(){
        
    }())

    window.MathJax = {
        tex2jax: {
            inlineMath: [ ['$','$'] ],
            processEscapes: true
        }
    };
    </script>
    <script type="text/javascript" src="/js/prism.js" async="true"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src="/js/totop.js?v=0.0.0" async=""></script>



<script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>





<script type='text/javascript'>
    window.onload = function() {
      var links = document.links;
      for (var i = 0, linksLength = links.length; i < linksLength; i++) {
        if (links[i].hostname != window.location.hostname) {
          links[i].target = '_blank';
        }
      }
    }
  </script>
</body>
</html>
